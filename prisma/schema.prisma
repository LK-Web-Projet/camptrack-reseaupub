generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  ADMIN
  SUPERVISEUR_CAMPAGNE
  CONTROLEUR
  OPERATIONNEL
  EQUIPE
}

enum ClientType {
  EXTERNE
  INTERNE
}

enum TypeCampagne {
  MASSE
  PROXIMITE
}

enum CampagneStatus {
  PLANIFIEE
  EN_COURS
  TERMINEE
  ANNULEE
}

enum TypePanneau {
  PETIT
  GRAND
}

enum EtatMateriel {
  BON
  MOYEN
  MAUVAIS
}

enum TypeFichier {
  RAPPORT_JOURNALIER
  RAPPORT_FINAL
  PIGE
}

enum NotificationType {
  CAMPAIGN_EXPIRING
  ASSIGNMENT_WEEK_BEFORE
  ASSIGNMENT_2DAYS_BEFORE
}

enum TypePaiement {
  INSTALLATION
  DESINSTALLATION
  AUTRE
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model User {
  id_user               String         @id @default(cuid())
  nom                   String
  prenom                String
  nom_utilisateur       String?        @unique
  type_user             UserType
  email                 String         @unique
  password              String
  contact               String?
  is_active             Boolean        @default(true)
  created_at            DateTime       @default(now())
  updated_at            DateTime       @updatedAt
  campagnes             Campagne[]
  campagnes_supervisees Campagne[]     @relation("CampagneSuperviseur")
  notifications         Notification[]
  refreshTokens         RefreshToken[]
  revokedTokens         RevokedToken[]

  @@map("users")
}

model RefreshToken {
  id         String   @id @default(cuid())
  token_hash String
  userId     String
  expires_at DateTime
  revoked    Boolean  @default(false)
  created_at DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id_user])

  @@map("refresh_tokens")
}

model RevokedToken {
  id         String   @id @default(cuid())
  jti        String   @unique
  user_id    String
  expires_at DateTime
  revoked_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id_user])

  @@map("revoked_tokens")
}

model Client {
  id_client          String     @id @default(cuid())
  nom                String?
  prenom             String?
  entreprise         String
  domaine_entreprise String?
  adresse            String?
  contact            String?
  mail               String?    @unique
  type_client        ClientType
  created_at         DateTime   @default(now())
  updated_at         DateTime   @updatedAt
  commentaire        String?
  fonction_contact   String?
  campagnes          Campagne[]

  @@map("clients")
}

model Lieu {
  id_lieu    String     @id @default(cuid())
  nom        String
  ville      String
  created_at DateTime   @default(now())
  campagnes  Campagne[]

  @@map("lieux")
}

model Service {
  id_service   String        @id @default(cuid())
  nom          String
  description  String?
  created_at   DateTime      @default(now())
  campagnes    Campagne[]
  prestataires Prestataire[]

  @@map("services")
}

model Prestataire {
  id_prestataire  String                @id @default(cuid())
  id_service      String
  nom             String
  prenom          String
  contact         String
  disponible      Boolean               @default(true)
  type_panneau    TypePanneau?
  couleur         String?
  marque          String?
  modele          String?
  plaque          String?
  id_verification String?
  contrat_valide  Boolean?
  equipe_gps      Boolean?
  created_at      DateTime              @default(now())
  updated_at      DateTime              @updatedAt
  etat_vehicule   Int?
  score           Float?
  incidents       Incident[]
  dommages        MaterielsCase[]
  fichiers        PrestataireFichier[]
  photos          PrestatairePhoto[]
  service         Service               @relation(fields: [id_service], references: [id_service])
  affectations    PrestataireCampagne[]

  @@unique([id_service, id_verification])
  @@map("prestataires")
}

model PrestatairePhoto {
  id_photo       String      @id @default(cuid())
  id_prestataire String
  url            String
  description    String?
  created_at     DateTime    @default(now())
  prestataire    Prestataire @relation(fields: [id_prestataire], references: [id_prestataire], onDelete: Cascade)

  @@map("prestataire_photos")
}

model PrestataireFichier {
  id_fichier     String      @id @default(cuid())
  id_prestataire String
  url            String
  nom            String
  type           String?
  created_at     DateTime    @default(now())
  prestataire    Prestataire @relation(fields: [id_prestataire], references: [id_prestataire], onDelete: Cascade)

  @@map("prestataire_fichiers")
}

model Campagne {
  id_campagne      String                @id @default(cuid())
  id_client        String
  id_lieu          String
  id_gestionnaire  String
  id_service       String
  nom_campagne     String
  description      String?
  objectif         String?
  quantite_service Int?
  nbr_prestataire  Int?
  type_campagne    TypeCampagne?
  date_debut       DateTime
  date_fin         DateTime
  date_creation    DateTime              @default(now())
  status           CampagneStatus        @default(PLANIFIEE)
  updated_at       DateTime              @updatedAt
  id_superviseur   String?
  client           Client                @relation(fields: [id_client], references: [id_client])
  gestionnaire     User                  @relation(fields: [id_gestionnaire], references: [id_user])
  lieu             Lieu                  @relation(fields: [id_lieu], references: [id_lieu])
  service          Service               @relation(fields: [id_service], references: [id_service])
  superviseur      User?                 @relation("CampagneSuperviseur", fields: [id_superviseur], references: [id_user])
  fichiers         FichierCampagne[]
  dommages         MaterielsCase[]
  affectations     PrestataireCampagne[]

  @@map("campagnes")
}

model PrestataireCampagne {
  id_campagne          String
  id_prestataire       String
  date_creation        DateTime              @default(now())
  date_fin             DateTime?
  status               String?
  image_affiche        String?
  date_desinstallation DateTime?
  paiement             PaiementPrestataire[]
  campagne             Campagne              @relation(fields: [id_campagne], references: [id_campagne])
  prestataire          Prestataire           @relation(fields: [id_prestataire], references: [id_prestataire])

  @@id([id_campagne, id_prestataire])
  @@map("prestataires_campagne")
}

model PaiementPrestataire {
  id_paiement      String              @id @default(cuid())
  id_campagne      String
  id_prestataire   String
  paiement_base    Float
  paiement_final   Float
  date_paiement    DateTime?
  statut_paiement  Boolean             @default(false)
  sanction_montant Float               @default(0)
  created_at       DateTime            @default(now())
  type             TypePaiement        @default(INSTALLATION)
  affectation      PrestataireCampagne @relation(fields: [id_campagne, id_prestataire], references: [id_campagne, id_prestataire])

  @@index([id_campagne, id_prestataire])
  @@map("paiements_prestataire")
}

model MaterielsCase {
  id_materiels_case  String       @id @default(cuid())
  id_campagne        String?
  id_prestataire     String?
  nom_materiel       String
  etat               EtatMateriel
  description        String
  montant_penalite   Float
  penalite_appliquer Boolean      @default(false)
  photo_url          String?
  date_creation      DateTime     @default(now())
  preuve_media       String?
  campagne           Campagne?    @relation(fields: [id_campagne], references: [id_campagne])
  prestataire        Prestataire? @relation(fields: [id_prestataire], references: [id_prestataire])

  @@map("materiels_case")
}

model FichierCampagne {
  id_fichier       String      @id @default(cuid())
  id_campagne      String
  nom_fichier      String
  description      String?
  lien_canva_drive String
  type_fichier     TypeFichier
  date_creation    DateTime    @default(now())
  campagne         Campagne    @relation(fields: [id_campagne], references: [id_campagne])

  @@map("fichiers_campagne")
}

model AuditLog {
  id         String   @id @default(cuid())
  user_id    String
  action     String
  ressource  String
  details    Json?
  ip_address String?
  timestamp  DateTime @default(now())

  @@map("audit_logs")
}

model TypeIncident {
  id_type_incident String     @id @default(cuid())
  nom              String     @unique
  description      String?
  created_at       DateTime   @default(now())
  incidents        Incident[]

  @@map("types_incident")
}

model Incident {
  id_incident      String          @id @default(cuid())
  id_prestataire   String
  id_type_incident String
  date_incident    DateTime
  commentaire      String
  created_at       DateTime        @default(now())
  photos           IncidentPhoto[]
  prestataire      Prestataire     @relation(fields: [id_prestataire], references: [id_prestataire], onDelete: Cascade)
  type_incident    TypeIncident    @relation(fields: [id_type_incident], references: [id_type_incident])

  @@map("incidents")
}

model IncidentPhoto {
  id_photo    String   @id @default(cuid())
  id_incident String
  url         String
  created_at  DateTime @default(now())
  incident    Incident @relation(fields: [id_incident], references: [id_incident], onDelete: Cascade)

  @@map("incident_photos")
}

model Notification {
  id_notification String               @id @default(cuid())
  type            NotificationType
  priority        NotificationPriority @default(MEDIUM)
  user_id         String
  entity_type     String
  entity_id       String
  title           String
  message         String
  action_url      String?
  metadata        Json?
  is_read         Boolean              @default(false)
  read_at         DateTime?
  created_at      DateTime             @default(now())
  expires_at      DateTime?
  user            User                 @relation(fields: [user_id], references: [id_user], onDelete: Cascade)

  @@index([user_id, is_read])
  @@index([user_id, created_at])
  @@index([entity_type, entity_id])
  @@map("notifications")
}

model NotificationRule {
  id_rule          String               @id @default(cuid())
  type             NotificationType     @unique
  days_before      Int
  priority         NotificationPriority @default(MEDIUM)
  is_active        Boolean              @default(true)
  title_template   String
  message_template String
  description      String?
  created_at       DateTime             @default(now())
  updated_at       DateTime             @updatedAt

  @@map("notification_rules")
}