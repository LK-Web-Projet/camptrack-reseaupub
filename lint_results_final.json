[{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(auth)\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\dashboard\\admin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\dashboard\\campagnes\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\dashboard\\campagnes\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\dashboard\\clients\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\dashboard\\clients\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\dashboard\\lieux\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\dashboard\\profil\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\dashboard\\services\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\dashboard\\users\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\paiements\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\parametres\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\prestataires\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\(dashboard)\\prestataires\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\admin\\export\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\auth\\login\\route.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is assigned a value but never used.","line":86,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":86,"endColumn":24,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\auth\\logout\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1319,1322],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1319,1322],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":56,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1740,1743],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1740,1743],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2130,2133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2130,2133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":109,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3354,3357],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3354,3357],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { comparePassword } from \"@/lib/auth/hash\";\r\nimport { verifyAccessToken, verifyRefreshToken } from \"@/lib/auth/jwt\";\r\nimport { handleApiError } from \"@/lib/utils/errorHandler\";\r\n\r\nfunction parseCookies(cookieHeader: string | null): Record<string, string> {\r\n  const cookies: Record<string, string> = {};\r\n\r\n  if (!cookieHeader) return cookies;\r\n\r\n  cookieHeader.split(\";\").forEach((cookie) => {\r\n    const [key, value] = cookie.trim().split(\"=\");\r\n    if (key) {\r\n      try {\r\n        cookies[key] = value ? decodeURIComponent(value) : \"\";\r\n      } catch {\r\n        cookies[key] = value || \"\";\r\n      }\r\n    }\r\n  });\r\n\r\n  return cookies;\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json().catch(() => ({}));\r\n    const cookies = parseCookies(req.headers.get(\"cookie\"));\r\n\r\n    const refreshToken = body?.refreshToken || cookies[\"refreshToken\"];\r\n    const accessToken =\r\n      req.headers.get(\"authorization\")?.replace(/^Bearer\\s+/i, \"\") ||\r\n      cookies[\"accessToken\"];\r\n\r\n    let userId: string | undefined;\r\n    let revokedTokens = 0;\r\n\r\n    // 1. RÉVOQUER LE ACCESS TOKEN via son jti\r\n    if (accessToken) {\r\n      try {\r\n        const payload = verifyAccessToken(accessToken) as any;\r\n        userId = payload.userId;\r\n\r\n        // Ajouter le jti à la blacklist\r\n        if (payload.jti) {\r\n          await prisma.revokedToken.create({\r\n            data: {\r\n              jti: payload.jti,\r\n              user_id: userId,\r\n              expires_at: new Date(payload.exp * 1000), // Date d'expiration du JWT\r\n            },\r\n          });\r\n          revokedTokens++;\r\n        }\r\n      } catch (error: any) {\r\n        // Si le token est expiré, on ne peut pas le révoquer (c'est déjà fait)\r\n        if (error.message !== \"ACCESS_TOKEN_EXPIRED\") {\r\n          console.log(\"Erreur lors de la révocation du access token:\", error);\r\n        }\r\n      }\r\n    }\r\n\r\n    // 2. RÉVOQUER LE REFRESH TOKEN\r\n    if (refreshToken) {\r\n      try {\r\n        const payload = verifyRefreshToken(refreshToken) as any;\r\n\r\n        // Ajouter le jti du refresh token à la blacklist\r\n        if (payload.jti) {\r\n          await prisma.revokedToken.create({\r\n            data: {\r\n              jti: payload.jti,\r\n              user_id: payload.userId,\r\n              expires_at: new Date(payload.exp * 1000),\r\n            },\r\n          });\r\n          revokedTokens++;\r\n        }\r\n\r\n        // S'assurer d'avoir l'userId pour l'audit\r\n        if (!userId) {\r\n          userId = payload.userId;\r\n        }\r\n\r\n        // Révoquer aussi le refresh token dans la table refreshTokens\r\n        const tokenRecords = await prisma.refreshToken.findMany({\r\n          where: {\r\n            userId: payload.userId,\r\n            revoked: false,\r\n            expires_at: { gt: new Date() },\r\n          },\r\n        });\r\n\r\n        for (const record of tokenRecords) {\r\n          const isMatch = await comparePassword(\r\n            refreshToken,\r\n            record.token_hash\r\n          );\r\n          if (isMatch) {\r\n            await prisma.refreshToken.update({\r\n              where: { id: record.id },\r\n              data: { revoked: true },\r\n            });\r\n            revokedTokens++;\r\n            break;\r\n          }\r\n        }\r\n      } catch (error: any) {\r\n        if (error.message !== \"REFRESH_TOKEN_EXPIRED\") {\r\n          console.log(\"Erreur lors de la révocation du refresh token:\", error);\r\n        }\r\n      }\r\n    }\r\n\r\n    // 3. JOURNALISATION\r\n    if (userId) {\r\n      await prisma.auditLog.create({\r\n        data: {\r\n          user_id: userId,\r\n          action: \"LOGOUT\",\r\n          ressource: \"AUTH\",\r\n          details: {\r\n            tokens_revoked: revokedTokens,\r\n            timestamp: new Date().toISOString(),\r\n          },\r\n          ip_address:\r\n            req.headers.get(\"x-forwarded-for\") ||\r\n            req.headers.get(\"x-real-ip\") ||\r\n            \"unknown\",\r\n        },\r\n      });\r\n    }\r\n\r\n    const response = NextResponse.json({\r\n      success: true,\r\n      message: \"Déconnexion réussie\",\r\n      tokens_revoked: revokedTokens,\r\n    });\r\n\r\n    // 4. SUPPRIMER LES COOKIES\r\n    const cookieOptions = {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === \"production\",\r\n      sameSite: \"strict\" as const,\r\n      maxAge: 0,\r\n      path: \"/\",\r\n    };\r\n\r\n    response.cookies.set(\"refreshToken\", \"\", cookieOptions);\r\n    response.cookies.set(\"accessToken\", \"\", cookieOptions);\r\n\r\n    return response;\r\n  } catch (error) {\r\n    console.error(\"Erreur lors de la déconnexion:\", error);\r\n    return handleApiError(error);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\auth\\refresh\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1061,1064],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1061,1064],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { signAccessToken, signRefreshToken, verifyRefreshToken } from \"@/lib/auth/jwt\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { hashPassword, comparePassword } from \"@/lib/auth/hash\";\r\nimport { handleApiError, AppError } from \"@/lib/utils/errorHandler\";\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json().catch(() => ({}));\r\n    let refreshToken = body?.refreshToken;\r\n\r\n    // Vérifier aussi dans les cookies\r\n    if (!refreshToken) {\r\n      const cookies = req.headers.get(\"cookie\") || \"\";\r\n      const refreshTokenCookie = cookies\r\n        .split(\";\")\r\n        .find(c => c.trim().startsWith(\"refreshToken=\"));\r\n      \r\n      if (refreshTokenCookie) {\r\n        refreshToken = refreshTokenCookie.split(\"=\")[1];\r\n      }\r\n    }\r\n\r\n    if (!refreshToken) {\r\n      throw new AppError(\"Refresh token manquant\", 400);\r\n    }\r\n\r\n    // Vérification JWT du refresh token\r\n    let payload;\r\n    try {\r\n      payload = verifyRefreshToken(refreshToken);\r\n    } catch (error: any) {\r\n      if (error.message === \"REFRESH_TOKEN_EXPIRED\") {\r\n        throw new AppError(\"Refresh token expiré\", 401);\r\n      }\r\n      throw new AppError(\"Refresh token invalide\", 401);\r\n    }\r\n\r\n    // Vérifier en base de données\r\n    const tokenRecords = await prisma.refreshToken.findMany({\r\n      where: {\r\n        userId: payload.userId,\r\n        revoked: false,\r\n        expires_at: {\r\n          gt: new Date()\r\n        }\r\n      }\r\n    });\r\n\r\n    let tokenValid = false;\r\n    for (const record of tokenRecords) {\r\n      const isMatch = await comparePassword(refreshToken, record.token_hash);\r\n      if (isMatch) {\r\n        tokenValid = true;\r\n        \r\n        // Révoquer l'ancien token\r\n        await prisma.refreshToken.update({\r\n          where: { id: record.id },\r\n          data: { revoked: true }\r\n        });\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (!tokenValid) {\r\n      throw new AppError(\"Refresh token révoqué ou invalide\", 401);\r\n    }\r\n\r\n    // Vérifier l'utilisateur\r\n    const user = await prisma.user.findFirst({\r\n      where: {\r\n        id_user: payload.userId,\r\n        is_active: true\r\n      },\r\n      select: {\r\n        id_user: true,\r\n        email: true,\r\n        type_user: true,\r\n        nom: true,\r\n        prenom: true\r\n      }\r\n    });\r\n\r\n    if (!user) {\r\n      throw new AppError(\"Utilisateur introuvable ou inactif\", 401);\r\n    }\r\n\r\n    // Générer de nouveaux tokens\r\n    const newTokenPayload = {\r\n      userId: user.id_user,\r\n      email: user.email,\r\n      role: user.type_user\r\n    };\r\n\r\n    const newAccessToken = signAccessToken(newTokenPayload);\r\n    const newRefreshToken = signRefreshToken(newTokenPayload);\r\n\r\n    // Stocker le nouveau refresh token\r\n    const hashedNewRefresh = await hashPassword(newRefreshToken);\r\n    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);\r\n\r\n    await prisma.refreshToken.create({\r\n      data: {\r\n        token_hash: hashedNewRefresh,\r\n        userId: user.id_user,\r\n        expires_at: expiresAt,\r\n        revoked: false\r\n      }\r\n    });\r\n\r\n    const response = NextResponse.json({\r\n      success: true,\r\n      accessToken: newAccessToken,\r\n      refreshToken: newRefreshToken\r\n    });\r\n\r\n    // Mettre à jour les cookies\r\n    const cookieOptions = {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === \"production\",\r\n      sameSite: \"strict\" as const,\r\n      maxAge: 7 * 24 * 60 * 60,\r\n      path: \"/\"\r\n    };\r\n\r\n    response.cookies.set(\"refreshToken\", newRefreshToken, cookieOptions);\r\n    response.cookies.set(\"accessToken\", newAccessToken, {\r\n      ...cookieOptions,\r\n      maxAge: 15 * 60\r\n    });\r\n\r\n    return response;\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\campagnes\\[id]\\fichiers\\[fichierId]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\campagnes\\[id]\\fichiers\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1015,1018],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1015,1018],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { requireAdmin } from \"@/lib/middleware/authMiddleware\";\r\nimport { handleApiError, AppError } from \"@/lib/utils/errorHandler\";\r\n\r\n// GET /api/campagnes/[id]/fichiers - Lister les fichiers d'une campagne\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> } \r\n) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    const { id } = await params; \r\n    const campagneId = id;\r\n\r\n    // Vérifier que la campagne existe\r\n    const campagne = await prisma.campagne.findUnique({\r\n      where: { id_campagne: campagneId },\r\n      select: { id_campagne: true, nom_campagne: true }\r\n    });\r\n\r\n    if (!campagne) {\r\n      throw new AppError(\"Campagne non trouvée\", 404);\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const typeFichier = searchParams.get('type');\r\n\r\n    const where: any = { id_campagne: campagneId };\r\n    if (typeFichier) {\r\n      where.type_fichier = typeFichier;\r\n    }\r\n\r\n    const fichiers = await prisma.fichierCampagne.findMany({\r\n      where,\r\n      select: {\r\n        id_fichier: true,\r\n        nom_fichier: true,\r\n        description: true,\r\n        type_fichier: true,\r\n        lien_canva_drive: true,\r\n        date_creation: true\r\n      },\r\n      orderBy: { date_creation: 'desc' }\r\n    });\r\n\r\n    return NextResponse.json({\r\n      campagne: {\r\n        id_campagne: campagne.id_campagne,\r\n        nom_campagne: campagne.nom_campagne\r\n      },\r\n      fichiers\r\n    });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}\r\n\r\n// POST /api/campagnes/[id]/fichiers - Ajouter un fichier à une campagne\r\nexport async function POST(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> } \r\n) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    const { id } = await params; \r\n    const campagneId = id;\r\n\r\n    const body = await request.json();\r\n    \r\n    const { nom_fichier, description, lien_canva_drive, type_fichier } = body;\r\n\r\n    if (!nom_fichier || !lien_canva_drive || !type_fichier) {\r\n      throw new AppError(\"Nom, lien et type de fichier sont requis\", 400);\r\n    }\r\n\r\n    // Vérifier que la campagne existe\r\n    const campagne = await prisma.campagne.findUnique({\r\n      where: { id_campagne: campagneId }\r\n    });\r\n\r\n    if (!campagne) {\r\n      throw new AppError(\"Campagne non trouvée\", 404);\r\n    }\r\n\r\n    // Vérifier que le type de fichier est valide\r\n    const typesValides = ['RAPPORT_JOURNALIER', 'RAPPORT_FINAL', 'PIGE'];\r\n    if (!typesValides.includes(type_fichier)) {\r\n      throw new AppError(\"Type de fichier invalide\", 400);\r\n    }\r\n\r\n    const fichier = await prisma.fichierCampagne.create({\r\n      data: {\r\n        id_campagne: campagneId,\r\n        nom_fichier,\r\n        description: description || null,\r\n        lien_canva_drive,\r\n        type_fichier\r\n      },\r\n      select: {\r\n        id_fichier: true,\r\n        nom_fichier: true,\r\n        description: true,\r\n        type_fichier: true,\r\n        lien_canva_drive: true,\r\n        date_creation: true\r\n      }\r\n    });\r\n\r\n    return NextResponse.json({ \r\n      message: \"Fichier ajouté à la campagne avec succès\",\r\n      fichier \r\n    }, { status: 201 });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\campagnes\\[id]\\materiels-cases\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\campagnes\\[id]\\prestataires\\[prestataireId]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":121,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3560,3563],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3560,3563],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { requireAdmin } from \"@/lib/middleware/authMiddleware\";\r\nimport { handleApiError, AppError } from \"@/lib/utils/errorHandler\";\r\n\r\n// DELETE /api/campagnes/[id]/prestataires/[prestataireId] - Retirer un prestataire\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string; prestataireId: string }> }\r\n) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    const { id, prestataireId } = await params;\r\n\r\n    // Vérifier que l'affectation existe\r\n    const affectation = await prisma.prestataireCampagne.findUnique({\r\n      where: {\r\n        id_campagne_id_prestataire: {\r\n          id_campagne: id,\r\n          id_prestataire: prestataireId\r\n        }\r\n      },\r\n      include: {\r\n        paiement: true,\r\n        prestataire: {\r\n          include: {\r\n            dommages: {\r\n              where: {\r\n                id_campagne: id,\r\n                penalite_appliquer: false\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!affectation) {\r\n      throw new AppError(\"Cette affectation n'existe pas\", 404);\r\n    }\r\n\r\n    // Vérifier si le prestataire est déjà retiré\r\n    if (affectation.date_fin !== null) {\r\n      throw new AppError(\"Ce prestataire a déjà été retiré de cette campagne\", 400);\r\n    }\r\n\r\n    // Vérifier s'il y a un paiement finalisé associé\r\n    if (affectation.paiement && affectation.paiement.statut_paiement) {\r\n      throw new AppError(\r\n        \"Impossible de retirer ce prestataire car son paiement a déjà été finalisé\",\r\n        400\r\n      );\r\n    }\r\n\r\n    // Vérifier s'il y a des dommages non résolus\r\n    if (affectation.prestataire.dommages && affectation.prestataire.dommages.length > 0) {\r\n      const dommagesNonResolus = affectation.prestataire.dommages.filter(\r\n        d => !d.penalite_appliquer\r\n      );\r\n\r\n      if (dommagesNonResolus.length > 0) {\r\n        throw new AppError(\r\n          \"Impossible de retirer ce prestataire car des dommages non résolus sont associés à cette campagne\",\r\n          400\r\n        );\r\n      }\r\n    }\r\n\r\n\r\n    await prisma.prestataireCampagne.update({\r\n      where: {\r\n        id_campagne_id_prestataire: {\r\n          id_campagne: id,\r\n          id_prestataire: prestataireId\r\n        }\r\n      },\r\n      data: {\r\n        date_fin: new Date(),\r\n        status: \"TERMINE\"\r\n      }\r\n    });\r\n\r\n    return NextResponse.json({\r\n      message: \"Prestataire retiré de la campagne avec succès\"\r\n    });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}\r\n\r\n// PUT /api/campagnes/[id]/prestataires/[prestataireId] - Mettre à jour une affectation de prestataire\r\nexport async function PUT(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string; prestataireId: string }> }\r\n) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    const { id, prestataireId } = await params;\r\n    const body = await request.json();\r\n\r\n    // Vérifier que l'affectation existe\r\n    const affectation = await prisma.prestataireCampagne.findUnique({\r\n      where: {\r\n        id_campagne_id_prestataire: {\r\n          id_campagne: id,\r\n          id_prestataire: prestataireId\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!affectation) {\r\n      throw new AppError(\"Cette affectation n'existe pas\", 404);\r\n    }\r\n\r\n    // Vérifier les champs à mettre à jour\r\n    const updateData: any = {};\r\n\r\n    if (body.status !== undefined) {\r\n      // Valider les statuts possibles\r\n      const statutsValides = [\"ACTIF\", \"INACTIF\", \"TERMINE\", \"ANNULE\"];\r\n      if (!statutsValides.includes(body.status)) {\r\n        throw new AppError(`Statut invalide. Statuts valides: ${statutsValides.join(\", \")}`, 400);\r\n      }\r\n      updateData.status = body.status;\r\n\r\n      // Si on termine l'affectation, mettre la date de fin\r\n      if (body.status === \"TERMINE\" || body.status === \"ANNULE\") {\r\n        updateData.date_fin = new Date();\r\n      }\r\n    }\r\n\r\n    if (body.image_affiche !== undefined) {\r\n      updateData.image_affiche = body.image_affiche;\r\n    }\r\n\r\n    //  S'assurer qu'au moins un champ est fourni\r\n    if (Object.keys(updateData).length === 0) {\r\n      throw new AppError(\"Aucune donnée à mettre à jour fournie\", 400);\r\n    }\r\n\r\n    // Mettre à jour l'affectation\r\n    const updatedAffectation = await prisma.prestataireCampagne.update({\r\n      where: {\r\n        id_campagne_id_prestataire: {\r\n          id_campagne: id,\r\n          id_prestataire: prestataireId\r\n        }\r\n      },\r\n      data: updateData,\r\n      include: {\r\n        prestataire: {\r\n          select: {\r\n            id_prestataire: true,\r\n            nom: true,\r\n            prenom: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    return NextResponse.json({\r\n      message: \"Affectation mise à jour avec succès\",\r\n      affectation: updatedAffectation\r\n    });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\campagnes\\[id]\\prestataires\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\campagnes\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\campagnes\\[id]\\status\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\campagnes\\[id]\\superviseur\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\campagnes\\cron\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\campagnes\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1633,1636],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1633,1636],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { requireAdmin } from \"@/lib/middleware/authMiddleware\";\r\nimport { campagneCreateSchema, validateData } from \"@/lib/validation/campagneSchemas\";\r\nimport { handleApiError, AppError } from \"@/lib/utils/errorHandler\";\r\nimport { autoTerminateCampaigns, autoTerminationCache } from \"@/lib/utils/campaignAutoTermination\";\r\nimport { UserType } from \"@prisma/client\";\r\n\r\n// GET /api/campagnes - Lister toutes les campagnes\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    // ========================================================================\r\n    // AUTO-TERMINATION : Clôturer les campagnes expirées (avec cache)\r\n    // ========================================================================\r\n    // Exécuter uniquement si le cache a expiré (toutes les 5 minutes)\r\n    if (autoTerminationCache.shouldExecute()) {\r\n      await autoTerminateCampaigns(prisma);\r\n      autoTerminationCache.markExecuted();\r\n    }\r\n    // ========================================================================\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const page = parseInt(searchParams.get('page') || '1');\r\n    const limit = parseInt(searchParams.get('limit') || '50');\r\n    const skip = (page - 1) * limit;\r\n    const status = searchParams.get('status');\r\n    const clientId = searchParams.get('clientId');\r\n    const lieuId = searchParams.get('lieuId');\r\n\r\n    // Construction du filtre\r\n    const where: any = {};\r\n    if (status) where.status = status;\r\n    if (clientId) where.id_client = clientId;\r\n    if (lieuId) where.id_lieu = lieuId;\r\n\r\n    const total = await prisma.campagne.count({ where });\r\n\r\n    const campagnes = await prisma.campagne.findMany({\r\n      where,\r\n      select: {\r\n        id_campagne: true,\r\n        nom_campagne: true,\r\n        description: true,\r\n        objectif: true,\r\n        quantite_service: true,\r\n        nbr_prestataire: true,\r\n        type_campagne: true,\r\n        date_debut: true,\r\n        date_fin: true,\r\n        status: true,\r\n        date_creation: true,\r\n        client: {\r\n          select: {\r\n            id_client: true,\r\n            nom: true,\r\n            prenom: true,\r\n            entreprise: true\r\n          }\r\n        },\r\n        lieu: {\r\n          select: {\r\n            id_lieu: true,\r\n            nom: true,\r\n            ville: true\r\n          }\r\n        },\r\n        service: {\r\n          select: {\r\n            id_service: true,\r\n            nom: true\r\n          }\r\n        },\r\n        gestionnaire: {\r\n          select: {\r\n            nom: true,\r\n            prenom: true,\r\n            email: true\r\n          }\r\n        },\r\n        superviseur: {\r\n          select: {\r\n            nom: true,\r\n            prenom: true,\r\n            email: true\r\n          }\r\n        },\r\n        _count: {\r\n          select: {\r\n            affectations: true,\r\n            fichiers: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: { date_debut: 'desc' },\r\n      skip,\r\n      take: limit\r\n    });\r\n\r\n    return NextResponse.json({\r\n      campagnes,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        total,\r\n        totalPages: Math.ceil(total / limit)\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}\r\n\r\n// POST /api/campagnes - Créer une nouvelle campagne\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    const body = await request.json();\r\n\r\n    const validation = validateData(campagneCreateSchema, body);\r\n    if (!validation.success) {\r\n      throw new AppError(validation.error, 400);\r\n    }\r\n\r\n    const {\r\n      id_client,\r\n      id_lieu,\r\n      id_service,\r\n      nom_campagne,\r\n      description,\r\n      objectif,\r\n      quantite_service,\r\n      nbr_prestataire,\r\n      type_campagne,\r\n      date_debut,\r\n      date_fin,\r\n      id_superviseur\r\n    } = validation.data;\r\n\r\n    // Vérifier que le client existe\r\n    const client = await prisma.client.findUnique({\r\n      where: { id_client }\r\n    });\r\n    if (!client) {\r\n      throw new AppError(\"Client non trouvé\", 404);\r\n    }\r\n\r\n    // Vérifier que le lieu existe\r\n    const lieu = await prisma.lieu.findUnique({\r\n      where: { id_lieu }\r\n    });\r\n    if (!lieu) {\r\n      throw new AppError(\"Lieu non trouvé\", 404);\r\n    }\r\n\r\n    // Vérifier que le service existe\r\n    const service = await prisma.service.findUnique({\r\n      where: { id_service: id_service }\r\n    });\r\n    if (!service) {\r\n      throw new AppError(\"Service non trouvé\", 404);\r\n    }\r\n\r\n    // Vérifier le superviseur si fourni\r\n    if (id_superviseur) {\r\n      const superviseur = await prisma.user.findUnique({\r\n        where: { id_user: id_superviseur }\r\n      });\r\n\r\n      if (!superviseur) {\r\n        throw new AppError(\"Superviseur non trouvé\", 404);\r\n      }\r\n\r\n      if (superviseur.type_user !== UserType.SUPERVISEUR_CAMPAGNE) {\r\n        throw new AppError(\"L'utilisateur spécifié n'est pas un superviseur\", 400);\r\n      }\r\n    }\r\n\r\n    // Créer la campagne\r\n    const campagne = await prisma.campagne.create({\r\n      data: {\r\n        id_client,\r\n        id_lieu,\r\n        id_service,\r\n        id_gestionnaire: authCheck.user.id_user,\r\n        id_superviseur: id_superviseur || null,\r\n        nom_campagne,\r\n        description: description || null,\r\n        objectif: objectif || null,\r\n        quantite_service: quantite_service || null,\r\n        nbr_prestataire: nbr_prestataire || null,\r\n        type_campagne: type_campagne || null,\r\n        date_debut: new Date(date_debut),\r\n        date_fin: new Date(date_fin)\r\n      },\r\n      select: {\r\n        id_campagne: true,\r\n        nom_campagne: true,\r\n        description: true,\r\n        objectif: true,\r\n        quantite_service: true,\r\n        nbr_prestataire: true,\r\n        type_campagne: true,\r\n        date_debut: true,\r\n        date_fin: true,\r\n        status: true,\r\n        date_creation: true,\r\n        client: {\r\n          select: {\r\n            nom: true,\r\n            prenom: true,\r\n            entreprise: true\r\n          }\r\n        },\r\n        lieu: {\r\n          select: {\r\n            nom: true,\r\n            ville: true\r\n          }\r\n        },\r\n        superviseur: {\r\n          select: {\r\n            nom: true,\r\n            prenom: true,\r\n            email: true\r\n          }\r\n        },\r\n        service: {\r\n          select: {\r\n            nom: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    return NextResponse.json({\r\n      message: \"Campagne créée avec succès\",\r\n      campagne\r\n    }, { status: 201 });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\campagnes\\statistiques\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1016,1019],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1016,1019],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { requireAdmin } from \"@/lib/middleware/authMiddleware\";\r\nimport { handleApiError } from \"@/lib/utils/errorHandler\";\r\n\r\n/**\r\n * GET /api/campagnes/statistiques\r\n * Obtenir les statistiques globales des campagnes\r\n * \r\n * Query params optionnels:\r\n * - clientId: Filtrer par client\r\n * - lieuId: Filtrer par lieu\r\n * - dateDebut: Date de début (ISO string)\r\n * - dateFin: Date de fin (ISO string)\r\n */\r\nexport async function GET(request: NextRequest) {\r\n    try {\r\n        const authCheck = await requireAdmin(request);\r\n        if (!authCheck.ok) return authCheck.response;\r\n\r\n        const { searchParams } = new URL(request.url);\r\n        const clientId = searchParams.get('clientId');\r\n        const lieuId = searchParams.get('lieuId');\r\n        const dateDebut = searchParams.get('dateDebut');\r\n        const dateFin = searchParams.get('dateFin');\r\n\r\n        // Construction du filtre\r\n        const where: any = {};\r\n        if (clientId) where.id_client = clientId;\r\n        if (lieuId) where.id_lieu = lieuId;\r\n        if (dateDebut || dateFin) {\r\n            where.date_debut = {};\r\n            if (dateDebut) where.date_debut.gte = new Date(dateDebut);\r\n            if (dateFin) where.date_debut.lte = new Date(dateFin);\r\n        }\r\n\r\n        // Agrégation par status et type en parallèle\r\n        const [\r\n            campagnesParStatus,\r\n            campagnesParType,\r\n            totalCampagnes\r\n        ] = await prisma.$transaction([\r\n            // Grouper par status\r\n            prisma.campagne.groupBy({\r\n                by: ['status'],\r\n                where,\r\n                _count: {\r\n                    id_campagne: true\r\n                }\r\n            }),\r\n            // Grouper par type\r\n            prisma.campagne.groupBy({\r\n                by: ['type_campagne'],\r\n                where,\r\n                _count: {\r\n                    id_campagne: true\r\n                }\r\n            }),\r\n            // Compter le total\r\n            prisma.campagne.count({ where })\r\n        ]);\r\n\r\n        // Formatage des statistiques pour le frontend\r\n        const statistiques = {\r\n            total: totalCampagnes,\r\n            parStatus: {\r\n                PLANIFIEE: 0,\r\n                EN_COURS: 0,\r\n                TERMINEE: 0,\r\n                ANNULEE: 0\r\n            },\r\n            parType: {\r\n                MASSE: 0,\r\n                PROXIMITE: 0,\r\n                NON_SPECIFIE: 0\r\n            }\r\n        };\r\n\r\n        // Remplir les statistiques par status\r\n        campagnesParStatus.forEach(stat => {\r\n            statistiques.parStatus[stat.status] = stat._count.id_campagne;\r\n        });\r\n\r\n        // Remplir les statistiques par type\r\n        campagnesParType.forEach(stat => {\r\n            if (stat.type_campagne) {\r\n                statistiques.parType[stat.type_campagne] = stat._count.id_campagne;\r\n            } else {\r\n                statistiques.parType.NON_SPECIFIE = stat._count.id_campagne;\r\n            }\r\n        });\r\n\r\n        return NextResponse.json(statistiques, {\r\n            headers: {\r\n                // Cache public pendant 5 minutes, stale-while-revalidate pendant 10 minutes\r\n                'Cache-Control': 'public, s-maxage=300, stale-while-revalidate=600'\r\n            }\r\n        });\r\n\r\n    } catch (error) {\r\n        return handleApiError(error);\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\campagnes\\upload\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\clients\\[id]\\campagnes\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":33,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1120,1123],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1120,1123],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { requireAdmin } from \"@/lib/middleware/authMiddleware\";\r\nimport { handleApiError, AppError } from \"@/lib/utils/errorHandler\";\r\n\r\n// GET /api/clients/[id]/campagnes - Lister les campagnes d'un client\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> } \r\n) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    const { id } = await params; \r\n    const clientId = id;\r\n\r\n    const client = await prisma.client.findUnique({\r\n      where: { id_client: clientId },\r\n      select: { id_client: true, nom: true, prenom: true }\r\n    });\r\n\r\n    if (!client) {\r\n      throw new AppError(\"Client non trouvé\", 404);\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const page = parseInt(searchParams.get('page') || '1');\r\n    const limit = parseInt(searchParams.get('limit') || '50');\r\n    const skip = (page - 1) * limit;\r\n    const status = searchParams.get('status');\r\n\r\n    const where: any = { id_client: clientId };\r\n    if (status) {\r\n      where.status = status;\r\n    }\r\n\r\n    const total = await prisma.campagne.count({ where });\r\n\r\n    const campagnes = await prisma.campagne.findMany({\r\n      where,\r\n      select: {\r\n        id_campagne: true,\r\n        nom_campagne: true,\r\n        description: true,\r\n        objectif: true,\r\n        type_campagne: true,\r\n        date_debut: true,\r\n        date_fin: true,\r\n        status: true,\r\n        date_creation: true,\r\n        lieu: {\r\n          select: {\r\n            nom: true,\r\n            ville: true\r\n          }\r\n        },\r\n        service: {\r\n          select: {\r\n            nom: true\r\n          }\r\n        },\r\n        _count: {\r\n          select: {\r\n            affectations: true,\r\n            fichiers: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: { date_debut: 'desc' },\r\n      skip,\r\n      take: limit\r\n    });\r\n\r\n    return NextResponse.json({\r\n      client: {\r\n        id_client: client.id_client,\r\n        nom: client.nom,\r\n        prenom: client.prenom\r\n      },\r\n      campagnes,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        total,\r\n        totalPages: Math.ceil(total / limit)\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\clients\\[id]\\campagnes\\statistiques\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1412,1415],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1412,1415],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { requireAdmin } from \"@/lib/middleware/authMiddleware\";\r\nimport { handleApiError, AppError } from \"@/lib/utils/errorHandler\";\r\n\r\n/**\r\n * GET /api/clients/[id]/campagnes/statistiques\r\n * Obtenir les statistiques des campagnes pour un client spécifique\r\n * \r\n * Query params optionnels:\r\n * - dateDebut: Date de début (ISO string)\r\n * - dateFin: Date de fin (ISO string)\r\n */\r\nexport async function GET(\r\n    request: NextRequest,\r\n    { params }: { params: Promise<{ id: string }> }\r\n) {\r\n    try {\r\n        const authCheck = await requireAdmin(request);\r\n        if (!authCheck.ok) return authCheck.response;\r\n\r\n        const { id: clientId } = await params;\r\n        const { searchParams } = new URL(request.url);\r\n        const dateDebut = searchParams.get('dateDebut');\r\n        const dateFin = searchParams.get('dateFin');\r\n\r\n        // Vérifier que le client existe\r\n        const client = await prisma.client.findUnique({\r\n            where: { id_client: clientId },\r\n            select: {\r\n                id_client: true,\r\n                nom: true,\r\n                prenom: true,\r\n                entreprise: true\r\n            }\r\n        });\r\n\r\n        if (!client) {\r\n            throw new AppError(\"Client non trouvé\", 404);\r\n        }\r\n\r\n        // Construction du filtre\r\n        const where: any = { id_client: clientId };\r\n        if (dateDebut || dateFin) {\r\n            where.date_debut = {};\r\n            if (dateDebut) where.date_debut.gte = new Date(dateDebut);\r\n            if (dateFin) where.date_debut.lte = new Date(dateFin);\r\n        }\r\n\r\n        // Agrégation des statistiques\r\n        const [\r\n            campagnesParStatus,\r\n            campagnesParType,\r\n            totalCampagnes,\r\n            campagnesActives,\r\n            totalPrestataires\r\n        ] = await prisma.$transaction([\r\n            // Grouper par status\r\n            prisma.campagne.groupBy({\r\n                by: ['status'],\r\n                where,\r\n                _count: {\r\n                    id_campagne: true\r\n                }\r\n            }),\r\n            // Grouper par type\r\n            prisma.campagne.groupBy({\r\n                by: ['type_campagne'],\r\n                where,\r\n                _count: {\r\n                    id_campagne: true\r\n                }\r\n            }),\r\n            // Total des campagnes\r\n            prisma.campagne.count({ where }),\r\n            // Campagnes actives (EN_COURS)\r\n            prisma.campagne.count({\r\n                where: {\r\n                    ...where,\r\n                    status: 'EN_COURS'\r\n                }\r\n            }),\r\n            // Total des affectations de prestataires\r\n            prisma.prestataireCampagne.count({\r\n                where: {\r\n                    campagne: {\r\n                        id_client: clientId\r\n                    }\r\n                }\r\n            })\r\n        ]);\r\n\r\n        // Formatage des statistiques\r\n        const statistiques = {\r\n            client: {\r\n                id: client.id_client,\r\n                nom: client.nom,\r\n                prenom: client.prenom,\r\n                entreprise: client.entreprise\r\n            },\r\n            campagnes: {\r\n                total: totalCampagnes,\r\n                actives: campagnesActives,\r\n                parStatus: {\r\n                    PLANIFIEE: 0,\r\n                    EN_COURS: 0,\r\n                    TERMINEE: 0,\r\n                    ANNULEE: 0\r\n                },\r\n                parType: {\r\n                    MASSE: 0,\r\n                    PROXIMITE: 0,\r\n                    NON_SPECIFIE: 0\r\n                }\r\n            },\r\n            prestataires: {\r\n                totalAffectations: totalPrestataires\r\n            }\r\n        };\r\n\r\n        // Remplir les statistiques par status\r\n        campagnesParStatus.forEach(stat => {\r\n            statistiques.campagnes.parStatus[stat.status] = stat._count.id_campagne;\r\n        });\r\n\r\n        // Remplir les statistiques par type\r\n        campagnesParType.forEach(stat => {\r\n            if (stat.type_campagne) {\r\n                statistiques.campagnes.parType[stat.type_campagne] = stat._count.id_campagne;\r\n            } else {\r\n                statistiques.campagnes.parType.NON_SPECIFIE = stat._count.id_campagne;\r\n            }\r\n        });\r\n\r\n        return NextResponse.json(statistiques, {\r\n            headers: {\r\n                // Cache public pendant 5 minutes, stale-while-revalidate pendant 10 minutes\r\n                'Cache-Control': 'public, s-maxage=300, stale-while-revalidate=600'\r\n            }\r\n        });\r\n\r\n    } catch (error) {\r\n        return handleApiError(error);\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\clients\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\clients\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\cron\\cleanup\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_error' is defined but never used.","line":12,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { cleanupExpiredTokens } from \"@/lib/auth/tokenCleanup\";\r\n\r\nexport async function GET() {\r\n  try {\r\n    const result = await cleanupExpiredTokens();\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: \"Nettoyage terminé\",\r\n      result\r\n    });\r\n  } catch (_error) {\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: \"Échec du nettoyage\"\r\n    }, { status: 500 });\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\docs\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\docs\\ui\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":3,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  const html = `\r\n<!DOCTYPE html>\r\n<html>\r\n  <head>\r\n    <title>CampTrack API Documentation</title>\r\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui.css\" />\r\n    <style>\r\n      body { margin: 0; padding: 20px; background: #f5f5f5; }\r\n      #swagger-ui { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\r\n    </style>\r\n  </head>\r\n  <body>\r\n    <div id=\"swagger-ui\"></div>\r\n    <script src=\"https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui-bundle.js\"></script>\r\n    <script>\r\n      SwaggerUIBundle({\r\n        url: '/api/docs',\r\n        dom_id: '#swagger-ui',\r\n        presets: [\r\n          SwaggerUIBundle.presets.apis,\r\n          SwaggerUIBundle.SwaggerUIStandalonePreset\r\n        ],\r\n        layout: \"BaseLayout\",\r\n        deepLinking: true,\r\n        showExtensions: true,\r\n        showCommonExtensions: true\r\n      });\r\n    </script>\r\n  </body>\r\n</html>\r\n  `;\r\n\r\n  return new NextResponse(html, {\r\n    headers: {\r\n      'Content-Type': 'text/html',\r\n    },\r\n  });\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\incidents\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\incidents\\upload\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\lieux\\[id]\\campagnes\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":33,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1099,1102],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1099,1102],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { requireAdmin } from \"@/lib/middleware/authMiddleware\";\r\nimport { handleApiError, AppError } from \"@/lib/utils/errorHandler\";\r\n\r\n// GET /api/lieux/[id]/campagnes - Lister les campagnes d'un lieu\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> } \r\n) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    const { id } = await params; \r\n    const lieuId = id;\r\n\r\n    const lieu = await prisma.lieu.findUnique({\r\n      where: { id_lieu: lieuId },\r\n      select: { id_lieu: true, nom: true, ville: true }\r\n    });\r\n\r\n    if (!lieu) {\r\n      throw new AppError(\"Lieu non trouvé\", 404);\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const page = parseInt(searchParams.get('page') || '1');\r\n    const limit = parseInt(searchParams.get('limit') || '50');\r\n    const skip = (page - 1) * limit;\r\n    const status = searchParams.get('status');\r\n\r\n    const where: any = { id_lieu: lieuId };\r\n    if (status) {\r\n      where.status = status;\r\n    }\r\n\r\n    const total = await prisma.campagne.count({ where });\r\n\r\n    const campagnes = await prisma.campagne.findMany({\r\n      where,\r\n      select: {\r\n        id_campagne: true,\r\n        nom_campagne: true,\r\n        description: true,\r\n        objectif: true,\r\n        type_campagne: true,\r\n        date_debut: true,\r\n        date_fin: true,\r\n        status: true,\r\n        date_creation: true,\r\n        client: {\r\n          select: {\r\n            nom: true,\r\n            prenom: true,\r\n            entreprise: true\r\n          }\r\n        },\r\n        service: {\r\n          select: {\r\n            nom: true\r\n          }\r\n        },\r\n        _count: {\r\n          select: {\r\n            affectations: true,\r\n            fichiers: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: { date_debut: 'desc' },\r\n      skip,\r\n      take: limit\r\n    });\r\n\r\n    return NextResponse.json({\r\n      lieu: {\r\n        id_lieu: lieu.id_lieu,\r\n        nom: lieu.nom,\r\n        ville: lieu.ville\r\n      },\r\n      campagnes,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        total,\r\n        totalPages: Math.ceil(total / limit)\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\lieux\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\lieux\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\materiels-cases\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\materiels-cases\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\materiels-cases\\upload\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\materiels\\inspection\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\notifications\\[id]\\read\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\notifications\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\notifications\\count\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\notifications\\generate\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\notifications\\read-all\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\notifications\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\paiements\\[id_campagne]\\[id_prestataire]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\paiements\\calculer\\[id_campagne]\\[id_prestataire]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\paiements\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\prestataires\\[id]\\files\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\prestataires\\[id]\\materiels-cases\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\prestataires\\[id]\\photos\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\prestataires\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Prisma' is defined but never used.","line":6,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { requireAdmin } from \"@/lib/middleware/authMiddleware\";\r\nimport { prestataireUpdateSchema, validateData } from \"@/lib/validation/prestataireSchemas\";\r\nimport { handleApiError, AppError } from \"@/lib/utils/errorHandler\";\r\nimport { Prisma, TypePanneau } from \"@prisma/client\";\r\n\r\ninterface PrestataireUpdateInput {\r\n  id_service?: string;\r\n  nom?: string;\r\n  prenom?: string;\r\n  contact?: string;\r\n  disponible?: boolean;\r\n  type_panneau?: TypePanneau | null;\r\n  couleur?: string | null;\r\n  marque?: string | null;\r\n  modele?: string | null;\r\n  plaque?: string | null;\r\n  id_verification?: string | null;\r\n  contrat_valide?: boolean | null;\r\n  equipe_gps?: boolean | null;\r\n}\r\n\r\n// GET /api/prestataires/[id] - Détails d'un prestataire\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    const { id } = await params;\r\n    const prestataireId = id;\r\n\r\n    const prestataire = await prisma.prestataire.findUnique({\r\n      where: { id_prestataire: prestataireId },\r\n      select: {\r\n        id_prestataire: true,\r\n        nom: true,\r\n        prenom: true,\r\n        contact: true,\r\n        disponible: true,\r\n        // CHAMPS VÉHICULE INTÉGRÉS\r\n        type_panneau: true,\r\n        couleur: true,\r\n        marque: true,\r\n        modele: true,\r\n        plaque: true,\r\n        id_verification: true,\r\n        created_at: true,\r\n        updated_at: true,\r\n        // @ts-expect-error -- Known Prisma issue with relation typing\r\n        photos: true,\r\n        fichiers: true,\r\n        service: {\r\n          select: {\r\n            id_service: true,\r\n            nom: true,\r\n            description: true\r\n          }\r\n        },\r\n        affectations: {\r\n          select: {\r\n            campagne: {\r\n              select: {\r\n                id_campagne: true,\r\n                nom_campagne: true,\r\n                date_debut: true,\r\n                date_fin: true,\r\n                status: true\r\n              }\r\n            },\r\n            date_creation: true,\r\n            status: true\r\n          },\r\n          orderBy: { date_creation: 'desc' }\r\n        },\r\n        dommages: {\r\n          select: {\r\n            id_materiels_case: true,\r\n            etat: true,\r\n            description: true,\r\n            montant_penalite: true,\r\n            penalite_appliquer: true,\r\n            date_creation: true,\r\n            campagne: {\r\n              select: {\r\n                nom_campagne: true\r\n              }\r\n            }\r\n          },\r\n          orderBy: { date_creation: 'desc' }\r\n        },\r\n        _count: {\r\n          select: {\r\n            affectations: true,\r\n            dommages: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!prestataire) {\r\n      throw new AppError(\"Prestataire non trouvé\", 404);\r\n    }\r\n\r\n    return NextResponse.json({ prestataire });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}\r\n\r\n// PUT /api/prestataires/[id] - Modifier un prestataire\r\nexport async function PUT(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    const { id } = await params;\r\n    const prestataireId = id;\r\n\r\n    const body = await request.json();\r\n\r\n    const validation = validateData<PrestataireUpdateInput>(prestataireUpdateSchema, body);\r\n    if (!validation.success) {\r\n      throw new AppError(validation.error, 400);\r\n    }\r\n\r\n    const data = validation.data;\r\n\r\n    const existingPrestataire = await prisma.prestataire.findUnique({\r\n      where: { id_prestataire: prestataireId }\r\n    });\r\n\r\n    if (!existingPrestataire) {\r\n      throw new AppError(\"Prestataire non trouvé\", 404);\r\n    }\r\n\r\n    // Vérifier le service si modification\r\n    if (data.id_service) {\r\n      const service = await prisma.service.findUnique({\r\n        where: { id_service: data.id_service }\r\n      });\r\n      if (!service) {\r\n        throw new AppError(\"Service non trouvé\", 404);\r\n      }\r\n    }\r\n\r\n    // Vérifier l'unicité de la plaque si modifiée\r\n    if (data.plaque && data.plaque !== existingPrestataire.plaque) {\r\n      const plaqueExistante = await prisma.prestataire.findFirst({\r\n        where: {\r\n          plaque: data.plaque,\r\n          id_prestataire: { not: prestataireId }\r\n        }\r\n      });\r\n      if (plaqueExistante) {\r\n        throw new AppError(\"Un autre prestataire avec cette plaque existe déjà\", 409);\r\n      }\r\n    }\r\n\r\n    const updatedPrestataire = await prisma.prestataire.update({\r\n      where: { id_prestataire: prestataireId },\r\n      data: {\r\n        ...(data.nom && { nom: data.nom }),\r\n        ...(data.prenom && { prenom: data.prenom }),\r\n        ...(data.contact && { contact: data.contact }),\r\n        ...(data.disponible !== undefined && { disponible: data.disponible }),\r\n        ...(data.id_service && { service: { connect: { id_service: data.id_service } } }),\r\n        ...(data.type_panneau && { type_panneau: data.type_panneau }),\r\n        ...(data.couleur && { couleur: data.couleur }),\r\n        ...(data.marque && { marque: data.marque }),\r\n        ...(data.modele && { modele: data.modele }),\r\n        ...(data.plaque && { plaque: data.plaque }),\r\n        ...(data.id_verification && { id_verification: data.id_verification }),\r\n        ...(data.contrat_valide !== undefined && { contrat_valide: data.contrat_valide }),\r\n        ...(data.equipe_gps !== undefined && { equipe_gps: data.equipe_gps }),\r\n        // Gestion des photos (suppression et ajout)\r\n        ...((body.deletedPhotoIds || body.addedPhotos) && {\r\n          photos: {\r\n            ...(body.deletedPhotoIds && { deleteMany: { id_photo: { in: body.deletedPhotoIds } } }),\r\n            ...(body.addedPhotos && { create: body.addedPhotos.map((url: string) => ({ url })) })\r\n          }\r\n        }),\r\n        // Gestion des fichiers (suppression et ajout)\r\n        ...((body.deletedFileIds || body.addedFiles) && {\r\n          fichiers: {\r\n            ...(body.deletedFileIds && { deleteMany: { id_fichier: { in: body.deletedFileIds } } }),\r\n            ...(body.addedFiles && {\r\n              create: body.addedFiles.map((file: { url: string, nom: string, type: string }) => ({\r\n                url: file.url,\r\n                nom: file.nom,\r\n                type: file.type\r\n              }))\r\n            })\r\n          }\r\n        })\r\n      },\r\n      select: {\r\n        id_prestataire: true,\r\n        nom: true,\r\n        prenom: true,\r\n        contact: true,\r\n        disponible: true,\r\n        type_panneau: true,\r\n        couleur: true,\r\n        marque: true,\r\n        modele: true,\r\n        plaque: true,\r\n        id_verification: true,\r\n        created_at: true,\r\n        updated_at: true,\r\n        service: {\r\n          select: {\r\n            nom: true\r\n          }\r\n        },\r\n        // @ts-expect-error -- Known Prisma issue with relation typing\r\n        photos: true // Retourner les photos mises à jour\r\n      }\r\n    });\r\n\r\n    return NextResponse.json({\r\n      message: \"Prestataire modifié avec succès\",\r\n      prestataire: updatedPrestataire\r\n    });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}\r\n\r\n// DELETE /api/prestataires/[id] - Supprimer un prestataire\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    const { id } = await params;\r\n    const prestataireId = id;\r\n\r\n    const existingPrestataire = await prisma.prestataire.findUnique({\r\n      where: { id_prestataire: prestataireId }\r\n    });\r\n\r\n    if (!existingPrestataire) {\r\n      throw new AppError(\"Prestataire non trouvé\", 404);\r\n    }\r\n\r\n    // Vérifier si le prestataire a des affectations en cours\r\n    const affectationsEnCours = await prisma.prestataireCampagne.count({\r\n      where: {\r\n        id_prestataire: prestataireId,\r\n        date_fin: null // Affectations non terminées\r\n      }\r\n    });\r\n\r\n    if (affectationsEnCours > 0) {\r\n      throw new AppError(\r\n        \"Impossible de supprimer ce prestataire car il a des affectations en cours\",\r\n        400\r\n      );\r\n    }\r\n\r\n    await prisma.prestataire.delete({\r\n      where: { id_prestataire: prestataireId }\r\n    });\r\n\r\n    return NextResponse.json({\r\n      message: \"Prestataire supprimé avec succès\"\r\n    });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\prestataires\\[id]\\statut\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'raison' is assigned a value but never used.","line":18,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { requireAdmin } from \"@/lib/middleware/authMiddleware\";\r\nimport { handleApiError, AppError } from \"@/lib/utils/errorHandler\";\r\n\r\nexport async function PUT(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> } \r\n) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    const { id } = await params;\r\n    const prestataireId = id;\r\n\r\n    const body = await request.json();\r\n    const { disponible, raison } = body; \r\n\r\n    if (typeof disponible !== 'boolean') {\r\n      throw new AppError(\"Le champ 'disponible' doit être un booléen\", 400);\r\n    }\r\n\r\n    const existingPrestataire = await prisma.prestataire.findUnique({\r\n      where: { id_prestataire: prestataireId }\r\n    });\r\n\r\n    if (!existingPrestataire) {\r\n      throw new AppError(\"Prestataire non trouvé\", 404);\r\n    }\r\n\r\n    const updatedPrestataire = await prisma.prestataire.update({\r\n      where: { id_prestataire: prestataireId },\r\n      data: { \r\n        disponible,\r\n      },\r\n      select: {\r\n        id_prestataire: true,\r\n        nom: true,\r\n        prenom: true,\r\n        disponible: true,\r\n        updated_at: true,\r\n        type_panneau: true,\r\n        plaque: true\r\n      }\r\n    });\r\n\r\n    return NextResponse.json({\r\n      message: `Prestataire ${disponible ? 'activé' : 'désactivé'} avec succès`,\r\n      prestataire: updatedPrestataire\r\n    });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\prestataires\\cron\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\prestataires\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\prestataires\\upload\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\rapports\\campagne\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\rapports\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\services\\[id]\\prestataires\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1232,1235],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1232,1235],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { requireAdmin } from \"@/lib/middleware/authMiddleware\";\r\nimport { handleApiError, AppError } from \"@/lib/utils/errorHandler\";\r\n\r\n// GET /api/services/[id]/prestataires - Lister les prestataires d'un service\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> } \r\n) {\r\n  try {\r\n    const authCheck = await requireAdmin(request);\r\n    if (!authCheck.ok) return authCheck.response;\r\n\r\n    const { id } = await params; \r\n    const serviceId = id;\r\n\r\n    // Vérifier que le service existe\r\n    const service = await prisma.service.findUnique({\r\n      where: { id_service: serviceId },\r\n      select: { id_service: true, nom: true }\r\n    });\r\n\r\n    if (!service) {\r\n      throw new AppError(\"Service non trouvé\", 404);\r\n    }\r\n\r\n    // Récupérer les query params\r\n    const { searchParams } = new URL(request.url);\r\n    const page = parseInt(searchParams.get('page') || '1');\r\n    const limit = parseInt(searchParams.get('limit') || '50');\r\n    const skip = (page - 1) * limit;\r\n    const disponible = searchParams.get('disponible');\r\n\r\n    // Construire le where\r\n    const where: any = { id_service: serviceId };\r\n    if (disponible !== null) {\r\n      where.disponible = disponible === 'true';\r\n    }\r\n\r\n    // Compter le total\r\n    const total = await prisma.prestataire.count({ where });\r\n\r\n    // Récupérer les prestataires AVEC un TRI\r\n    const prestataires = await prisma.prestataire.findMany({\r\n      where,\r\n      select: {\r\n        id_prestataire: true,\r\n        nom: true,\r\n        prenom: true,\r\n        contact: true,\r\n        disponible: true,\r\n        created_at: true,\r\n        type_panneau: true,\r\n        marque: true,\r\n        modele: true,\r\n        couleur: true,\r\n        plaque: true,\r\n        _count: {\r\n          select: {\r\n            affectations: {\r\n              where: {\r\n                date_fin: null \r\n              }\r\n            }\r\n          }\r\n        }\r\n      },\r\n      // ORDRE : Disponibles d'abord, puis par ancienneté (plus anciens en premier)\r\n      orderBy: [\r\n        { disponible: 'desc' }, // Les disponibles (true) viennent en premier\r\n        { created_at: 'asc' }   // Ensuite tri par date de création (anciens d'abord)\r\n      ],\r\n      skip,\r\n      take: limit\r\n    });\r\n\r\n    return NextResponse.json({\r\n      service: {\r\n        id_service: service.id_service,\r\n        nom: service.nom\r\n      },\r\n      prestataires,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        total,\r\n        totalPages: Math.ceil(total / limit)\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    return handleApiError(error);\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\services\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\services\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\statistiques\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\types-incidents\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\users\\[id]\\password\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\users\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\api\\users\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\context\\AuthContext.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'usePathname' is defined but never used.","line":4,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { createContext, useContext, useState, ReactNode, useEffect, useCallback } from \"react\"\r\nimport { useRouter, usePathname } from \"next/navigation\"\r\n\r\ntype User = {\r\n  id_user: string\r\n  nom: string\r\n  prenom: string\r\n  nom_utilisateur: string\r\n  type_user: string\r\n  email: string\r\n  contact: string\r\n  created_at?: string\r\n  updated_at?: string\r\n  is_active?: boolean\r\n}\r\n\r\ntype AuthContextType = {\r\n  user: User | null\r\n  isLoading: boolean\r\n  login: (email: string, password: string) => Promise<boolean>\r\n  logout: () => Promise<void>\r\n  checkSession: () => Promise<string | null> // Modified to return token or null\r\n  apiClient: (url: string, options?: RequestInit) => Promise<Response> // Added apiClient\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined)\r\n\r\nexport function AuthProvider({ children }: { children: ReactNode }) {\r\n  const [user, setUser] = useState<User | null>(null)\r\n  const [token, setToken] = useState<string | null>(null)\r\n  const [isLoading, setIsLoading] = useState(true)\r\n  const router = useRouter()\r\n  // const pathname = usePathname()\r\n\r\n  // Fonction pour vérifier la session (Silent Refresh)\r\n  const checkSession = useCallback(async (): Promise<string | null> => {\r\n    try {\r\n      const res = await fetch(\"/api/auth/refresh\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        // Pas de body nécessaire, le cookie est envoyé automatiquement\r\n      });\r\n\r\n      if (res.ok) {\r\n        const data = await res.json();\r\n        // On stocke le token en mémoire pour les appels API\r\n        setToken(data.accessToken);\r\n\r\n        // On décode le token pour avoir les infos user minimales\r\n        const payload = JSON.parse(atob(data.accessToken.split('.')[1]));\r\n\r\n        setUser({\r\n          id_user: payload.userId,\r\n          email: payload.email,\r\n          type_user: payload.role,\r\n          nom: \"\", // Manquant dans le token\r\n          prenom: \"\", // Manquant dans le token\r\n          nom_utilisateur: \"\",\r\n          contact: \"\"\r\n        });\r\n        return data.accessToken; // Return the new token\r\n      } else {\r\n        setUser(null);\r\n        setToken(null);\r\n        return null;\r\n      }\r\n    } catch {\r\n      setUser(null);\r\n      setToken(null);\r\n      return null;\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, []);\r\n\r\n  // Initialisation : Tenter de restaurer la session au chargement\r\n  useEffect(() => {\r\n    checkSession();\r\n  }, [checkSession]);\r\n\r\n  const login = async (email: string, password: string): Promise<boolean> => {\r\n    try {\r\n      const res = await fetch(\"/api/auth/login\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ email, password }),\r\n      })\r\n\r\n      if (!res.ok) {\r\n        return false\r\n      }\r\n\r\n      const data = await res.json()\r\n      // L'endpoint login renvoie { success, user, accessToken, refreshToken }\r\n      setUser(data.user)\r\n      setToken(data.accessToken)\r\n\r\n      // Redirection\r\n      if (data.user.type_user === \"ADMIN\") {\r\n        router.push(\"/dashboard/admin\")\r\n      } else {\r\n        router.push(\"/\") // Ou dashboard standard\r\n      }\r\n      return true\r\n    } catch {\r\n      return false\r\n    }\r\n  }\r\n\r\n  const logout = useCallback(async () => {\r\n    try {\r\n      await fetch(\"/api/auth/logout\", { method: \"POST\" })\r\n    } catch (e) {\r\n      console.error(\"Logout error\", e)\r\n    } finally {\r\n      setUser(null)\r\n      setToken(null)\r\n      router.push(\"/\")\r\n    }\r\n  }, [router])\r\n\r\n  // Client API qui injecte le token et gère le refresh automatique\r\n  const apiClient = useCallback(async (url: string, options: RequestInit = {}) => {\r\n    const currentToken = token;\r\n\r\n    const headers = new Headers(options.headers || {});\r\n    if (currentToken) {\r\n      headers.set(\"Authorization\", `Bearer ${currentToken}`);\r\n    }\r\n\r\n    let response = await fetch(url, { ...options, headers });\r\n\r\n    // Si 401 Unauthorized, on tente un refresh\r\n    if (response.status === 401) {\r\n      const newToken = await checkSession(); // checkSession now returns the new token or null\r\n      if (newToken) {\r\n        // Retry avec le nouveau token\r\n        headers.set(\"Authorization\", `Bearer ${newToken}`);\r\n        response = await fetch(url, { ...options, headers });\r\n      } else {\r\n        // Refresh raté -> Logout\r\n        logout();\r\n        throw new Error(\"Session expirée ou rafraîchissement impossible.\");\r\n      }\r\n    }\r\n\r\n    return response;\r\n  }, [token, logout, checkSession]);\r\n\r\n  return (\r\n    <AuthContext.Provider value={{ user, isLoading, login, logout, checkSession, apiClient }}>\r\n      {children}\r\n    </AuthContext.Provider>\r\n  )\r\n}\r\n\r\nexport function useAuth() {\r\n  const context = useContext(AuthContext)\r\n  if (!context) throw new Error(\"useAuth must be used within an AuthProvider\")\r\n  return context\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\context\\ThemeContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\dashboard\\dashboard\\admin\\types-incident\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\layout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'inter' is assigned a value but never used.","line":9,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import \"./globals.css\";\r\nimport { Inter } from \"next/font/google\";\r\nimport { Suspense } from \"react\";\r\nimport { ThemeProvider } from \"./context/ThemeContext\";\r\nimport { AuthProvider } from \"./context/AuthContext\";\r\nimport ToastProvider from \"@/components/providers/ToastProvider\";\r\nimport { GlobalLinkLoader } from \"@/components/ui/GlobalLinkLoader\";\r\n\r\nconst inter = Inter({ subsets: [\"latin\"], variable: \"--font-inter\" });\r\n\r\nexport default function RootLayout({ children }: { children: React.ReactNode }) {\r\n  return (\r\n    <html lang=\"fr\">\r\n      <body className=\"antialiased bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100\">\r\n        <ThemeProvider>\r\n          <AuthProvider>\r\n            <ToastProvider />\r\n            <Suspense fallback={null}>\r\n              <GlobalLinkLoader />\r\n            </Suspense>\r\n            {children}\r\n          </AuthProvider>\r\n        </ThemeProvider>\r\n      </body>\r\n    </html >\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\app\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'router' is assigned a value but never used.","line":16,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":16,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\nimport { useState, useEffect } from \"react\"\r\nimport { useFormik } from \"formik\"\r\nimport * as Yup from \"yup\"\r\nimport { useRouter, useSearchParams } from \"next/navigation\"\r\nimport { useAuth } from \"@/app/context/AuthContext\"\r\nimport { ThemeToggleButton } from \"@/components/common/ThemeToggleButton\"\r\nimport { Logo } from \"@/components/ui/logo\"\r\nimport { Eye, EyeOff } from \"lucide-react\"\r\nimport { toast, ToastContainer } from \"react-toastify\"\r\nimport \"react-toastify/dist/ReactToastify.css\"\r\n\r\nexport default function LoginPage() {\r\n  const [showPassword, setShowPassword] = useState(false)\r\n  const { login } = useAuth()\r\n  const router = useRouter()\r\n  const [isLoading, setIsLoading] = useState(false)\r\n  const searchParams = useSearchParams()\r\n\r\n  // ✅ Afficher un toast si redirection avec authError=true\r\n  useEffect(() => {\r\n    if (searchParams.get(\"authError\")) {\r\n      toast.error(\"Session expirée. Veuillez vous reconnecter.\");\r\n    }\r\n  }, [searchParams])\r\n\r\n  const formik = useFormik<{ email: string; password: string }>({\r\n    initialValues: {\r\n      email: \"\",\r\n      password: \"\",\r\n    },\r\n    validationSchema: Yup.object({\r\n      email: Yup.string()\r\n        .email(\"Adresse email invalide\")\r\n        .required(\"L’email est obligatoire\"),\r\n      password: Yup.string()\r\n        .min(6, \"Le mot de passe doit contenir au moins 6 caractères\")\r\n        .required(\"Le mot de passe est obligatoire\"),\r\n    }),\r\n    onSubmit: async (values) => {\r\n      setIsLoading(true)\r\n      try {\r\n        const success = await login(values.email, values.password)\r\n        if (success) {\r\n          toast.success(\"Connexion réussie.Bienvenue sur CampTrack !\")\r\n        } else {\r\n          toast.error(\"Identifiants incorrects\")\r\n        }\r\n      } catch {\r\n        toast.error(\"Erreur lors de la connexion\")\r\n      } finally {\r\n        setIsLoading(false)\r\n      }\r\n    },\r\n\r\n  })\r\n\r\n  return (\r\n    <div className=\"flex min-h-screen\">\r\n      <ToastContainer />\r\n      {/* Partie gauche : présentation */}\r\n      <div className=\"hidden md:flex flex-1 w-1/2 flex-col justify-center items-center bg-black text-white p-12\">\r\n        <Logo />\r\n        <h1 className=\"text-3xl font-bold mb-4\">Bienvenue sur CampTrack</h1>\r\n        <p className=\"text-lg max-w-sm font-semibold\">\r\n          La plateforme intelligente pour la <strong>gestion des campagnes tricycles</strong> de\r\n          Réseau Pub. Connectez-vous pour accéder à votre espace.\r\n        </p>\r\n      </div>\r\n\r\n      {/* Partie droite : formulaire */}\r\n      <div className=\"md:w-1/2 w-full flex flex-1 justify-center items-center bg-white dark:bg-gray-900\">\r\n        <div className=\"absolute top-4 right-4 cursor-pointer\">\r\n          <ThemeToggleButton />\r\n        </div>\r\n        <form\r\n          onSubmit={formik.handleSubmit}\r\n          className=\"bg-white dark:bg-gray-800 shadow-lg rounded-xl p-8 w-[80%] max-w-md border border-gray-100 dark:border-gray-700\"\r\n        >\r\n          <h2 className=\"text-2xl font-semibold mb-6 text-center text-[#d61353]\">\r\n            Connexion\r\n          </h2>\r\n\r\n          {/* Champ email */}\r\n          <div className=\"mb-4\">\r\n            <label\r\n              htmlFor=\"email\"\r\n              className=\"block mb-2 text-sm bg-transparent font-medium text-gray-700 dark:text-gray-300\"\r\n            >\r\n              Adresse email\r\n            </label>\r\n            <input\r\n              type=\"email\"\r\n              id=\"email\"\r\n              {...formik.getFieldProps(\"email\")}\r\n              className={`w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 \r\n                ${formik.touched.email && formik.errors.email\r\n                  ? \"border-red-500 focus:ring-red-500\"\r\n                  : \"border-gray-300 focus:ring-[#d61353]\"\r\n                }`}\r\n            />\r\n            {formik.touched.email && formik.errors.email && (\r\n              <p className=\"text-red-500 text-sm mt-1\">{formik.errors.email}</p>\r\n            )}\r\n          </div>\r\n\r\n          {/* Champ mot de passe */}\r\n          <div className=\"mb-6 relative\">\r\n            <label\r\n              htmlFor=\"password\"\r\n              className=\"block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300\"\r\n            >\r\n              Mot de passe\r\n            </label>\r\n            <div className=\"flex justify-between items-center\">\r\n              <input\r\n                type={showPassword ? \"text\" : \"password\"}\r\n                id=\"password\"\r\n                {...formik.getFieldProps(\"password\")}\r\n                className={`w-full px-4 py-2 pr-10 border rounded-lg focus:outline-none focus:ring-2 \r\n                  ${formik.touched.password && formik.errors.password\r\n                    ? \"border-red-500 focus:ring-red-500\"\r\n                    : \"border-gray-300 focus:ring-[#d61353]\"\r\n                  }`}\r\n              />\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setShowPassword(!showPassword)}\r\n                className=\"absolute right-3 text-gray-700 dark:text-gray-700 cursor-pointer\"\r\n              >\r\n                {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}\r\n              </button>\r\n              {formik.touched.password && formik.errors.password && (\r\n                <p className=\"text-red-500 text-sm mt-1\">{formik.errors.password}</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Bouton */}\r\n          <button\r\n            type=\"submit\"\r\n            disabled={isLoading}\r\n            className={`w-full flex justify-center items-center gap-2 bg-[#d61353] hover:bg-[#b01045] text-white font-semibold py-2 rounded-lg transition duration-200\r\n    ${isLoading ? \"opacity-70 cursor-not-allowed\" : \"\"}\r\n  `}\r\n          >\r\n            {isLoading ? (\r\n              <span className=\"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin\"></span>\r\n            ) : (\r\n              \"Se connecter\"\r\n            )}\r\n          </button>\r\n\r\n        </form>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\Layouts\\DashboardLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\Paginate.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ProtectedRoute.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\app-sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\campagnes\\AddCampagne.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\campagnes\\CampagneTable.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setError' is assigned a value but never used.","line":44,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":44,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useCallback, useEffect, useState } from \"react\"\r\nimport { Pencil, Trash2, Plus, Megaphone, Eye, Search } from \"lucide-react\"\r\nimport AddCampagneModal from \"@/components/campagnes/AddCampagne\"\r\nimport EditCampagneModal from \"@/components/campagnes/EditCampagne\"\r\nimport DeleteCampagneModal from \"@/components/campagnes/DeleteCampagne\"\r\nimport Link from \"next/link\"\r\nimport { Paginate } from \"../Paginate\"\r\nimport { useSearchParams } from \"next/navigation\";\r\nimport { Input } from \"@/components/ui/input\"\r\n\r\nimport { useAuth } from \"@/app/context/AuthContext\"\r\nimport { toast } from \"react-toastify\"\r\n\r\ninterface Campagne {\r\n  id_campagne: string\r\n  nom_campagne: string\r\n  type_campagne?: string\r\n  status?: string\r\n  date_debut?: string\r\n  date_fin?: string\r\n  client?: { nom?: string; prenom?: string; entreprise?: string; id_client?: string }\r\n  lieu?: { nom?: string; ville?: string; id_lieu?: string }\r\n  service?: { nom?: string; id_service?: string }\r\n  gestionnaire?: { nom?: string; prenom?: string; email?: string; id_user?: string; type_user?: string }\r\n  quantite_service?: number\r\n  _count?: { affectations?: number }\r\n}\r\n\r\nconst getCampagneStatusColor = (status?: string) => {\r\n  switch (status) {\r\n    case \"EN_COURS\": return \"bg-blue-100 text-blue-800\";\r\n    case \"TERMINEE\": return \"bg-green-100 text-green-800\";\r\n    case \"PLANIFIEE\": return \"bg-yellow-100 text-yellow-800\";\r\n    default: return \"bg-red-100 text-red-800\";\r\n  }\r\n};\r\n\r\nexport default function CampagneTable() {\r\n  const { apiClient } = useAuth()\r\n  const [campagnes, setCampagnes] = useState<Campagne[]>([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n  const [searchQuery, setSearchQuery] = useState(\"\")\r\n\r\n  const [isModalOpen, setIsModalOpen] = useState(false)\r\n  const [isEditModalOpen, setIsEditModalOpen] = useState(false)\r\n  const [isDeleteOpen, setIsDeleteOpen] = useState(false)\r\n  const [campagneToDelete, setCampagneToDelete] = useState<Campagne | null>(null)\r\n  const [campagneToEdit, setCampagneToEdit] = useState<Campagne | null>(null)\r\n\r\n  const searchParam = useSearchParams();\r\n  const page = parseInt(searchParam?.get(\"page\") || \"1\");\r\n  const [totalPages, setTotalPages] = useState(1);\r\n\r\n  const fetchCampagnes = useCallback(async () => {\r\n    setLoading(true)\r\n    try {\r\n      const params = new URLSearchParams({ page: String(page), limit: '7' })\r\n      const res = await apiClient(`/api/campagnes?${params.toString()}`)\r\n\r\n      if (!res.ok) {\r\n        const body = await res.json().catch(() => ({})) as Record<string, string>\r\n        throw new Error(body.error || `Erreur ${res.status}`)\r\n      }\r\n      const data = await res.json()\r\n      setCampagnes(data.campagnes || [])\r\n      setTotalPages(data.pagination?.totalPages || 1);\r\n    } catch (err: unknown) {\r\n      console.error(\"Erreur fetch campagnes:\", err)\r\n      const message = err instanceof Error ? err.message : \"Erreur lors du chargement des campagnes\"\r\n      toast.error(message)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [apiClient, page])\r\n\r\n  useEffect(() => {\r\n    fetchCampagnes()\r\n  }, [fetchCampagnes])\r\n\r\n  // handlers passed to modals: they simply refresh the list\r\n  const handleAddCampagne = () => fetchCampagnes()\r\n  const handleEditCampagne = () => fetchCampagnes()\r\n\r\n  const filteredCampagnes = campagnes.filter((c) => {\r\n    const search = searchQuery.toLowerCase()\r\n    return (\r\n      c.nom_campagne.toLowerCase().includes(search) ||\r\n      (c.type_campagne || \"\").toLowerCase().includes(search) ||\r\n      (c.status || \"\").toLowerCase().includes(search) ||\r\n      (c.service?.nom || \"\").toLowerCase().includes(search)\r\n    )\r\n  })\r\n\r\n  return (\r\n    <div className=\"p-6 text-gray-900 dark:text-white\">\r\n      {/* HEADER */}\r\n      <div className=\"flex flex-col sm:flex-row items-center justify-between mb-6 bg-white dark:bg-gray-900 p-4 rounded-2xl shadow-md border border-gray-100 dark:border-gray-800\">\r\n        <div className=\"flex items-center gap-2 text-[#d61353]\">\r\n          <Megaphone className=\"w-6 h-6\" />\r\n          <h1 className=\"text-xl sm:text-2xl font-bold\">Gestion des campagnes</h1>\r\n        </div>\r\n        <button\r\n          onClick={() => setIsModalOpen(true)}\r\n          className=\"flex items-center gap-2 bg-[#d61353] text-white px-3 py-2 md:px-4 md:py-2 rounded-lg hover:bg-[#b01044] transition text-sm md:text-base\"\r\n        >\r\n          <Plus className=\"w-4 h-4 md:w-5 md:h-5 cursor-pointer\" />\r\n          <span>Ajouter une campagne</span>\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"flex justify-end mb-4\">\r\n        <div className=\"relative w-full md:w-72\">\r\n          <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500\" />\r\n          <Input\r\n            placeholder=\"Rechercher...\"\r\n            value={searchQuery}\r\n            onChange={(e) => setSearchQuery(e.target.value)}\r\n            className=\"pl-9 bg-white dark:bg-gray-800\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"overflow-x-auto bg-white dark:bg-gray-900 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-800\">\r\n        {loading ? (\r\n          <div className=\"flex flex-col items-center justify-center py-10\">\r\n            <div className=\"w-10 h-10 border-4 border-[#d61353]/30 border-t-[#d61353] rounded-full animate-spin\"></div>\r\n            <p className=\"mt-3 text-gray-600 dark:text-gray-300 font-medium\">\r\n              Chargement des campagnes...\r\n            </p>\r\n          </div>\r\n        ) : error ? (\r\n\r\n          <div className=\"text-center text-red-500 py-8\">{error}</div>\r\n        ) : campagnes.length === 0 ? (\r\n          <div className=\"text-center py-8 text-gray-500\">Aucune campagne trouvé</div>\r\n        ) : (\r\n          <div>\r\n            <table className=\"min-w-full border-collapse\">\r\n              <thead>\r\n                <tr className=\"bg-gray-50 dark:bg-gray-800\">\r\n                  <th className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-semibold\">Nom</th>\r\n                  <th className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-semibold\">Type</th>\r\n                  <th className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-semibold\">Status</th>\r\n                  <th className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-semibold\">Date début</th>\r\n                  <th className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-semibold\">Date fin</th>\r\n                  <th className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-semibold\">Service</th>\r\n                  <th className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-semibold\">Quantité</th>\r\n                  <th className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-semibold text-center\">Actions</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700\">\r\n                {loading && (\r\n                  <tr>\r\n                    <td colSpan={8} className=\"p-4 text-center text-sm text-gray-500\">Chargement...</td>\r\n                  </tr>\r\n                )}\r\n\r\n                {!loading && filteredCampagnes.length === 0 && (\r\n                  <tr>\r\n                    <td colSpan={8} className=\"p-4 text-center text-sm text-gray-500\">Aucune campagne trouvée</td>\r\n                  </tr>\r\n                )}\r\n\r\n                {filteredCampagnes.map((campagne) => (\r\n                  <tr key={campagne.id_campagne} className=\"hover:bg-gray-50 dark:hover:bg-gray-800\">\r\n                    <td className=\"px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm\">{campagne.nom_campagne}</td>\r\n                    <td className=\"px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm\">{campagne.type_campagne ?? '-'}</td>\r\n                    <td className=\"px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm\">\r\n                      <span className={`px-2 py-1 rounded-full text-xs ${getCampagneStatusColor(campagne.status)}`}>\r\n                        {campagne.status ?? '-'}\r\n                      </span>\r\n                    </td>\r\n                    <td className=\"px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm\">{campagne.date_debut ? new Date(campagne.date_debut).toLocaleDateString('fr-FR') : '-'}</td>\r\n                    <td className=\"px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm\">{campagne.date_fin ? new Date(campagne.date_fin).toLocaleDateString('fr-FR') : '-'}</td>\r\n                    <td className=\"px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm\">{campagne.service?.nom ?? '-'}</td>\r\n                    <td className=\"px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm\">{campagne.quantite_service ?? campagne._count?.affectations ?? '-'}</td>\r\n                    <td className=\"px-3 md:px-6 py-3 md:py-4 text-xs md:text-sm text-center\">\r\n                      <div className=\"flex justify-center gap-3\">\r\n                        <Link href={`/dashboard/campagnes/${campagne.id_campagne}`}>\r\n                          <button className=\"p-2 rounded-lg cursor-pointer bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-800 transition\">\r\n                            <Eye className=\"w-4 h-4\" />\r\n                          </button>\r\n                        </Link>\r\n\r\n                        <button\r\n                          onClick={() => { setCampagneToEdit(campagne); setIsEditModalOpen(true) }}\r\n                          className=\"p-2 rounded-lg bg-blue-50 cursor-pointer dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-800 transition\"\r\n                        >\r\n                          <Pencil className=\"w-4 h-4\" />\r\n                        </button>\r\n\r\n                        <button\r\n                          onClick={() => { setCampagneToDelete(campagne); setIsDeleteOpen(true) }}\r\n                          className=\"p-2 rounded-lg cursor-pointer bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-800 transition\"\r\n                        >\r\n                          <Trash2 className=\"w-4 h-4\" />\r\n                        </button>\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n            {totalPages > 1 && <Paginate pages={totalPages} currentPage={page} />}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <AddCampagneModal\r\n        isOpen={isModalOpen}\r\n        onClose={() => setIsModalOpen(false)}\r\n        onAddCampagne={handleAddCampagne}\r\n      />\r\n\r\n      {campagneToEdit && (\r\n        <EditCampagneModal\r\n          isOpen={isEditModalOpen}\r\n          campagne={campagneToEdit}\r\n          onClose={() => setIsEditModalOpen(false)}\r\n          onEditCampagne={handleEditCampagne}\r\n        />\r\n      )}\r\n\r\n      <DeleteCampagneModal\r\n        isOpen={isDeleteOpen}\r\n        campagne={campagneToDelete}\r\n        onClose={() => { setIsDeleteOpen(false); setCampagneToDelete(null) }}\r\n        onCampagneUpdated={() => { fetchCampagnes(); setIsDeleteOpen(false); setCampagneToDelete(null) }}\r\n      />\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\campagnes\\DeleteCampagne.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\campagnes\\DetailCampagne.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileText' is defined but never used.","line":6,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PrestataireCampagne' is defined but never used.","line":45,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":45,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PaiementPrestataire' is defined but never used.","line":45,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":45,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'VerificationMaterielleModal' is defined but never used.","line":47,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":47,"endColumn":35},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isVerificationModalOpen' is assigned a value but never used.","line":160,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":160,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setIsVerificationModalOpen' is assigned a value but never used.","line":160,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":160,"endColumn":61},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'selectedPrestataireForVerification' is assigned a value but never used.","line":161,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":161,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSelectedPrestataireForVerification' is assigned a value but never used.","line":161,"column":46,"nodeType":null,"messageId":"unusedVar","endLine":161,"endColumn":83},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":196,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":196,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7492,7495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7492,7495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":198,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":198,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7656,7659],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7656,7659],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":198,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":198,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7664,7667],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7664,7667],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":211,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":211,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8254,8257],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8254,8257],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":211,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":211,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8262,8265],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8262,8265],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":286,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":286,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10915,10918],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10915,10918],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":811,"column":29,"nodeType":"JSXOpeningElement","endLine":811,"endColumn":111}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":15,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport {\r\n  ArrowLeft,\r\n  Megaphone,\r\n  FileText,\r\n  Calendar,\r\n  User,\r\n  Target,\r\n  Info,\r\n  Building,\r\n  MapPin,\r\n  ClipboardList,\r\n  Users,\r\n  Paperclip,\r\n  PlusCircle,\r\n  Search,\r\n} from \"lucide-react\";\r\nimport Link from \"next/link\";\r\nimport { useEffect, useState, useCallback } from \"react\";\r\nimport { useAuth } from \"@/app/context/AuthContext\";\r\nimport { toast } from \"react-toastify\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\r\nimport { PrestataireCampagne, PaiementPrestataire } from '@prisma/client';\r\nimport AddIncidentModal from \"@/components/prestataires/AddIncidentModal\";\r\nimport VerificationMaterielleModal from \"./VerificationMaterielleModal\";\r\nimport UpdateCampaignPhotoModal from \"@/components/campagnes/UpdateCampaignPhotoModal\";\r\nimport QuickAddPrestataireModal from \"./QuickAddPrestataireModal\";\r\n\r\n\r\n\r\n// Interfaces (gardées telles quelles)\r\ninterface Client {\r\n  id_client?: string;\r\n  nom?: string;\r\n  prenom?: string;\r\n  entreprise?: string | null;\r\n  contact?: string | null;\r\n  mail?: string | null;\r\n}\r\ninterface Lieu { id_lieu?: string; nom?: string; ville?: string; }\r\ninterface Service { id_service?: string; nom?: string; description?: string | null; }\r\ninterface Gestionnaire { id_user?: string; nom?: string; prenom?: string; email?: string; }\r\ninterface Affectation {\r\n  prestataire: {\r\n    id_prestataire: string;\r\n    nom?: string;\r\n    prenom?: string;\r\n    contact?: string;\r\n    service?: { nom?: string } | null;\r\n  };\r\n  paiement?: {\r\n    paiement_base?: number;\r\n    sanction_montant?: number;\r\n    paiement_final?: number;\r\n  } | null;\r\n  date_creation?: string;\r\n  status?: string;\r\n  image_affiche?: string | null;\r\n}\r\ninterface Fichier { id_fichier: string; nom_fichier?: string; url?: string; description?: string | null; type_fichier?: string | null; date_creation?: string; }\r\ninterface PrestataireListItem {\r\n  id_prestataire: string;\r\n  nom?: string;\r\n  prenom?: string;\r\n  contact?: string | null;\r\n  service?: { nom?: string } | null;\r\n  disponible?: boolean;\r\n  plaque?: string | null;\r\n  id_verification?: string | null;\r\n  affectations?: Array<{\r\n    campagne: {\r\n      id_campagne: string;\r\n      nom_campagne?: string;\r\n      date_fin?: string;\r\n    }\r\n  }>;\r\n  lastCampDate?: string | null;\r\n  lastCampName?: string | null;\r\n}\r\ninterface Campagne {\r\n  id_campagne: string; nom_campagne?: string; description?: string | null; objectif?: string | null; quantite_service?: number | null; nbr_prestataire?: number | null; type_campagne?: string | null; date_debut?: string | null; date_fin?: string | null; status?: string | null; date_creation?: string | null; updated_at?: string | null; client?: Client | null; lieu?: Lieu | null; service?: Service | null; gestionnaire?: Gestionnaire | null; affectations?: Affectation[] | null; fichiers?: Fichier[] | null; _count?: { affectations?: number; fichiers?: number; dommages?: number };\r\n}\r\n\r\n// Composant pour afficher une information\r\nconst InfoItem = ({ icon, label, value }: { icon: React.ReactNode; label: string; value: React.ReactNode }) => (\r\n  <div className=\"flex items-start gap-3\">\r\n    <div className=\"text-gray-500 dark:text-gray-400 mt-1\">{icon}</div>\r\n    <div>\r\n      <p className=\"text-sm font-medium text-gray-600 dark:text-gray-300\">{label}</p>\r\n      <p className=\"text-base font-semibold\">{value || \"-\"}</p>\r\n    </div>\r\n  </div>\r\n);\r\n\r\n// Mapping des status et couleurs de badge\r\nconst statusMap: { [key: string]: { label: string; color: \"default\" | \"destructive\" | \"outline\" | \"secondary\" } } = {\r\n  PLANIFIEE: { label: \"Planifiée\", color: \"secondary\" },\r\n  EN_COURS: { label: \"En cours\", color: \"secondary\" }, // Modifié pour correspondre aux types valides\r\n  TERMINEE: { label: \"Terminée\", color: \"default\" },    // Modifié pour correspondre aux types valides\r\n  ANNULEE: { label: \"Annulée\", color: \"destructive\" },\r\n};\r\n\r\nexport default function DetailCampagne({ id }: { id: string }) {\r\n  const { apiClient } = useAuth();\r\n  const [campagne, setCampagne] = useState<Campagne | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [isAssigning, setIsAssigning] = useState(false);\r\n\r\n\r\n  // Assign prestataire states\r\n  const [prestataires, setPrestataires] = useState<PrestataireListItem[]>([]);\r\n  const [selectedPrestataires, setSelectedPrestataires] = useState<string[]>([]);\r\n  const [isAssignDialogOpen, setIsAssignDialogOpen] = useState(false);\r\n  const [isQuickAddOpen, setIsQuickAddOpen] = useState(false);\r\n  const [searchQuery, setSearchQuery] = useState(\"\");\r\n  const [assignmentsSearchQuery, setAssignmentsSearchQuery] = useState(\"\");\r\n\r\n\r\n  /* State: Update Campaign Photo */\r\n  const [isPhotoModalOpen, setIsPhotoModalOpen] = useState(false);\r\n  const [selectedPrestataireForPhoto, setSelectedPrestataireForPhoto] = useState<{ id: string, photo_url: string | null } | null>(null);\r\n\r\n\r\n  // Upload fichier states\r\n  const [fileType, setFileType] = useState(\"\");\r\n  const [fileUpload, setFileUpload] = useState<File | null>(null);\r\n  const [isUploadDialogOpen, setIsUploadDialogOpen] = useState(false);\r\n\r\n  // Incident modal states\r\n  const [isIncidentModalOpen, setIsIncidentModalOpen] = useState(false);\r\n  const [selectedPrestataireForIncident, setSelectedPrestataireForIncident] = useState<{\r\n    id: string;\r\n    nom: string;\r\n    prenom: string;\r\n  } | null>(null);\r\n\r\n  // Verification Materielle states\r\n  const [isVerificationModalOpen, setIsVerificationModalOpen] = useState(false);\r\n  const [selectedPrestataireForVerification, setSelectedPrestataireForVerification] = useState<string | undefined>(undefined);\r\n\r\n  const fileTypes = [\"RAPPORT_JOURNALIER\", \"RAPPORT_FINAL\", \"PIGE\"];\r\n\r\n  const fetchCampagne = useCallback(async () => {\r\n    if (!id) return;\r\n    setLoading(true);\r\n    try {\r\n      const res = await apiClient(`/api/campagnes/${id}`);\r\n      if (!res.ok) {\r\n        const body = await res.json().catch(() => ({}));\r\n        throw new Error(body.error || `Erreur ${res.status}`);\r\n      }\r\n      const data = await res.json();\r\n      setCampagne(data.campagne ?? null);\r\n    } catch (err) {\r\n      console.error(\"Erreur fetch campagne:\", err);\r\n      toast.error(err instanceof Error ? err.message : \"Erreur lors du chargement\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [id, apiClient]);\r\n\r\n  useEffect(() => {\r\n    fetchCampagne();\r\n  }, [fetchCampagne]);\r\n\r\n  const fetchPrestataires = useCallback(async () => {\r\n    if (!campagne?.service?.id_service) return;\r\n    try {\r\n      const res = await apiClient(`/api/prestataires?disponible=true&limit=-1&serviceId=${campagne.service.id_service}`);\r\n      if (!res.ok) throw new Error(`Erreur ${res.status}`);\r\n      const data = await res.json();\r\n\r\n      // Récupérer la dernière campagne (la plus récente) pour chaque prestataire\r\n      const prestatairesWithLastCamp = data.prestataires.map((p: any) => {\r\n        // Trier les affectations par date de fin décroissante pour obtenir la plus récente\r\n        const sortedAffectations = p.affectations?.sort((a: any, b: any) =>\r\n          new Date(b.campagne.date_fin).getTime() - new Date(a.campagne.date_fin).getTime()\r\n        );\r\n        const lastCamp = sortedAffectations?.[0]; // Prendre la plus récente\r\n        return {\r\n          ...p,\r\n          id_verification: p.id_verification,\r\n          lastCampDate: lastCamp?.campagne?.date_fin || null,\r\n          lastCampName: lastCamp?.campagne?.nom_campagne || null\r\n        };\r\n      });\r\n\r\n      // Trier les prestataires par date de fin de dernière campagne en ordre croissant (A-Z)\r\n      const sortedPrestataires = prestatairesWithLastCamp.sort((a: any, b: any) => {\r\n        // Les prestataires sans campagne viennent en premier\r\n        if (!a.lastCampDate && !b.lastCampDate) return 0;\r\n        if (!a.lastCampDate) return -1;\r\n        if (!b.lastCampDate) return 1;\r\n        return new Date(a.lastCampDate).getTime() - new Date(b.lastCampDate).getTime();\r\n      });\r\n\r\n      setPrestataires(sortedPrestataires);\r\n    } catch (err) {\r\n      console.error(\"Erreur fetch prestataires:\", err);\r\n      toast.error(err instanceof Error ? err.message : \"Erreur lors du chargement des prestataires\");\r\n    }\r\n  }, [apiClient, campagne]);\r\n\r\n  const handleFileUpload = async () => {\r\n    if (!fileUpload || !fileType) {\r\n      toast.error(\"Veuillez sélectionner un fichier et un type\");\r\n      return;\r\n    }\r\n    try {\r\n      const formData = new FormData();\r\n      formData.append(\"file\", fileUpload);\r\n      formData.append(\"type_fichier\", fileType);\r\n\r\n      const res = await apiClient(`/api/campagnes/${id}/fichiers`, { method: \"POST\", body: formData });\r\n      const body = await res.json();\r\n      if (!res.ok) throw new Error(body.error || \"Erreur upload fichier\");\r\n\r\n      toast.success(\"Fichier téléchargé avec succès\");\r\n      setCampagne(prev => prev ? { ...prev, fichiers: [body.fichier, ...(prev.fichiers || [])] } : null);\r\n      setFileUpload(null); setFileType(\"\"); setIsUploadDialogOpen(false);\r\n    } catch (err) {\r\n      toast.error(err instanceof Error ? err.message : \"Erreur upload\");\r\n    }\r\n  };\r\n\r\n  const handleAssign = async () => {\r\n    if (selectedPrestataires.length === 0) {\r\n      toast.error(\"Veuillez sélectionner au moins un prestataire\");\r\n      return;\r\n    }\r\n\r\n\r\n    setIsAssigning(true);\r\n\r\n    try {\r\n      const res = await apiClient(`/api/campagnes/${id}/prestataires`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          id_prestataires: selectedPrestataires\r\n        })\r\n      });\r\n\r\n      const body = await res.json().catch(() => ({}));\r\n      if (!res.ok) throw new Error(body.error || `Erreur ${res.status}`);\r\n\r\n      toast.success(body.message || \"Prestataire affecté avec succès\");\r\n\r\n      // Recharger les données de la campagne pour afficher les prestataires assignés\r\n      await fetchCampagne();\r\n      setSelectedPrestataires([]);\r\n      setIsAssignDialogOpen(false);\r\n      setSearchQuery(\"\");\r\n\r\n\r\n    } catch (err) {\r\n      console.error(\"Erreur assign prestataire:\", err);\r\n      toast.error(err instanceof Error ? err.message : \"Erreur lors de l'affectation\");\r\n    } finally {\r\n      setIsAssigning(false);\r\n    }\r\n  };\r\n\r\n  const handleQuickAddSuccess = (newPrestataire: any) => {\r\n    // 1. Add to local list (prepend)\r\n    const newPrestItem: PrestataireListItem = {\r\n      id_prestataire: newPrestataire.id_prestataire,\r\n      nom: newPrestataire.nom,\r\n      prenom: newPrestataire.prenom,\r\n      contact: newPrestataire.contact,\r\n      service: newPrestataire.service ? { nom: newPrestataire.service.nom } : null,\r\n      disponible: true, // Newly created is available\r\n      plaque: newPrestataire.plaque,\r\n      id_verification: newPrestataire.id_verification,\r\n      lastCampDate: null,\r\n      lastCampName: null,\r\n    };\r\n    setPrestataires([newPrestItem, ...prestataires]);\r\n\r\n    // 2. Auto-select it\r\n    setSelectedPrestataires((prev) => [...prev, newPrestItem.id_prestataire]);\r\n\r\n    // 3. Close modal\r\n    setIsQuickAddOpen(false);\r\n  };\r\n\r\n  if (loading) return (\r\n    <div className=\"flex flex-col items-center justify-center py-10\">\r\n      <div className=\"w-10 h-10 border-4 border-[#d61353]/30 border-t-[#d61353] rounded-full animate-spin\"></div>\r\n      <p className=\"mt-3 text-gray-600 dark:text-gray-300 font-medium\">Chargement...</p>\r\n    </div>\r\n  );\r\n\r\n  if (!campagne) return (\r\n    <div className=\"p-6 text-center\">\r\n      <p className=\"text-gray-500\">Campagne non trouvée.</p>\r\n      <Link href=\"/dashboard/campagnes\" className=\"mt-4 inline-block\">\r\n        <Button variant=\"outline\"><ArrowLeft className=\"w-4 h-4 mr-2\" /> Retour</Button>\r\n      </Link>\r\n    </div>\r\n  );\r\n\r\n  const currentStatus = statusMap[campagne.status || \"\"] || { label: campagne.status, color: \"default\" };\r\n\r\n  // --- Search Logic ---\r\n  const normalizeString = (str: string) => str.toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\");\r\n  const normalizePlaque = (str: string) => str.toLowerCase().replace(/[^a-z0-9]/g, \"\");\r\n\r\n  const filteredPrestataires = prestataires.filter(p => {\r\n    const search = normalizeString(searchQuery);\r\n    const searchPlaque = normalizePlaque(searchQuery);\r\n\r\n    const matchName = normalizeString(p.nom || \"\").includes(search);\r\n    const matchPrenom = normalizeString(p.prenom || \"\").includes(search);\r\n    const matchService = normalizeString(p.service?.nom || \"\").includes(search);\r\n\r\n    // Recherche intelligente sur la plaque : on compare les versions \"nettoyées\" (sans tirets/espaces)\r\n    const matchPlaque = p.plaque && normalizePlaque(p.plaque).includes(searchPlaque);\r\n\r\n    const valVerif = String(p.id_verification || \"\");\r\n    const matchVerification =\r\n      normalizeString(valVerif).includes(search) ||\r\n      normalizePlaque(valVerif).includes(searchPlaque);\r\n\r\n    return matchName || matchPrenom || matchService || matchPlaque || matchVerification;\r\n  });\r\n\r\n  const filteredAssignments = campagne.affectations?.filter(a => {\r\n    if (!a.prestataire) return false;\r\n    const search = normalizeString(assignmentsSearchQuery);\r\n    return (\r\n      normalizeString(a.prestataire.nom || \"\").includes(search) ||\r\n      normalizeString(a.prestataire.prenom || \"\").includes(search)\r\n    );\r\n  }) || [];\r\n\r\n  return (\r\n    <div className=\"p-6 space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <Link href=\"/dashboard/campagnes\">\r\n          <Button variant=\"outline\" className=\"flex items-center gap-2\">\r\n            <ArrowLeft className=\"w-5 h-5\" />\r\n            Retour\r\n          </Button>\r\n        </Link>\r\n        <div className=\"flex items-center gap-3 text-[#d61353]\">\r\n          <Megaphone className=\"w-7 h-7\" />\r\n          <h1 className=\"text-3xl font-bold\">{campagne.nom_campagne}</h1>\r\n        </div>\r\n        <div />\r\n      </div>\r\n\r\n      {/* Carte Principale */}\r\n      <Card>\r\n        <CardHeader>\r\n          <div className=\"flex justify-between items-start\">\r\n            <div>\r\n              <CardTitle>Synthèse de la Campagne</CardTitle>\r\n              <CardDescription>\r\n                {campagne.description || \"Aucune description\"}\r\n              </CardDescription>\r\n            </div>\r\n            <Badge variant={currentStatus.color}>{currentStatus.label}</Badge>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n          <InfoItem\r\n            icon={<Calendar size={20} />}\r\n            label=\"Période\"\r\n            value={`${campagne.date_debut\r\n              ? new Date(campagne.date_debut).toLocaleDateString(\"fr-FR\")\r\n              : \"-\"\r\n              } au ${campagne.date_fin\r\n                ? new Date(campagne.date_fin).toLocaleDateString(\"fr-FR\")\r\n                : \"-\"\r\n              }`}\r\n          />\r\n          <InfoItem\r\n            icon={<User size={20} />}\r\n            label=\"Client\"\r\n            value={`${campagne.client?.nom ?? \"\"} ${campagne.client?.prenom ?? \"\"\r\n              } (${campagne.client?.entreprise ?? \"N/A\"})`}\r\n          />\r\n          <InfoItem\r\n            icon={<MapPin size={20} />}\r\n            label=\"Lieu\"\r\n            value={`${campagne.lieu?.nom ?? \"-\"} (${campagne.lieu?.ville ?? \"N/A\"\r\n              })`}\r\n          />\r\n          <InfoItem\r\n            icon={<ClipboardList size={20} />}\r\n            label=\"Service\"\r\n            value={campagne.service?.nom ?? \"-\"}\r\n          />\r\n          <InfoItem\r\n            icon={<Target size={20} />}\r\n            label=\"Objectif\"\r\n            value={campagne.objectif}\r\n          />\r\n          <InfoItem\r\n            icon={<Info size={20} />}\r\n            label=\"Type\"\r\n            value={campagne.type_campagne}\r\n          />\r\n          <InfoItem\r\n            icon={<Users size={20} />}\r\n            label=\"Prestataires\"\r\n            value={`${campagne._count?.affectations ?? 0} / ${campagne.nbr_prestataire ?? \"N/A\"\r\n              }`}\r\n          />\r\n          <InfoItem\r\n            icon={<Paperclip size={20} />}\r\n            label=\"Fichiers\"\r\n            value={campagne._count?.fichiers ?? 0}\r\n          />\r\n          <InfoItem\r\n            icon={<User size={20} />}\r\n            label=\"Gestionnaire\"\r\n            value={\r\n              campagne.gestionnaire\r\n                ? `${campagne.gestionnaire.nom} ${campagne.gestionnaire.prenom}`\r\n                : \"-\"\r\n            }\r\n          />\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Section Fichiers */}\r\n      <Card>\r\n        <CardHeader className=\"flex flex-row items-center justify-between\">\r\n          <div>\r\n            <CardTitle>Fichiers de la Campagne</CardTitle>\r\n            <CardDescription>\r\n              Consultez et ajoutez des rapports et autres documents.\r\n            </CardDescription>\r\n          </div>\r\n          <Dialog\r\n            open={isUploadDialogOpen}\r\n            onOpenChange={setIsUploadDialogOpen}\r\n          >\r\n            <DialogTrigger asChild>\r\n              <Button>\r\n                <PlusCircle className=\"mr-2 h-4 w-4\" /> Ajouter Fichier\r\n              </Button>\r\n            </DialogTrigger>\r\n            <DialogContent>\r\n              <DialogHeader>\r\n                <DialogTitle>Ajouter un nouveau fichier</DialogTitle>\r\n              </DialogHeader>\r\n              <div className=\"space-y-4 py-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"fileType\">Type de fichier</Label>\r\n                  <Select onValueChange={setFileType} value={fileType}>\r\n                    <SelectTrigger id=\"fileType\">\r\n                      <SelectValue placeholder=\"-- Sélectionner un type --\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {fileTypes.map((t) => (\r\n                        <SelectItem key={t} value={t}>\r\n                          {t}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"fileUpload\">Fichier</Label>\r\n                  <Input\r\n                    id=\"fileUpload\"\r\n                    type=\"file\"\r\n                    onChange={(e) => setFileUpload(e.target.files?.[0] || null)}\r\n                  />\r\n                </div>\r\n              </div>\r\n              <DialogFooter>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  onClick={() => setIsUploadDialogOpen(false)}\r\n                >\r\n                  Annuler\r\n                </Button>\r\n                <Button onClick={handleFileUpload}>Uploader</Button>\r\n              </DialogFooter>\r\n            </DialogContent>\r\n          </Dialog>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {campagne.fichiers && campagne.fichiers.length > 0 ? (\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead>Nom du fichier</TableHead>\r\n                  <TableHead>Type</TableHead>\r\n                  <TableHead>Date</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {campagne.fichiers.map((f) => (\r\n                  <TableRow key={f.id_fichier}>\r\n                    <TableCell className=\"font-medium\">\r\n                      {f.nom_fichier ?? \"Fichier\"}\r\n                    </TableCell>\r\n                    <TableCell>{f.type_fichier}</TableCell>\r\n                    <TableCell>\r\n                      {f.date_creation\r\n                        ? new Date(f.date_creation).toLocaleDateString(\"fr-FR\")\r\n                        : \"\"}\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ))}\r\n              </TableBody>\r\n            </Table>\r\n          ) : (\r\n            <p className=\"text-sm text-center text-gray-500 py-8\">\r\n              Aucun fichier associé.\r\n            </p>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Section Prestataires */}\r\n      <Card>\r\n        <CardHeader className=\"flex flex-row items-center justify-between\">\r\n          <div>\r\n            <CardTitle>Prestataires Assignés</CardTitle>\r\n            <CardDescription>\r\n              Gérez les prestataires affectés à cette campagne.\r\n            </CardDescription>\r\n          </div>\r\n          <Dialog\r\n            open={isAssignDialogOpen}\r\n            onOpenChange={setIsAssignDialogOpen}\r\n          >\r\n            <DialogTrigger asChild>\r\n              <Button\r\n                onClick={() => {\r\n                  if (!prestataires.length) fetchPrestataires();\r\n                }}\r\n              >\r\n                <PlusCircle className=\"mr-2 h-4 w-4\" /> Assigner\r\n              </Button>\r\n            </DialogTrigger>\r\n\r\n            <DialogContent className=\"max-w-3xl max-h-[85vh] flex flex-col\">\r\n              <QuickAddPrestataireModal\r\n                isOpen={isQuickAddOpen}\r\n                onClose={() => setIsQuickAddOpen(false)}\r\n                onSuccess={handleQuickAddSuccess}\r\n                defaultServiceId={campagne.service?.id_service}\r\n                defaultServiceName={campagne.service?.nom}\r\n              />\r\n              <DialogHeader>\r\n                <DialogTitle className=\"flex justify-between items-center\">\r\n                  <span>Assigner un nouveau prestataire</span>\r\n                  <Button\r\n                    size=\"sm\"\r\n                    variant=\"secondary\"\r\n                    className=\"text-xs bg-[#d61353]/10 text-[#d61353] hover:bg-[#d61353]/20\"\r\n                    onClick={() => setIsQuickAddOpen(true)}\r\n                  >\r\n                    <PlusCircle className=\"mr-1 h-3 w-3\" /> Nouveau Prestataire\r\n                  </Button>\r\n                </DialogTitle>\r\n              </DialogHeader>\r\n              <div className=\"flex-1 overflow-y-auto min-h-0 py-4 pr-1\">\r\n                <Label className=\"mb-4 block\">Sélectionner un prestataire disponible</Label>\r\n\r\n                <div className=\"relative mb-4\">\r\n                  <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500\" />\r\n                  <Input\r\n                    placeholder=\"Rechercher par nom, service, plaque ou verification...\"\r\n                    className=\"pl-9\"\r\n                    value={searchQuery}\r\n                    onChange={(e) => setSearchQuery(e.target.value)}\r\n                  />\r\n                </div>\r\n\r\n                {prestataires.length === 0 ? (\r\n                  <p className=\"text-center text-gray-500 py-8\">Aucun prestataire disponible</p>\r\n                ) : filteredPrestataires.length === 0 ? (\r\n                  <p className=\"text-center text-gray-500 py-8\">Aucun résultat trouvé pour &quot;{searchQuery}&quot;</p>\r\n                ) : (\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    {filteredPrestataires.map((p) => (\r\n                      <div\r\n                        key={p.id_prestataire}\r\n                        onClick={() => {\r\n                          setSelectedPrestataires(prev =>\r\n                            prev.includes(p.id_prestataire)\r\n                              ? prev.filter(id => id !== p.id_prestataire)\r\n                              : [...prev, p.id_prestataire]\r\n                          );\r\n                        }}\r\n\r\n                        className={`relative border rounded-lg p-4 cursor-pointer transition-all\r\n${selectedPrestataires.includes(p.id_prestataire)\r\n                            ? \"border-[#d61353] bg-[#d61353]/5 shadow-md\"\r\n                            : \"border-gray-200 hover:border-[#d61353]/50\"\r\n                          }`}\r\n\r\n                      >\r\n                        {/* Checkbox */}\r\n                        <div className=\"absolute top-3 right-3\">\r\n                          <div\r\n                            className={`w-5 h-5 border-2 rounded flex items-center justify-center transition-colors ${selectedPrestataires.includes(p.id_prestataire)\r\n\r\n                              ? \"border-[#d61353] bg-[#d61353]\"\r\n                              : \"border-gray-300\"\r\n                              }`}\r\n                          >\r\n                            {selectedPrestataires.includes(p.id_prestataire) && (\r\n                              <svg\r\n                                className=\"w-3 h-3 text-white\"\r\n                                fill=\"none\"\r\n                                strokeLinecap=\"round\"\r\n                                strokeLinejoin=\"round\"\r\n                                strokeWidth=\"2\"\r\n                                viewBox=\"0 0 24 24\"\r\n                                stroke=\"currentColor\"\r\n                              >\r\n                                <path d=\"M5 13l4 4L19 7\"></path>\r\n                              </svg>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n\r\n                        {/* Contenu de la carte */}\r\n                        <div className=\"pr-8\">\r\n                          <h3 className=\"font-semibold text-lg mb-2\">\r\n                            {p.nom} {p.prenom}\r\n                          </h3>\r\n\r\n                          <div className=\"space-y-1.5 text-sm\">\r\n                            {/* Service */}\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Building className=\"w-4 h-4 text-gray-400\" />\r\n                              <span className=\"text-gray-600\">\r\n                                {p.service?.nom || \"Service non défini\"}\r\n                              </span>\r\n                            </div>\r\n\r\n                            {/* Dernière campagne */}\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Calendar className=\"w-4 h-4 text-gray-400\" />\r\n                              <span className=\"text-gray-600\">\r\n                                {p.lastCampDate\r\n                                  ? `Dernière campagne: ${new Date(p.lastCampDate).toLocaleDateString(\"fr-FR\")}`\r\n                                  : \"Aucune campagne\"}\r\n                              </span>\r\n                            </div>\r\n\r\n                            {/* Plaque (si présente) */}\r\n                            {p.plaque && (\r\n                              <div className=\"flex items-center gap-2\">\r\n                                <div className=\"text-gray-400 font-mono text-xs border px-1 rounded bg-gray-50\">\r\n                                  {p.plaque}\r\n                                </div>\r\n                                {normalizePlaque(searchQuery).length > 2 && normalizePlaque(p.plaque).includes(normalizePlaque(searchQuery)) && (\r\n                                  <span className=\"text-xs text-green-600 font-medium\">✨ Correspondance plaque</span>\r\n                                )}\r\n                              </div>\r\n                            )}\r\n\r\n                            {/* Disponibilité */}\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <div className={`w-2 h-2 rounded-full ${p.disponible ? \"bg-green-500\" : \"bg-red-500\"}`} />\r\n                              <span className=\"text-gray-600\">\r\n                                {p.disponible ? \"Disponible\" : \"Non disponible\"}\r\n                              </span>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n              </div>\r\n              <DialogFooter>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  onClick={() => {\r\n                    setSelectedPrestataires([]);\r\n                    setIsAssignDialogOpen(false);\r\n                    setSearchQuery(\"\");\r\n                  }}\r\n                >\r\n                  Annuler\r\n                </Button>\r\n                <Button\r\n                  onClick={handleAssign}\r\n                  disabled={selectedPrestataires.length === 0 || isAssigning}\r\n                  className=\"flex items-center gap-2\"\r\n                >\r\n                  {isAssigning && (\r\n                    <span className=\"w-4 h-4 border-2 border-white/40 border-t-white rounded-full animate-spin\" />\r\n                  )}\r\n                  {isAssigning ? \"Assignation...\" : \"Assigner\"}\r\n                </Button>\r\n\r\n              </DialogFooter>\r\n            </DialogContent>\r\n          </Dialog>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex justify-end mb-4\">\r\n            <div className=\"relative w-full md:w-72\">\r\n              <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500\" />\r\n              <Input\r\n                placeholder=\"Rechercher affectation...\"\r\n                value={assignmentsSearchQuery}\r\n                onChange={(e) => setAssignmentsSearchQuery(e.target.value)}\r\n                className=\"pl-9\"\r\n              />\r\n            </div>\r\n          </div>\r\n          {filteredAssignments.length > 0 ? (\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead>Prestataire</TableHead>\r\n                  <TableHead>Image</TableHead>\r\n                  <TableHead>Date d&apos;assignation</TableHead>\r\n                  <TableHead>Status</TableHead>\r\n                  <TableHead>Montant Initial</TableHead>\r\n                  <TableHead>Pénalité</TableHead>\r\n                  <TableHead>Montant payé</TableHead>\r\n                  <TableHead className=\"hidden md:table-cell\">Actions</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {filteredAssignments.map((a, idx) => {\r\n                  if (!a) return null;\r\n                  return (\r\n                    <TableRow key={idx}>\r\n                      <TableCell className=\"font-medium\">\r\n                        <div className=\"flex items-center justify-between gap-2\">\r\n                          {/* Nom du prestataire */}\r\n                          <span className=\"truncate\">\r\n                            {a.prestataire?.nom ?? \"-\"} {a.prestataire?.prenom ?? \"\"}\r\n                          </span>\r\n\r\n                          {/* Actions MOBILE */}\r\n                          {a.prestataire && (\r\n                            <div className=\"flex gap-1 md:hidden\">\r\n                              <Button\r\n                                variant=\"outline\"\r\n                                size=\"icon\"\r\n                                onClick={() => {\r\n                                  setSelectedPrestataireForPhoto({\r\n                                    id: a.prestataire.id_prestataire,\r\n                                    photo_url: a.image_affiche || null\r\n                                  });\r\n                                  setIsPhotoModalOpen(true);\r\n                                }}\r\n                              >\r\n                                📷\r\n                              </Button>\r\n\r\n                              <Button\r\n                                variant=\"outline\"\r\n                                size=\"icon\"\r\n                                onClick={() => {\r\n                                  setSelectedPrestataireForIncident({\r\n                                    id: a.prestataire.id_prestataire,\r\n                                    nom: a.prestataire.nom || \"\",\r\n                                    prenom: a.prestataire.prenom || \"\"\r\n                                  });\r\n                                  setIsIncidentModalOpen(true);\r\n                                }}\r\n                              >\r\n                                ⚠️\r\n                              </Button>\r\n\r\n                              <Link href={`/prestataires/${a.prestataire.id_prestataire}`}>\r\n                                <Button variant=\"outline\" size=\"icon\">\r\n                                  👁\r\n                                </Button>\r\n                              </Link>\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      </TableCell>\r\n\r\n\r\n                      <TableCell>\r\n                        {a.image_affiche ? (\r\n                          <div className=\"h-10 w-10 relative rounded overflow-hidden border bg-gray-100\">\r\n                            <img src={a.image_affiche} alt=\"Affiche\" className=\"h-full w-full object-cover\" />\r\n                          </div>\r\n                        ) : (\r\n                          <div className=\"h-10 w-10 rounded bg-gray-100 flex items-center justify-center text-gray-400\">\r\n                            <span className=\"text-[10px]\">N/A</span>\r\n                          </div>\r\n                        )}\r\n                      </TableCell>\r\n\r\n                      <TableCell>\r\n                        {a.date_creation ? new Date(a.date_creation).toLocaleDateString(\"fr-FR\") : \"-\"}\r\n                      </TableCell>\r\n\r\n                      <TableCell>{a.status ?? \"-\"}</TableCell>\r\n                      <TableCell>{a.paiement?.paiement_base ?? \"-\"}</TableCell>\r\n                      <TableCell>{a.paiement?.sanction_montant ?? \"-\"}</TableCell>\r\n                      <TableCell>{a.paiement?.paiement_final ?? \"-\"}</TableCell>\r\n\r\n                      <TableCell className=\"max-md:hidden block\"\r\n                      >\r\n                        <Button\r\n                          variant=\"outline\"\r\n                          size=\"sm\"\r\n                          onClick={() => {\r\n                            setSelectedPrestataireForPhoto({\r\n                              id: a.prestataire.id_prestataire,\r\n                              photo_url: a.image_affiche || null\r\n                            });\r\n                            setIsPhotoModalOpen(true);\r\n                          }}\r\n                        >\r\n                          Photo\r\n                        </Button>\r\n\r\n                        {a.prestataire && (\r\n                          <Button\r\n                            variant=\"outline\"\r\n                            size=\"sm\"\r\n                            onClick={() => {\r\n                              setSelectedPrestataireForIncident({\r\n                                id: a.prestataire.id_prestataire,\r\n                                nom: a.prestataire.nom || \"\",\r\n                                prenom: a.prestataire.prenom || \"\"\r\n                              });\r\n                              setIsIncidentModalOpen(true);\r\n                            }}\r\n                          >\r\n                            Verification / Incident\r\n                          </Button>\r\n                        )}\r\n                        {a.prestataire && (\r\n                          <Link href={`/prestataires/${a.prestataire.id_prestataire}`}>\r\n                            <Button variant=\"outline\" size=\"sm\">Voir</Button>\r\n                          </Link>\r\n                        )}\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  );\r\n                })}\r\n              </TableBody>\r\n            </Table>\r\n          ) : (\r\n            <p className=\"text-sm text-center text-gray-500 py-8\">\r\n              Aucun prestataire assigné.\r\n            </p>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Modal d'incident */}\r\n\r\n      {\r\n        selectedPrestataireForIncident && (\r\n          <AddIncidentModal\r\n            isOpen={isIncidentModalOpen}\r\n            onClose={() => {\r\n              setIsIncidentModalOpen(false);\r\n              setSelectedPrestataireForIncident(null);\r\n            }}\r\n            prestataireId={selectedPrestataireForIncident.id}\r\n            affectations={[\r\n              {\r\n                campagne: {\r\n                  id_campagne: campagne?.id_campagne || \"\",\r\n                  nom_campagne: campagne?.nom_campagne || \"\"\r\n                }\r\n              }\r\n            ]}\r\n            onIncidentAdded={() => {\r\n              // Recharger les données de la campagne pour mettre à jour les paiements\r\n              fetchCampagne();\r\n              toast.success(\"Incident enregistré avec succès\");\r\n            }}\r\n          />\r\n        )\r\n      }\r\n\r\n\r\n\r\n      {/* Campaign Photo Modal */}\r\n      {\r\n        selectedPrestataireForPhoto && (\r\n          <UpdateCampaignPhotoModal\r\n            isOpen={isPhotoModalOpen}\r\n            onClose={() => setIsPhotoModalOpen(false)}\r\n            campagneId={id}\r\n            prestataireId={selectedPrestataireForPhoto.id}\r\n            initialPhotoUrl={selectedPrestataireForPhoto.photo_url}\r\n            onPhotoUpdated={() => {\r\n              fetchCampagne();\r\n              toast.success(\"Photo de la campagne mise à jour avec succès\");\r\n            }}\r\n          />\r\n        )\r\n      }\r\n\r\n    </div >\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\campagnes\\EditCampagne.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\campagnes\\QuickAddPrestataireModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":6,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":11},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[803,806],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[803,806],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":105,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4091,4094],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4091,4094],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { useFormik } from \"formik\"\r\nimport * as Yup from \"yup\"\r\nimport { X, Loader2 } from \"lucide-react\"\r\nimport { useAuth } from \"@/app/context/AuthContext\"\r\nimport { toast } from \"react-toastify\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\"\r\n\r\ninterface Service {\r\n    id_service: string\r\n    nom: string\r\n}\r\n\r\ninterface QuickAddPrestataireModalProps {\r\n    isOpen: boolean\r\n    onClose: () => void\r\n    onSuccess: (newPrestataire: any) => void\r\n}\r\n\r\nconst validationSchema = Yup.object().shape({\r\n    nom: Yup.string().required(\"Le nom est requis\"),\r\n    prenom: Yup.string().required(\"Le prénom est requis\"),\r\n    contact: Yup.string().required(\"Le contact est requis\"),\r\n    id_service: Yup.string().required(\"Le service est requis\"),\r\n    // id_verification removed\r\n    type_panneau: Yup.string().optional(),\r\n    plaque: Yup.string().optional(),\r\n})\r\n\r\nexport default function QuickAddPrestataireModal({ isOpen, onClose, onSuccess, defaultServiceId, defaultServiceName }: QuickAddPrestataireModalProps & { defaultServiceId?: string, defaultServiceName?: string }) {\r\n    const { apiClient } = useAuth()\r\n    const [services, setServices] = useState<Service[]>([])\r\n    const [loadingServices, setLoadingServices] = useState(false)\r\n\r\n    // Fetch services when modal opens\r\n    useEffect(() => {\r\n        if (isOpen && services.length === 0 && !defaultServiceId) {\r\n            const fetchServices = async () => {\r\n                setLoadingServices(true)\r\n                try {\r\n                    const res = await apiClient(\"/api/services?page=1&limit=100\")\r\n                    if (res.ok) {\r\n                        const data = await res.json()\r\n                        setServices(data.services || [])\r\n                    }\r\n                } catch (err) {\r\n                    console.error(\"Erreur services:\", err)\r\n                } finally {\r\n                    setLoadingServices(false)\r\n                }\r\n            }\r\n            fetchServices()\r\n        }\r\n    }, [isOpen, apiClient, services.length, defaultServiceId])\r\n\r\n    const formik = useFormik({\r\n        initialValues: {\r\n            nom: \"\",\r\n            prenom: \"\",\r\n            contact: \"\",\r\n            id_service: defaultServiceId || \"\",\r\n            // id_verification removed\r\n            type_panneau: \"\",\r\n            plaque: \"\",\r\n            disponible: true, // Default\r\n        },\r\n        enableReinitialize: true,\r\n        validationSchema,\r\n        onSubmit: async (values, { setSubmitting, resetForm }) => {\r\n            try {\r\n                const body = {\r\n                    ...values,\r\n                    type_panneau: values.type_panneau || \"\",\r\n                    plaque: values.plaque || \"\",\r\n                    // Mandatory fields for backend that we are omitting in quick form\r\n                    couleur: \"\",\r\n                    marque: \"\",\r\n                    modele: \"\",\r\n                    contrat_valide: false, // Default for quick add\r\n                    equipe_gps: false,    // Default for quick add\r\n                }\r\n\r\n                const res = await apiClient(\"/api/prestataires\", {\r\n                    method: \"POST\",\r\n                    headers: { \"Content-Type\": \"application/json\" },\r\n                    body: JSON.stringify(body),\r\n                })\r\n\r\n                if (!res.ok) {\r\n                    const err = await res.json()\r\n                    throw new Error(err.error || \"Erreur lors de la création\")\r\n                }\r\n\r\n                const data = await res.json()\r\n                toast.success(\"Prestataire ajouté rapidement !\")\r\n                onSuccess(data.prestataire)\r\n                resetForm()\r\n                onClose()\r\n            } catch (err: any) {\r\n                toast.error(err.message || \"Erreur création prestataire\")\r\n            } finally {\r\n                setSubmitting(false)\r\n            }\r\n        },\r\n    })\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\r\n            <DialogContent className=\"sm:max-w-[500px]\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"text-[#d61353] flex items-center gap-2\">\r\n                        ⚡ Ajout Rapide Prestataire\r\n                    </DialogTitle>\r\n                </DialogHeader>\r\n\r\n                <form onSubmit={formik.handleSubmit} className=\"space-y-4 py-2\">\r\n\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"nom\">Nom *</Label>\r\n                            <Input\r\n                                id=\"nom\"\r\n                                placeholder=\"Nom\"\r\n                                {...formik.getFieldProps(\"nom\")}\r\n                                className={formik.touched.nom && formik.errors.nom ? \"border-red-500\" : \"\"}\r\n                            />\r\n                            {formik.touched.nom && formik.errors.nom && (\r\n                                <p className=\"text-red-500 text-xs\">{formik.errors.nom}</p>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"prenom\">Prénom *</Label>\r\n                            <Input\r\n                                id=\"prenom\"\r\n                                placeholder=\"Prénom\"\r\n                                {...formik.getFieldProps(\"prenom\")}\r\n                                className={formik.touched.prenom && formik.errors.prenom ? \"border-red-500\" : \"\"}\r\n                            />\r\n                            {formik.touched.prenom && formik.errors.prenom && (\r\n                                <p className=\"text-red-500 text-xs\">{formik.errors.prenom}</p>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"id_service\">Service *</Label>\r\n                            {defaultServiceId ? (\r\n                                <Input\r\n                                    value={defaultServiceName || \"Service imposé\"}\r\n                                    disabled\r\n                                    className=\"bg-gray-100 text-gray-500\"\r\n                                />\r\n                            ) : (\r\n                                <Select\r\n                                    value={formik.values.id_service}\r\n                                    onValueChange={(val) => formik.setFieldValue(\"id_service\", val)}\r\n                                >\r\n                                    <SelectTrigger className={formik.touched.id_service && formik.errors.id_service ? \"border-red-500\" : \"\"}>\r\n                                        <SelectValue placeholder={loadingServices ? \"Chargement...\" : \"Sélectionner un service\"} />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        {services.map((s) => (\r\n                                            <SelectItem key={s.id_service} value={s.id_service}>{s.nom}</SelectItem>\r\n                                        ))}\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            )}\r\n                            {formik.touched.id_service && formik.errors.id_service && (\r\n                                <p className=\"text-red-500 text-xs\">{formik.errors.id_service}</p>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"type_panneau\">Type Panneau *</Label>\r\n                            <Select\r\n                                value={formik.values.type_panneau}\r\n                                onValueChange={(val) => formik.setFieldValue(\"type_panneau\", val)}\r\n                            >\r\n                                <SelectTrigger className={formik.touched.type_panneau && formik.errors.type_panneau ? \"border-red-500\" : \"\"}>\r\n                                    <SelectValue placeholder=\"Choisir\" />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    <SelectItem value=\"PETIT\">PETIT</SelectItem>\r\n                                    <SelectItem value=\"GRAND\">GRAND</SelectItem>\r\n                                </SelectContent>\r\n                            </Select>\r\n                            {formik.touched.type_panneau && formik.errors.type_panneau && (\r\n                                <p className=\"text-red-500 text-xs\">{formik.errors.type_panneau}</p>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"contact\">Contact *</Label>\r\n                        <Input\r\n                            id=\"contact\"\r\n                            placeholder=\"Téléphone / Email\"\r\n                            {...formik.getFieldProps(\"contact\")}\r\n                            className={formik.touched.contact && formik.errors.contact ? \"border-red-500\" : \"\"}\r\n                        />\r\n                        {formik.touched.contact && formik.errors.contact && (\r\n                            <p className=\"text-red-500 text-xs\">{formik.errors.contact}</p>\r\n                        )}\r\n                    </div>\r\n\r\n\r\n\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"plaque\">Plaque (Immatriculation)</Label>\r\n                        <Input\r\n                            id=\"plaque\"\r\n                            placeholder=\"Ex: AB-123-CD\"\r\n                            {...formik.getFieldProps(\"plaque\")}\r\n                        />\r\n                    </div>\r\n\r\n                    {/* id_verification input removed */}\r\n\r\n                    <DialogFooter className=\"gap-2 pt-4\">\r\n                        <Button type=\"button\" variant=\"outline\" onClick={onClose}>\r\n                            Annuler\r\n                        </Button>\r\n                        <Button\r\n                            type=\"submit\"\r\n                            className=\"bg-[#d61353] hover:bg-[#b01044]\"\r\n                            disabled={formik.isSubmitting}\r\n                        >\r\n                            {formik.isSubmitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                            Créer Prestataire\r\n                        </Button>\r\n                    </DialogFooter>\r\n\r\n                </form>\r\n            </DialogContent>\r\n        </Dialog>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\campagnes\\UpdateCampaignPhotoModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'captureMode' is assigned a value but never used.","line":40,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":40,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":177,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":177,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5939,5942],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5939,5942],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":258,"column":33,"nodeType":"JSXOpeningElement","endLine":258,"endColumn":112}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useRef, useEffect } from \"react\";\r\nimport { useAuth } from \"@/app/context/AuthContext\";\r\nimport { toast } from \"react-toastify\";\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogFooter\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Camera, Upload, X, Image as ImageIcon, RotateCcw, Save } from \"lucide-react\";\r\n\r\ninterface Props {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    campagneId: string;\r\n    prestataireId: string;\r\n    initialPhotoUrl?: string | null;\r\n    onPhotoUpdated: () => void;\r\n}\r\n\r\ntype CaptureMode = 'FILE' | 'CAMERA';\r\n\r\nexport default function UpdateCampaignPhotoModal({\r\n    isOpen,\r\n    onClose,\r\n    campagneId,\r\n    prestataireId,\r\n    initialPhotoUrl,\r\n    onPhotoUpdated\r\n}: Props) {\r\n    const { apiClient } = useAuth();\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    // Photo State\r\n    const [captureMode, setCaptureMode] = useState<CaptureMode>('FILE');\r\n    const [selectedFile, setSelectedFile] = useState<File | null>(null);\r\n    const [previewUrl, setPreviewUrl] = useState<string | null>(initialPhotoUrl || null);\r\n    const [isCameraActive, setIsCameraActive] = useState(false);\r\n\r\n    // Camera Refs\r\n    const videoRef = useRef<HTMLVideoElement>(null);\r\n    const canvasRef = useRef<HTMLCanvasElement>(null);\r\n    const streamRef = useRef<MediaStream | null>(null);\r\n    const nativeCameraInputRef = useRef<HTMLInputElement>(null);\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            setPreviewUrl(initialPhotoUrl || null);\r\n            setSelectedFile(null);\r\n            setCaptureMode('FILE');\r\n        } else {\r\n            stopCamera();\r\n        }\r\n        return () => stopCamera();\r\n    }, [isOpen, initialPhotoUrl]);\r\n\r\n    // --- Camera Logic ---\r\n    const startCamera = async () => {\r\n        // Fallback immédiat si pas de support mediaDevices (ex: HTTP sur mobile)\r\n        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\r\n            console.warn(\"Camera API not available, falling back to native input\");\r\n            nativeCameraInputRef.current?.click();\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const stream = await navigator.mediaDevices.getUserMedia({\r\n                video: { facingMode: \"environment\" }\r\n            });\r\n            streamRef.current = stream;\r\n            if (videoRef.current) {\r\n                videoRef.current.srcObject = stream;\r\n            }\r\n            setIsCameraActive(true);\r\n        } catch (err) {\r\n            console.error(\"Camera error or permission denied:\", err);\r\n            // Fallback automatique vers l'input natif en cas d'erreur\r\n            toast.info(\"Caméra inapprochable, ouverture de l'appareil photo natif...\");\r\n            nativeCameraInputRef.current?.click();\r\n        }\r\n    };\r\n\r\n    const stopCamera = () => {\r\n        if (streamRef.current) {\r\n            streamRef.current.getTracks().forEach(track => track.stop());\r\n            streamRef.current = null;\r\n        }\r\n        setIsCameraActive(false);\r\n    };\r\n\r\n    const capturePhoto = () => {\r\n        if (videoRef.current && canvasRef.current) {\r\n            const video = videoRef.current;\r\n            const canvas = canvasRef.current;\r\n            canvas.width = video.videoWidth;\r\n            canvas.height = video.videoHeight;\r\n            const ctx = canvas.getContext('2d');\r\n            if (ctx) {\r\n                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);\r\n                canvas.toBlob((blob) => {\r\n                    if (blob) {\r\n                        const file = new File([blob], \"capture.jpg\", { type: \"image/jpeg\" });\r\n                        handleFileSelection(file);\r\n                        stopCamera();\r\n                    }\r\n                }, 'image/jpeg', 0.8);\r\n            }\r\n        }\r\n    };\r\n\r\n    // --- File Logic ---\r\n    const handleFileSelection = (file: File) => {\r\n        setSelectedFile(file);\r\n        const url = URL.createObjectURL(file);\r\n        setPreviewUrl(url);\r\n    };\r\n\r\n    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (e.target.files?.[0]) {\r\n            handleFileSelection(e.target.files[0]);\r\n        }\r\n    };\r\n\r\n    const resetPhoto = () => {\r\n        setSelectedFile(null);\r\n        setPreviewUrl(null);\r\n        stopCamera();\r\n        setCaptureMode('FILE');\r\n    };\r\n\r\n    // --- Submit ---\r\n    const handleSubmit = async () => {\r\n        if (!selectedFile && !previewUrl) {\r\n            toast.warning(\"Aucune photo sélectionnée.\");\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        try {\r\n            let finalPhotoUrl = previewUrl;\r\n\r\n            // 1. Upload if new file\r\n            if (selectedFile) {\r\n                const formData = new FormData();\r\n                formData.append(\"file\", selectedFile);\r\n\r\n                const uploadRes = await apiClient(\"/api/campagnes/upload\", {\r\n                    method: \"POST\",\r\n                    body: formData,\r\n                });\r\n\r\n                if (!uploadRes.ok) throw new Error(\"Erreur upload photo\");\r\n                const uploadJson = await uploadRes.json();\r\n                finalPhotoUrl = uploadJson.url;\r\n            }\r\n\r\n            // 2. Update Assignment\r\n            const res = await apiClient(`/api/campagnes/${campagneId}/prestataires/${prestataireId}`, {\r\n                method: \"PUT\",\r\n                headers: { \"Content-Type\": \"application/json\" },\r\n                body: JSON.stringify({\r\n                    image_affiche: finalPhotoUrl\r\n                })\r\n            });\r\n\r\n            if (!res.ok) throw new Error(\"Erreur mise à jour campagne\");\r\n\r\n            toast.success(\"Photo enregistrée avec succès !\");\r\n            onPhotoUpdated();\r\n            onClose();\r\n\r\n        } catch (err: any) {\r\n            console.error(err);\r\n            toast.error(err.message || \"Une erreur est survenue\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\r\n            <DialogContent className=\"sm:max-w-md\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"flex items-center gap-2\">\r\n                        <Camera className=\"w-5 h-5\" />\r\n                        Photo de campagne\r\n                    </DialogTitle>\r\n                </DialogHeader>\r\n\r\n                <div className=\"space-y-4 py-4\">\r\n                    <Label>Photo du panneau installé</Label>\r\n\r\n                    <div className=\"border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 overflow-hidden flex flex-col relative min-h-[300px]\">\r\n                        {!previewUrl && !isCameraActive && (\r\n                            <div className=\"absolute inset-0 flex flex-col items-center justify-center p-6 text-center\">\r\n                                <ImageIcon className=\"w-12 h-12 text-gray-300 mb-3\" />\r\n                                <div className=\"flex gap-3\">\r\n                                    <button\r\n                                        type=\"button\"\r\n                                        onClick={() => document.getElementById('campagne-photo-upload')?.click()}\r\n                                        className=\"flex items-center gap-2 px-4 py-2 bg-white border shadow-sm rounded-lg hover:bg-gray-50 text-sm font-medium transition\"\r\n                                    >\r\n                                        <Upload size={16} />\r\n                                        Importer\r\n                                    </button>\r\n                                    <input\r\n                                        id=\"campagne-photo-upload\"\r\n                                        type=\"file\"\r\n                                        accept=\"image/*\"\r\n                                        className=\"hidden\"\r\n                                        onChange={handleFileChange}\r\n                                    />\r\n                                    <input\r\n                                        ref={nativeCameraInputRef}\r\n                                        type=\"file\"\r\n                                        accept=\"image/*\"\r\n                                        capture=\"environment\"\r\n                                        className=\"hidden\"\r\n                                        onChange={handleFileChange}\r\n                                    />\r\n                                    <button\r\n                                        type=\"button\"\r\n                                        onClick={() => {\r\n                                            setCaptureMode('CAMERA');\r\n                                            startCamera();\r\n                                        }}\r\n                                        className=\"flex items-center gap-2 px-4 py-2 bg-black text-white shadow-sm rounded-lg hover:bg-gray-800 text-sm font-medium transition\"\r\n                                    >\r\n                                        <Camera size={16} />\r\n                                        Camera\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Camera */}\r\n                        <div className={`flex-1 relative bg-black ${isCameraActive ? 'block' : 'hidden'}`}>\r\n                            <video ref={videoRef} autoPlay playsInline muted className=\"w-full h-full object-cover\" />\r\n                            <canvas ref={canvasRef} className=\"hidden\" />\r\n                            <div className=\"absolute bottom-4 left-0 right-0 flex justify-center gap-4\">\r\n                                <button type=\"button\" onClick={stopCamera} className=\"p-3 bg-white/20 backdrop-blur-md rounded-full text-white hover:bg-white/30\">\r\n                                    <X size={24} />\r\n                                </button>\r\n                                <button type=\"button\" onClick={capturePhoto} className=\"p-4 bg-white rounded-full text-black shadow-lg hover:scale-105 transition\">\r\n                                    <Camera size={28} />\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Preview */}\r\n                        {previewUrl && !isCameraActive && (\r\n                            <div className=\"absolute inset-0 bg-black\">\r\n                                <img src={previewUrl} alt=\"Preview\" className=\"w-full h-full object-contain\" />\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={resetPhoto}\r\n                                    className=\"absolute top-2 right-2 p-2 bg-black/50 text-white rounded-full hover:bg-black/70 backdrop-blur-sm\"\r\n                                >\r\n                                    <RotateCcw size={20} />\r\n                                </button>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                <DialogFooter>\r\n                    <Button variant=\"outline\" onClick={onClose} disabled={loading}>\r\n                        Annuler\r\n                    </Button>\r\n                    <Button onClick={handleSubmit} disabled={loading} className=\"bg-blue-600 hover:bg-blue-700 text-white\">\r\n                        {loading ? \"Enregistrement...\" : (\r\n                            <>\r\n                                <Save className=\"w-4 h-4 mr-2\" />\r\n                                Enregistrer\r\n                            </>\r\n                        )}\r\n                    </Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\campagnes\\VerificationMaterielleModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":26,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[748,751],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[748,751],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[798,801],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[798,801],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[862,865],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[862,865],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[926,929],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[926,929],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadData' and 'loadPrestataires'. Either include them or remove the dependency array.","line":56,"column":6,"nodeType":"ArrayExpression","endLine":56,"endColumn":29,"suggestions":[{"desc":"Update the dependencies array to be: [campagneId, apiClient, loadData, loadPrestataires]","fix":{"range":[1946,1969],"text":"[campagneId, apiClient, loadData, loadPrestataires]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":310,"column":27,"nodeType":"JSXOpeningElement","endLine":310,"endColumn":107},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":365,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":365,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13178,13181],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13178,13181],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":501,"column":25,"nodeType":"JSXOpeningElement","endLine":501,"endColumn":104}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState, useRef } from \"react\";\r\nimport { useAuth } from \"@/app/context/AuthContext\";\r\nimport { Camera, Upload, X, Check, Image as ImageIcon, RotateCcw } from \"lucide-react\";\r\n\r\ninterface Props {\r\n  campagneId: string;\r\n  initialPrestataireId?: string;\r\n  onClose: () => void;\r\n}\r\n\r\ntype Mode = 'LIST' | 'CREATE';\r\ntype CaptureMode = 'FILE' | 'CAMERA';\r\n\r\nexport default function VerificationMaterielleModal({\r\n  campagneId,\r\n  initialPrestataireId,\r\n  onClose,\r\n}: Props) {\r\n  const { apiClient } = useAuth();\r\n  const [mode, setMode] = useState<Mode>(initialPrestataireId ? 'CREATE' : 'LIST');\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  // Data State\r\n  const [materiels, setMateriels] = useState<any[]>([]);\r\n  const [stats, setStats] = useState<any>(null);\r\n  const [campagneInfo, setCampagneInfo] = useState<any>(null);\r\n  const [prestataires, setPrestataires] = useState<any[]>([]);\r\n\r\n  // Form State\r\n  const [submitting, setSubmitting] = useState(false);\r\n  const [selectedPrestataire, setSelectedPrestataire] = useState(initialPrestataireId || \"\");\r\n  const [nomMateriel, setNomMateriel] = useState(\"\");\r\n  const [etat, setEtat] = useState<\"BON\" | \"MOYEN\" | \"MAUVAIS\">(\"BON\");\r\n  const [description, setDescription] = useState(\"\");\r\n\r\n  // Photo Capture State\r\n  const [captureMode, setCaptureMode] = useState<CaptureMode>('FILE');\r\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\r\n  const [previewUrl, setPreviewUrl] = useState<string | null>(null);\r\n  const [isCameraActive, setIsCameraActive] = useState(false);\r\n\r\n  const videoRef = useRef<HTMLVideoElement>(null);\r\n  const canvasRef = useRef<HTMLCanvasElement>(null);\r\n  const streamRef = useRef<MediaStream | null>(null);\r\n  const nativeCameraInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  useEffect(() => {\r\n    loadData();\r\n    loadPrestataires();\r\n\r\n    return () => {\r\n      stopCamera();\r\n    };\r\n  }, [campagneId, apiClient]);\r\n\r\n  async function loadData() {\r\n    try {\r\n      setLoading(true);\r\n      const res = await apiClient(`/api/campagnes/${campagneId}/materiels-cases`);\r\n      const json = await res.json();\r\n\r\n      if (!res.ok) {\r\n        console.error(\"Erreur API :\", json);\r\n        return;\r\n      }\r\n\r\n      setMateriels(json.materiels_cases);\r\n      setStats(json.statistiques);\r\n      setCampagneInfo(json.campagne);\r\n    } catch (err) {\r\n      console.error(\"Erreur réseau :\", err);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function loadPrestataires() {\r\n    try {\r\n      const res = await apiClient(`/api/campagnes/${campagneId}/prestataires`);\r\n      const json = await res.json();\r\n      if (res.ok) {\r\n        setPrestataires(json.affectations || []);\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Erreur chargement prestataires :\", err);\r\n    }\r\n  }\r\n\r\n  // --- Camera Logic ---\r\n  const startCamera = async () => {\r\n    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\r\n      console.warn(\"Camera API not available, falling back to native input\");\r\n      nativeCameraInputRef.current?.click();\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const stream = await navigator.mediaDevices.getUserMedia({\r\n        video: { facingMode: \"environment\" }\r\n      });\r\n      streamRef.current = stream;\r\n      if (videoRef.current) {\r\n        videoRef.current.srcObject = stream;\r\n      }\r\n      setIsCameraActive(true);\r\n    } catch (err) {\r\n      console.error(\"Impossible d'accéder à la caméra\", err);\r\n      // Fallback\r\n      nativeCameraInputRef.current?.click();\r\n    }\r\n  };\r\n\r\n  const stopCamera = () => {\r\n    if (streamRef.current) {\r\n      streamRef.current.getTracks().forEach(track => track.stop());\r\n      streamRef.current = null;\r\n    }\r\n    setIsCameraActive(false);\r\n  };\r\n\r\n  const capturePhoto = () => {\r\n    if (videoRef.current && canvasRef.current) {\r\n      const video = videoRef.current;\r\n      const canvas = canvasRef.current;\r\n\r\n      canvas.width = video.videoWidth;\r\n      canvas.height = video.videoHeight;\r\n\r\n      const ctx = canvas.getContext('2d');\r\n      if (ctx) {\r\n        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);\r\n\r\n        canvas.toBlob((blob) => {\r\n          if (blob) {\r\n            const file = new File([blob], \"capture.jpg\", { type: \"image/jpeg\" });\r\n            handleFileSelection(file);\r\n            stopCamera();\r\n          }\r\n        }, 'image/jpeg', 0.8);\r\n      }\r\n    }\r\n  };\r\n\r\n  // --- File Handling ---\r\n  const handleFileSelection = (file: File) => {\r\n    setSelectedFile(file);\r\n    const url = URL.createObjectURL(file);\r\n    setPreviewUrl(url);\r\n  };\r\n\r\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    if (e.target.files && e.target.files[0]) {\r\n      handleFileSelection(e.target.files[0]);\r\n    }\r\n  };\r\n\r\n  const handleResetPhoto = () => {\r\n    setSelectedFile(null);\r\n    setPreviewUrl(null);\r\n    if (captureMode === 'CAMERA') {\r\n      startCamera();\r\n    }\r\n  };\r\n\r\n  // --- Submission ---\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!selectedPrestataire || !nomMateriel) {\r\n      alert(\"Veuillez remplir tous les champs obligatoires.\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setSubmitting(true);\r\n      let photoUrl = \"\";\r\n\r\n      // 1. Upload Photo if exists\r\n      if (selectedFile) {\r\n        const formData = new FormData();\r\n        formData.append(\"file\", selectedFile);\r\n\r\n        const uploadRes = await apiClient(\"/api/materiels-cases/upload\", {\r\n          method: \"POST\",\r\n          body: formData,\r\n        });\r\n\r\n        if (!uploadRes.ok) {\r\n          throw new Error(\"Erreur lors de l'upload de l'image\");\r\n        }\r\n\r\n        const uploadJson = await uploadRes.json();\r\n        photoUrl = uploadJson.url;\r\n      }\r\n\r\n      // 2. Create Record\r\n      const payload = {\r\n        id_campagne: campagneId,\r\n        id_prestataire: selectedPrestataire,\r\n        nom_materiel: nomMateriel,\r\n        etat,\r\n        description,\r\n        photo_url: photoUrl\r\n      };\r\n\r\n      const res = await apiClient(\"/api/materiels-cases\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(payload),\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const err = await res.json();\r\n        console.error(err);\r\n        alert(`Erreur: ${err.message || \"Impossible d'enregistrer\"}`);\r\n        return;\r\n      }\r\n\r\n      // Success\r\n      setMode('LIST');\r\n      resetForm();\r\n      loadData(); // Refresh list\r\n\r\n    } catch (err) {\r\n      console.error(\"Erreur soumission:\", err);\r\n      alert(\"Une erreur est survenue lors de l'enregistrement.\");\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const resetForm = () => {\r\n    setSelectedPrestataire(\"\");\r\n    setNomMateriel(\"\");\r\n    setEtat(\"BON\");\r\n    setDescription(\"\");\r\n    setSelectedFile(null);\r\n    setPreviewUrl(null);\r\n    stopCamera();\r\n  };\r\n\r\n  if (loading && mode === 'LIST' && materiels.length === 0) {\r\n    return (\r\n      <div className=\"fixed inset-0 flex items-center justify-center bg-black/50 z-50\">\r\n        <div className=\"bg-white p-6 rounded-xl shadow-lg\">Chargement...</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\r\n      <div className=\"bg-white w-full max-w-4xl max-h-[90vh] rounded-xl flex flex-col relative overflow-hidden\">\r\n\r\n        {/* Header */}\r\n        <div className=\"p-4 border-b flex justify-between items-center bg-gray-50\">\r\n          <h2 className=\"text-xl font-bold text-gray-800\">\r\n            {mode === 'LIST'\r\n              ? `Vérification du matériel – ${campagneInfo?.nom_campagne || ''}`\r\n              : \"Nouvelle Vérification\"\r\n            }\r\n          </h2>\r\n          <button onClick={onClose} className=\"p-2 hover:bg-gray-200 rounded-full transition\">\r\n            <X size={24} className=\"text-gray-600\" />\r\n          </button>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"flex-1 overflow-y-auto p-6\">\r\n\r\n          {mode === 'LIST' ? (\r\n            <>\r\n              {/* Stats & Actions */}\r\n              <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4\">\r\n                <div className=\"flex gap-4 w-full md:w-auto overflow-x-auto pb-2 md:pb-0\">\r\n                  {stats && (\r\n                    <>\r\n                      <div className=\"bg-blue-50 px-4 py-2 rounded-lg border border-blue-100 min-w-[100px]\">\r\n                        <p className=\"text-xs text-uppercase text-blue-600 font-semibold\">Total</p>\r\n                        <p className=\"text-2xl font-bold text-blue-800\">{stats.total}</p>\r\n                      </div>\r\n                      <div className=\"bg-red-50 px-4 py-2 rounded-lg border border-red-100 min-w-[100px]\">\r\n                        <p className=\"text-xs text-uppercase text-red-600 font-semibold\">Mauvais</p>\r\n                        <p className=\"text-2xl font-bold text-red-800\">{stats.etat_mauvais}</p>\r\n                      </div>\r\n                    </>\r\n                  )}\r\n                </div>\r\n\r\n                <button\r\n                  onClick={() => setMode('CREATE')}\r\n                  className=\"bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition shadow-sm whitespace-nowrap\"\r\n                >\r\n                  + Nouvelle Vérification\r\n                </button>\r\n              </div>\r\n\r\n              {/* List */}\r\n              <div className=\"space-y-3\">\r\n                {materiels.length === 0 ? (\r\n                  <div className=\"text-center py-10 bg-gray-50 rounded-lg border border-dashed border-gray-300\">\r\n                    <p className=\"text-gray-500\">Aucun matériel vérifié pour le moment.</p>\r\n                  </div>\r\n                ) : (\r\n                  materiels.map((item, index) => (\r\n                    <div key={index} className=\"border rounded-lg p-4 hover:shadow-sm transition bg-white flex flex-col md:flex-row gap-4\">\r\n                      {/* Image Thumbnail */}\r\n                      <div className=\"w-full md:w-24 h-24 bg-gray-100 rounded-lg flex-shrink-0 overflow-hidden border\">\r\n                        {item.photo_url ? (\r\n                          <img src={item.photo_url} alt=\"Preuve\" className=\"w-full h-full object-cover\" />\r\n                        ) : (\r\n                          <div className=\"w-full h-full flex items-center justify-center text-gray-400\">\r\n                            <ImageIcon size={24} />\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n\r\n                      <div className=\"flex-1\">\r\n                        <div className=\"flex justify-between items-start\">\r\n                          <div>\r\n                            <h3 className=\"font-semibold text-gray-900\">{item.nom_materiel}</h3>\r\n                            <p className=\"text-sm text-gray-500 mt-1\">\r\n                              {item.prestataire?.nom} {item.prestataire?.prenom}\r\n                              <span className=\"mx-2\">•</span>\r\n                              {item.prestataire?.plaque || 'Sans plaque'}\r\n                            </p>\r\n                          </div>\r\n                          <span className={`px-3 py-1 rounded-full text-xs font-medium ${item.etat === 'BON' ? 'bg-green-100 text-green-700' :\r\n                            item.etat === 'MOYEN' ? 'bg-yellow-100 text-yellow-700' :\r\n                              'bg-red-100 text-red-700'\r\n                            }`}>\r\n                            {item.etat}\r\n                          </span>\r\n                        </div>\r\n                        <p className=\"text-sm text-gray-600 mt-2 bg-gray-50 p-2 rounded\">\r\n                          {item.description || \"Aucune observation.\"}\r\n                        </p>\r\n                        {item.penalite_appliquer && (\r\n                          <p className=\"text-xs text-red-600 font-medium mt-1\">\r\n                            Pénalité: {item.montant_penalite.toLocaleString()} FCFA\r\n                          </p>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  ))\r\n                )}\r\n              </div>\r\n            </>\r\n          ) : (\r\n            // --- CREATE FORM ---\r\n            <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n\r\n              <div className=\"grid md:grid-cols-2 gap-6\">\r\n                {/* Left Column: Details */}\r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">Prestataire</label>\r\n                    <select\r\n                      required\r\n                      value={selectedPrestataire}\r\n                      onChange={(e) => setSelectedPrestataire(e.target.value)}\r\n                      className=\"w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-black focus:border-black outline-none bg-white\"\r\n                    >\r\n                      <option value=\"\">Sélectionner un prestataire</option>\r\n                      {prestataires?.map((p: any) => (\r\n                        <option key={p.prestataire.id_prestataire} value={p.prestataire.id_prestataire}>\r\n                          {p.prestataire.nom} {p.prestataire.prenom} ({p.prestataire.plaque || 'Sans plaque'})\r\n                        </option>\r\n                      ))}\r\n                    </select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">Nom du Matériel</label>\r\n                    <input\r\n                      type=\"text\"\r\n                      required\r\n                      placeholder=\"Ex: Panneau Publicitaire G12\"\r\n                      value={nomMateriel}\r\n                      onChange={(e) => setNomMateriel(e.target.value)}\r\n                      className=\"w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-black focus:border-black outline-none\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">État constaté</label>\r\n                    <div className=\"grid grid-cols-3 gap-2\">\r\n                      {(['BON', 'MOYEN', 'MAUVAIS'] as const).map((e) => (\r\n                        <button\r\n                          key={e}\r\n                          type=\"button\"\r\n                          onClick={() => setEtat(e)}\r\n                          className={`py-2 rounded-lg text-sm font-medium border transition ${etat === e\r\n                            ? (e === 'BON' ? 'bg-green-100 border-green-300 text-green-800 ring-2 ring-green-500' :\r\n                              e === 'MOYEN' ? 'bg-yellow-100 border-yellow-300 text-yellow-800 ring-2 ring-yellow-500' :\r\n                                'bg-red-100 border-red-300 text-red-800 ring-2 ring-red-500')\r\n                            : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-50'\r\n                            }`}\r\n                        >\r\n                          {e}\r\n                        </button>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">Observations</label>\r\n                    <textarea\r\n                      rows={3}\r\n                      value={description}\r\n                      onChange={(e) => setDescription(e.target.value)}\r\n                      className=\"w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-black focus:border-black outline-none resize-none\"\r\n                      placeholder=\"Détails supplémentaires...\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Right Column: Photo Evidence */}\r\n                <div className=\"flex flex-col\">\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">Preuve Photo</label>\r\n\r\n                  <div className=\"flex-1 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 overflow-hidden flex flex-col relative min-h-[300px]\">\r\n\r\n                    {!previewUrl && !isCameraActive && (\r\n                      <div className=\"absolute inset-0 flex flex-col items-center justify-center p-6 text-center\">\r\n                        <ImageIcon className=\"w-12 h-12 text-gray-300 mb-3\" />\r\n                        <p className=\"text-gray-500 text-sm mb-4\">Ajoutez une photo pour valider l&apos;état</p>\r\n\r\n                        <div className=\"flex gap-3\">\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => document.getElementById('file-upload')?.click()}\r\n                            className=\"flex items-center gap-2 px-4 py-2 bg-white border shadow-sm rounded-lg hover:bg-gray-50 text-sm font-medium transition\"\r\n                          >\r\n                            <Upload size={16} />\r\n                            Importer\r\n                          </button>\r\n                          <input\r\n                            id=\"file-upload\"\r\n                            type=\"file\"\r\n                            accept=\"image/*\"\r\n                            className=\"hidden\"\r\n                            onChange={handleFileChange}\r\n                          />\r\n                          <input\r\n                            ref={nativeCameraInputRef}\r\n                            type=\"file\"\r\n                            accept=\"image/*\"\r\n                            capture=\"environment\"\r\n                            className=\"hidden\"\r\n                            onChange={handleFileChange}\r\n                          />\r\n\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => {\r\n                              setCaptureMode('CAMERA');\r\n                              startCamera();\r\n                            }}\r\n                            className=\"flex items-center gap-2 px-4 py-2 bg-black text-white shadow-sm rounded-lg hover:bg-gray-800 text-sm font-medium transition\"\r\n                          >\r\n                            <Camera size={16} />\r\n                            Prendre Photo\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                    )}\r\n\r\n                    {/* Camera View */}\r\n                    <div className={`flex-1 relative bg-black ${isCameraActive ? 'block' : 'hidden'}`}>\r\n                      <video\r\n                        ref={videoRef}\r\n                        autoPlay\r\n                        playsInline\r\n                        muted\r\n                        className=\"w-full h-full object-cover\"\r\n                      />\r\n                      <canvas ref={canvasRef} className=\"hidden\" />\r\n\r\n                      <div className=\"absolute bottom-4 left-0 right-0 flex justify-center gap-4\">\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={stopCamera}\r\n                          className=\"p-3 bg-white/20 backdrop-blur-md rounded-full text-white hover:bg-white/30\"\r\n                        >\r\n                          <X size={24} />\r\n                        </button>\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={capturePhoto}\r\n                          className=\"p-4 bg-white rounded-full text-black shadow-lg hover:scale-105 transition\"\r\n                        >\r\n                          <Camera size={28} />\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* Photo Preview */}\r\n                    {previewUrl && !isCameraActive && (\r\n                      <div className=\"absolute inset-0 bg-black\">\r\n                        <img src={previewUrl} alt=\"Preview\" className=\"w-full h-full object-contain\" />\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={handleResetPhoto}\r\n                          className=\"absolute top-2 right-2 p-2 bg-black/50 text-white rounded-full hover:bg-black/70 backdrop-blur-sm\"\r\n                        >\r\n                          <RotateCcw size={20} />\r\n                        </button>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Footer Actions */}\r\n              <div className=\"flex justify-end gap-3 pt-4 border-t mt-4\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => {\r\n                    setMode('LIST');\r\n                    resetForm();\r\n                  }}\r\n                  className=\"px-5 py-2.5 text-gray-700 font-medium hover:bg-gray-100 rounded-lg transition\"\r\n                >\r\n                  Annuler\r\n                </button>\r\n                <button\r\n                  type=\"submit\"\r\n                  disabled={submitting}\r\n                  className=\"px-5 py-2.5 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition shadow-sm flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {submitting ? 'Enregistrement...' : (\r\n                    <>\r\n                      <Check size={18} />\r\n                      Valider la vérification\r\n                    </>\r\n                  )}\r\n                </button>\r\n              </div>\r\n\r\n            </form>\r\n          )}\r\n\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\clients\\AddClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\clients\\ClientTable.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":60,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":60,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Plus, Pencil, Trash2, User, Search, Eye } from \"lucide-react\";\r\nimport AddClientModal from \"@/components/clients/AddClient\";\r\nimport EditClientModal from \"@/components/clients/EditClient\";\r\nimport DeleteClientModal from \"@/components/clients/DeleteClient\";\r\nimport { toast } from \"react-toastify\";\r\nimport { useAuth } from \"@/app/context/AuthContext\";\r\nimport { Paginate } from \"../Paginate\";\r\n\r\nimport { useSearchParams, useRouter } from \"next/navigation\";\r\nimport { Input } from \"@/components/ui/input\"\r\n\r\ntype Client = {\r\n  id_client: string;\r\n  nom?: string | null;\r\n  prenom?: string | null;\r\n  entreprise?: string | null;\r\n  domaine_entreprise?: string | null;\r\n  adresse?: string | null;\r\n  contact?: string | null;\r\n  mail?: string | null;\r\n  type_client?: string | null;\r\n  created_at: string;\r\n  updated_at?: string | null;\r\n};\r\n\r\nconst formatDate = (iso?: string | null) => {\r\n  if (!iso) return \"-\";\r\n  const d = new Date(iso);\r\n  return `${String(d.getDate()).padStart(2, \"0\")}/${String(\r\n    d.getMonth() + 1\r\n  ).padStart(2, \"0\")}/${d.getFullYear()}`;\r\n};\r\n\r\nexport default function ClientTable() {\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const { apiClient } = useAuth()\r\n  const [clients, setClients] = useState<Client[]>([]);\r\n  const [searchQuery, setSearchQuery] = useState(\"\")\r\n  const router = useRouter();\r\n\r\n  const searchParam = useSearchParams();\r\n  const page = parseInt(searchParam?.get(\"page\") || \"1\");\r\n  const [totalPages, setTotalPages] = useState(1);\r\n\r\n  useEffect(() => {\r\n    const fetchClients = async () => {\r\n      setLoading(true);\r\n      try {\r\n        const res = await apiClient(`/api/clients?page=${page}&limit=7`);\r\n\r\n        if (!res.ok) throw new Error(\"Erreur lors du chargement des clients\");\r\n\r\n        const data = await res.json();\r\n        setClients(Array.isArray(data) ? data : data?.clients || []);\r\n        setTotalPages(data?.pagination?.totalPages || 1);\r\n      } catch (e) {\r\n        setError(\"Impossible de charger les clients\");\r\n        toast.error(\"Impossible de charger les clients\");\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchClients();\r\n  }, [apiClient, page]);\r\n\r\n  const handleAddClient = async (newUser: Client) => {\r\n    try {\r\n      const res = await apiClient(\"/api/clients\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(newUser),\r\n      })\r\n      if (!res.ok) throw new Error(\"Erreur lors de l'ajout\")\r\n      const created = await res.json()\r\n      setClients((prev) => [...prev, created])\r\n      toast.success(\"Client ajouté avec succès\")\r\n    } catch {\r\n      toast.error(\"Erreur lors de l'ajout du client\")\r\n    }\r\n  }\r\n\r\n  const [isAddOpen, setIsAddOpen] = useState(false);\r\n  const [isEditOpen, setIsEditOpen] = useState(false);\r\n  const [isDeleteOpen, setIsDeleteOpen] = useState(false);\r\n  const [clientToEdit, setClientToEdit] = useState<Client | null>(null);\r\n  const [clientToDelete, setClientToDelete] = useState<Client | null>(null);\r\n\r\n\r\n  const handleEditClient = async (updatedClient: Client) => {\r\n    try {\r\n      const res = await apiClient(`/api/clients/${updatedClient.id_client}`, {\r\n        method: \"PUT\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(updatedClient),\r\n      })\r\n      if (!res.ok) throw new Error(\"Erreur lors de la modification\")\r\n      const client = await res.json()\r\n      setClients((prev) => prev.map((c) => (c.id_client === client.id_client ? client : c)))\r\n      toast.success(\"Utilisateur modifié avec succès\")\r\n    } catch {\r\n      toast.error(\"Erreur lors de la modification de l'utilisateur\")\r\n    }\r\n  }\r\n\r\n\r\n  const confirmDeleteClient = async (client: Client) => {\r\n    if (clientToDelete) {\r\n      try {\r\n        const res = await apiClient(`/api/clients/${client.id_client}`, {\r\n          method: \"DELETE\",\r\n        })\r\n        if (!res.ok) throw new Error(\"Erreur lors de la suppression\")\r\n        setClients((prev) => prev.filter((c) => c.id_client !== clientToDelete.id_client))\r\n        toast.success(\"Client supprimé avec succès\")\r\n\r\n\r\n      } catch {\r\n        toast.error(\"Erreur lors de la suppression de lu client\")\r\n      } finally {\r\n        setClientToDelete(null)\r\n        setIsDeleteOpen(false)\r\n      }\r\n    }\r\n  }\r\n\r\n  const filteredClients = clients.filter((c) => {\r\n    const search = searchQuery.toLowerCase()\r\n    return (\r\n      (c.nom || \"\").toLowerCase().includes(search) ||\r\n      (c.prenom || \"\").toLowerCase().includes(search) ||\r\n      (c.entreprise || \"\").toLowerCase().includes(search) ||\r\n      (c.mail || \"\").toLowerCase().includes(search)\r\n    )\r\n  })\r\n\r\n  return (\r\n    <div className=\"p-6 text-gray-900 dark:text-white\">\r\n      <div className=\"flex flex-col sm:flex-row items-center justify-between mb-6 bg-white dark:bg-gray-900 p-4 rounded-2xl shadow-md border border-gray-100 dark:border-gray-800\">\r\n        <div className=\"flex items-center gap-3 text-[#d61353]\">\r\n          <User className=\"w-6 h-6\" />\r\n          <h1 className=\"text-xl sm:text-2xl font-bold\">Gestion des clients</h1>\r\n        </div>\r\n\r\n        <button\r\n          onClick={() => setIsAddOpen(true)}\r\n          className=\"flex items-center gap-2 bg-[#d61353] hover:bg-[#b01044] text-white px-4 py-2 rounded-lg shadow transition\"\r\n        >\r\n          <Plus className=\"w-5 h-5\" />\r\n          <span>Ajouter un client</span>\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"flex justify-end mb-4\">\r\n        <div className=\"relative w-full md:w-72\">\r\n          <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500\" />\r\n          <Input\r\n            placeholder=\"Rechercher...\"\r\n            value={searchQuery}\r\n            onChange={(e) => setSearchQuery(e.target.value)}\r\n            className=\"pl-9 bg-white dark:bg-gray-800\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"overflow-x-auto bg-white dark:bg-gray-900 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-800\">\r\n        {loading ? (\r\n          <div className=\"flex flex-col items-center justify-center py-10\">\r\n            <div className=\"w-10 h-10 border-4 border-[#d61353]/30 border-t-[#d61353] rounded-full animate-spin\"></div>\r\n            <p className=\"mt-3 text-gray-600 dark:text-gray-300 font-medium\">\r\n              Chargement des clients...\r\n            </p>\r\n          </div>\r\n        ) : error ? (\r\n\r\n          <div className=\"text-center text-red-500 py-8\">{error}</div>\r\n        ) : clients.length === 0 ? (\r\n          <div className=\"text-center py-8 text-gray-500\">Aucun client trouvé</div>\r\n        ) : (\r\n          <div>\r\n            <table className=\"min-w-full text-sm border-collapse\">\r\n              <thead>\r\n                <tr className=\"bg-gray-50 dark:bg-gray-800 text-left text-gray-700 dark:text-gray-300 uppercase text-xs tracking-wider\">\r\n                  <th className=\"px-6 py-3\">Client</th>\r\n                  <th className=\"px-6 py-3\">Entreprise / Adresse</th>\r\n                  <th className=\"px-6 py-3\">Email / Contact</th>\r\n                  <th className=\"px-6 py-3\">Domaine / Type</th>\r\n                  <th className=\"px-6 py-3\">Date de création</th>\r\n                  <th className=\"px-6 py-3\">Actions</th>\r\n                </tr>\r\n              </thead>\r\n\r\n              <tbody className=\"divide-y divide-gray-200 dark:divide-gray-700\">\r\n                {!loading && filteredClients.length === 0 && (\r\n                  <tr>\r\n                    <td colSpan={6} className=\"p-4 text-center text-sm text-gray-500\">Aucun client trouvé</td>\r\n                  </tr>\r\n                )}\r\n                {filteredClients.map((c, i) => (\r\n                  <tr\r\n                    key={c.id_client}\r\n                    className={`transition hover:bg-gray-50 dark:hover:bg-gray-800 ${i % 2 === 0\r\n                      ? \"bg-white dark:bg-gray-900\"\r\n                      : \"bg-gray-50 dark:bg-gray-950\"\r\n                      }`}\r\n                  >\r\n                    <td className=\"px-6 py-4 font-medium\">\r\n                      {c.nom} {c.prenom}\r\n                    </td>\r\n\r\n                    <td className=\"px-6 py-4\">\r\n                      <div className=\"font-medium\">{c.entreprise || \"-\"}</div>\r\n                      <div className=\"text-xs text-gray-500\">\r\n                        {c.adresse || \"-\"}\r\n                      </div>\r\n                    </td>\r\n\r\n                    <td className=\"px-6 py-4\">\r\n                      <div className=\"font-medium\">{c.mail || \"-\"}</div>\r\n                      <div className=\"text-xs text-gray-500\">\r\n                        {c.contact || \"-\"}\r\n                      </div>\r\n                    </td>\r\n\r\n                    <td className=\"px-6 py-4\">\r\n                      <div className=\"font-medium\">\r\n                        {c.domaine_entreprise || \"-\"}\r\n                      </div>\r\n                      <div className=\"text-xs text-gray-500\">\r\n                        {c.type_client || \"-\"}\r\n                      </div>\r\n                    </td>\r\n\r\n                    <td className=\"px-6 py-4\">{formatDate(c.created_at)}</td>\r\n\r\n                    <td className=\"px-6 py-4 text-center\">\r\n                      <div className=\"flex justify-center gap-3\">\r\n                        <button\r\n                          onClick={() => router.push(`/dashboard/clients/${c.id_client}`)}\r\n                          className=\"p-2 rounded-lg bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-800 transition\"\r\n                          title=\"Voir détails\"\r\n                        >\r\n                          <Eye className=\"w-4 h-4\" />\r\n                        </button>\r\n                        <button\r\n                          onClick={() => {\r\n                            setClientToEdit(c);\r\n                            setIsEditOpen(true);\r\n                          }}\r\n                          className=\"p-2 rounded-lg bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-800 transition\"\r\n                        >\r\n                          <Pencil className=\"w-4 h-4\" />\r\n                        </button>\r\n\r\n                        <button\r\n                          onClick={() => {\r\n                            setClientToDelete(c);\r\n                            setIsDeleteOpen(true);\r\n                          }}\r\n                          className=\"p-2 rounded-lg bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-800 transition\"\r\n                        >\r\n                          <Trash2 className=\"w-4 h-4\" />\r\n                        </button>\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n            {totalPages > 1 && <Paginate pages={totalPages} currentPage={page} />}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n\r\n\r\n      {/* Modals */}\r\n      <AddClientModal\r\n        isOpen={isAddOpen}\r\n        onClose={() => setIsAddOpen(false)}\r\n        onAddClient={(client) => {\r\n          handleAddClient(client);\r\n          setIsAddOpen(false);\r\n        }}\r\n      />\r\n\r\n      {\r\n        clientToEdit && (\r\n          <EditClientModal\r\n            isOpen={isEditOpen}\r\n            onClose={() => setIsEditOpen(false)}\r\n            client={clientToEdit}\r\n            onEditClient={(c) => {\r\n              handleEditClient(c);\r\n              setIsEditOpen(false);\r\n              setClientToEdit(null);\r\n            }}\r\n          />\r\n        )\r\n      }\r\n\r\n      <DeleteClientModal\r\n        isOpen={isDeleteOpen}\r\n        onClose={() => {\r\n          setIsDeleteOpen(false)\r\n          setClientToDelete(null)\r\n        }}\r\n        onConfirm={() => {\r\n          if (clientToDelete) {\r\n            confirmDeleteClient(clientToDelete)\r\n          }\r\n        }}\r\n      />\r\n    </div >\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\clients\\DeleteClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\clients\\EditClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\common\\NotificationDropdown.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Image' is defined but never used.","line":2,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[695,698],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[695,698],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport Image from \"next/image\";\r\nimport Link from \"next/link\";\r\nimport React, { useState } from \"react\";\r\nimport { Dropdown } from \"@/components/ui/dropdown/Dropdown\";\r\nimport { DropdownItem } from \"@/components/ui/dropdown/DropdownItem\";\r\nimport { useNotifications } from \"@/hooks/useNotifications\";\r\n\r\nexport default function NotificationDropdown() {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const { notifications, unreadCount, loading, markAsRead, markAllAsRead } = useNotifications();\r\n\r\n  function toggleDropdown() {\r\n    setIsOpen(!isOpen);\r\n  }\r\n\r\n  function closeDropdown() {\r\n    setIsOpen(false);\r\n  }\r\n\r\n  const handleNotificationClick = async (notification: any) => {\r\n    if (!notification.is_read) {\r\n      await markAsRead(notification.id_notification);\r\n    }\r\n    closeDropdown();\r\n  };\r\n\r\n  const handleMarkAllRead = async (e: React.MouseEvent) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    await markAllAsRead();\r\n  };\r\n\r\n  // Helper to format time ago (simple version)\r\n  const timeAgo = (dateString: string) => {\r\n    const date = new Date(dateString);\r\n    const now = new Date();\r\n    const seconds = Math.floor((now.getTime() - date.getTime()) / 1000);\r\n\r\n    if (seconds < 60) return 'Just now';\r\n    const minutes = Math.floor(seconds / 60);\r\n    if (minutes < 60) return `${minutes}m ago`;\r\n    const hours = Math.floor(minutes / 60);\r\n    if (hours < 24) return `${hours}h ago`;\r\n    const days = Math.floor(hours / 24);\r\n    return `${days}d ago`;\r\n  };\r\n\r\n  return (\r\n    <div className=\"relative\">\r\n      <button\r\n        className=\"relative dropdown-toggle flex items-center justify-center text-gray-500 transition-colors bg-white border border-gray-200 rounded-full hover:text-gray-700 h-11 w-11 hover:bg-gray-100 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-white\"\r\n        onClick={toggleDropdown}\r\n      >\r\n        <span\r\n          className={`absolute right-0 top-0.5 z-10 h-2 w-2 rounded-full bg-orange-400 ${unreadCount === 0 ? \"hidden\" : \"flex\"\r\n            }`}\r\n        >\r\n          <span className=\"absolute inline-flex w-full h-full bg-orange-400 rounded-full opacity-75 animate-ping\"></span>\r\n        </span>\r\n        <svg\r\n          className=\"fill-current\"\r\n          width=\"20\"\r\n          height=\"20\"\r\n          viewBox=\"0 0 20 20\"\r\n          xmlns=\"http://www.w3.org/2000/svg\"\r\n        >\r\n          <path\r\n            fillRule=\"evenodd\"\r\n            clipRule=\"evenodd\"\r\n            d=\"M10.75 2.29248C10.75 1.87827 10.4143 1.54248 10 1.54248C9.58583 1.54248 9.25004 1.87827 9.25004 2.29248V2.83613C6.08266 3.20733 3.62504 5.9004 3.62504 9.16748V14.4591H3.33337C2.91916 14.4591 2.58337 14.7949 2.58337 15.2091C2.58337 15.6234 2.91916 15.9591 3.33337 15.9591H4.37504H15.625H16.6667C17.0809 15.9591 17.4167 15.6234 17.4167 15.2091C17.4167 14.7949 17.0809 14.4591 16.6667 14.4591H16.375V9.16748C16.375 5.9004 13.9174 3.20733 10.75 2.83613V2.29248ZM14.875 14.4591V9.16748C14.875 6.47509 12.6924 4.29248 10 4.29248C7.30765 4.29248 5.12504 6.47509 5.12504 9.16748V14.4591H14.875ZM8.00004 17.7085C8.00004 18.1228 8.33583 18.4585 8.75004 18.4585H11.25C11.6643 18.4585 12 18.1228 12 17.7085C12 17.2943 11.6643 16.9585 11.25 16.9585H8.75004C8.33583 16.9585 8.00004 17.2943 8.00004 17.7085Z\"\r\n            fill=\"currentColor\"\r\n          />\r\n        </svg>\r\n      </button>\r\n      <Dropdown\r\n        isOpen={isOpen}\r\n        onClose={closeDropdown}\r\n        className=\"absolute -right-[240px] mt-[17px] flex h-[480px] w-[350px] flex-col rounded-2xl border border-gray-200 bg-white p-3 shadow-theme-lg dark:border-gray-800 dark:bg-gray-dark sm:w-[361px] lg:right-0\"\r\n      >\r\n        <div className=\"flex items-center justify-between pb-3 mb-3 border-b border-gray-100 dark:border-gray-700\">\r\n          <h5 className=\"text-lg font-semibold text-gray-800 dark:text-gray-200\">\r\n            Notifications {unreadCount > 0 && `(${unreadCount})`}\r\n          </h5>\r\n          <div className=\"flex items-center gap-2\">\r\n            {unreadCount > 0 && (\r\n              <button\r\n                onClick={handleMarkAllRead}\r\n                className=\"text-xs text-brand-500 hover:text-brand-600 font-medium\"\r\n              >\r\n                Marqué tout lu\r\n              </button>\r\n            )}\r\n            <button\r\n              onClick={toggleDropdown}\r\n              className=\"text-gray-500 transition dropdown-toggle dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200\"\r\n            >\r\n              <svg\r\n                className=\"fill-current\"\r\n                width=\"24\"\r\n                height=\"24\"\r\n                viewBox=\"0 0 24 24\"\r\n                xmlns=\"http://www.w3.org/2000/svg\"\r\n              >\r\n                <path\r\n                  fillRule=\"evenodd\"\r\n                  clipRule=\"evenodd\"\r\n                  d=\"M6.21967 7.28131C5.92678 6.98841 5.92678 6.51354 6.21967 6.22065C6.51256 5.92775 6.98744 5.92775 7.28033 6.22065L11.999 10.9393L16.7176 6.22078C17.0105 5.92789 17.4854 5.92788 17.7782 6.22078C18.0711 6.51367 18.0711 6.98855 17.7782 7.28144L13.0597 12L17.7782 16.7186C18.0711 17.0115 18.0711 17.4863 17.7782 17.7792C17.4854 18.0721 17.0105 18.0721 16.7176 17.7792L11.999 13.0607L7.28033 17.7794C6.98744 18.0722 6.51256 18.0722 6.21967 17.7794C5.92678 17.4865 5.92678 17.0116 6.21967 16.7187L10.9384 12L6.21967 7.28131Z\"\r\n                  fill=\"currentColor\"\r\n                />\r\n              </svg>\r\n            </button>\r\n          </div>\r\n        </div>\r\n        <ul className=\"flex flex-col h-auto overflow-y-auto custom-scrollbar\">\r\n          {loading ? (\r\n            <li className=\"p-4 text-center text-gray-500\">Chargement...</li>\r\n          ) : notifications.length === 0 ? (\r\n            <li className=\"p-4 text-center text-gray-500\">Aucune notification</li>\r\n          ) : (\r\n            notifications.map((notification) => (\r\n              <li key={notification.id_notification}>\r\n                <DropdownItem\r\n                  onItemClick={() => handleNotificationClick(notification)}\r\n                  className={`flex gap-3 rounded-lg border-b border-gray-100 p-3 px-4.5 py-3 hover:bg-gray-100 dark:border-gray-800 dark:hover:bg-white/5 ${!notification.is_read ? 'bg-gray-50 dark:bg-white/5' : ''\r\n                    }`}\r\n                  href={notification.action_url || '#'}\r\n                >\r\n                  <span className=\"relative block w-full h-10 rounded-full z-1 max-w-10 shrink-0\">\r\n                    <div className={`flex items-center justify-center w-full h-full rounded-full ${notification.type === 'CAMPAIGN_EXPIRING' ? 'bg-orange-100 text-orange-500' : 'bg-blue-100 text-blue-500'\r\n                      }`}>\r\n                      {notification.type === 'CAMPAIGN_EXPIRING' ? (\r\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z\"></path><line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\"></line><line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"></line></svg>\r\n                      ) : (\r\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\"></path><circle cx=\"8.5\" cy=\"7\" r=\"4\"></circle><line x1=\"20\" y1=\"8\" x2=\"20\" y2=\"14\"></line><line x1=\"23\" y1=\"11\" x2=\"17\" y2=\"11\"></line></svg>\r\n                      )}\r\n                    </div>\r\n                    {!notification.is_read && (\r\n                      <span className=\"absolute bottom-0 right-0 z-10 h-2.5 w-full max-w-2.5 rounded-full border-[1.5px] border-white bg-error-500 dark:border-gray-900\"></span>\r\n                    )}\r\n                  </span>\r\n\r\n                  <span className=\"block\">\r\n                    <span className=\"mb-1.5 block text-theme-sm text-gray-500 dark:text-gray-400\">\r\n                      <span className=\"font-medium text-gray-800 dark:text-white/90\">\r\n                        {notification.title}\r\n                      </span>\r\n                      <span className=\"block text-xs mt-1\">\r\n                        {notification.message}\r\n                      </span>\r\n                    </span>\r\n\r\n                    <span className=\"flex items-center gap-2 text-gray-500 text-theme-xs dark:text-gray-400\">\r\n                      <span>{notification.entity_type}</span>\r\n                      <span className=\"w-1 h-1 bg-gray-400 rounded-full\"></span>\r\n                      <span>{timeAgo(notification.created_at)}</span>\r\n                    </span>\r\n                  </span>\r\n                </DropdownItem>\r\n              </li>\r\n            ))\r\n          )}\r\n        </ul>\r\n        <Link\r\n          href=\"/notifications\"\r\n          className=\"block px-4 py-2 mt-3 text-sm font-medium text-center text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700\"\r\n        >\r\n          Voir toutes les notifications\r\n        </Link>\r\n      </Dropdown>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\common\\ThemeToggleButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\dashboard\\CampagnesStatus.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\dashboard\\PrestatairesStats.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'indispoPercent' is assigned a value but never used.","line":17,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Card } from \"@/components/ui/card\";\r\n\r\ninterface Props {\r\n    prestataires: {\r\n        total: number;\r\n        disponibles: number;\r\n        indisponibles: number;\r\n    };\r\n}\r\n\r\nexport default function PrestatairesStats({ prestataires }: Props) {\r\n    const { disponibles, indisponibles, total } = prestataires;\r\n\r\n    const dispoPercent = total ? (disponibles / total) * 100 : 0;\r\n    const indispoPercent = 100 - dispoPercent;\r\n\r\n    return (\r\n        <Card className=\"relative overflow-hidden rounded-2xl p-6 shadow-lg\">\r\n            <h2 className=\"mb-6 text-lg font-semibold\">\r\n                Disponibilité des prestataires\r\n            </h2>\r\n\r\n            <div className=\"flex justify-center\">\r\n                {/* PIE CHART */}\r\n                <div\r\n                    className=\"group relative h-48 w-48 rounded-full\"\r\n                    style={{\r\n                        background: `conic-gradient(\r\n              #3b82f6 0% ${dispoPercent}%,\r\n              #ec4899 ${dispoPercent}% 100%\r\n            )`,\r\n                    }}\r\n                >\r\n                    {/* Cercle intérieur */}\r\n                    <div className=\"absolute inset-4 rounded-full \" />\r\n\r\n                    {/* Tooltip Disponible */}\r\n                    <div className=\"absolute left-1/2 top-0 hidden -translate-x-1/2 -translate-y-full rounded-md px-3 py-1 text-sm group-hover:block\">\r\n                        🔵 Disponibles : {disponibles}\r\n                    </div>\r\n\r\n                    {/* Tooltip Indisponible */}\r\n                    <div className=\"absolute bottom-0 left-1/2 hidden -translate-x-1/2 translate-y-full rounded-md px-3 py-1 text-sm group-hover:block\">\r\n                        🌸 Indisponibles : {indisponibles}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* LÉGENDE */}\r\n            <div className=\"mt-6 flex justify-center gap-6 text-sm\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <span className=\"h-3 w-3 rounded-full bg-blue-500\" />\r\n                    <span>Disponibles</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                    <span className=\"h-3 w-3 rounded-full bg-pink-500\" />\r\n                    <span>Indisponibles</span>\r\n                </div>\r\n            </div>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\dashboard\\StatsCards.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\lieux\\AddLieu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\lieux\\DeleteLieu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\lieux\\EditLieu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\lieux\\LieuTable.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setError' is assigned a value but never used.","line":27,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":25},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchLieux'. Either include it or remove the dependency array.","line":63,"column":6,"nodeType":"ArrayExpression","endLine":63,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [apiClient, fetchLieux, page]","fix":{"range":[2009,2026],"text":"[apiClient, fetchLieux, page]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { Pencil, Trash2, Plus, MapPin, Search } from \"lucide-react\";\r\nimport AddLieuModal from \"./AddLieu\";\r\nimport EditLieuModal from \"./EditLieu\";\r\nimport DeleteLieuModal from \"./DeleteLieu\";\r\nimport { useAuth } from \"@/app/context/AuthContext\";\r\nimport { toast } from \"react-toastify\";\r\nimport { Paginate } from \"../Paginate\";\r\nimport { useSearchParams } from \"next/navigation\";\r\nimport { Input } from \"@/components/ui/input\"\r\n\r\nexport type Lieu = {\r\n  id_lieu: string;\r\n  nom: string;\r\n  ville: string;\r\n  created_at: string;\r\n  _count?: { campagnes: number };\r\n};\r\n\r\nexport default function LieuTable() {\r\n  const { apiClient } = useAuth();\r\n\r\n  const [lieux, setLieux] = useState<Lieu[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const [isAddModalOpen, setIsAddModalOpen] = useState(false);\r\n  const [isEditModalOpen, setIsEditModalOpen] = useState(false);\r\n  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);\r\n\r\n  const [lieuToEdit, setLieuToEdit] = useState<Lieu | null>(null);\r\n  const [lieuToDelete, setLieuToDelete] = useState<Lieu | null>(null);\r\n\r\n  const searchParam = useSearchParams();\r\n  const page = parseInt(searchParam?.get(\"page\") || \"1\");\r\n  const [totalPages, setTotalPages] = useState(1);\r\n  const [searchQuery, setSearchQuery] = useState(\"\")\r\n\r\n  // ✅ Recharger les lieux\r\n  const fetchLieux = async () => {\r\n    setLoading(true);\r\n    try {\r\n      const res = await apiClient(`/api/lieux?page=${page}&limit=7`);\r\n\r\n      if (!res.ok) throw new Error(\"Erreur API\");\r\n\r\n      const data = await res.json();\r\n      setLieux(data.lieux || []);\r\n      setTotalPages(data?.pagination?.totalPages || 1);\r\n\r\n    } catch (error) {\r\n      console.error(\"Erreur API :\", error);\r\n      toast.error(\"Impossible de charger les lieux\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchLieux();\r\n  }, [apiClient, page]);\r\n\r\n  const filteredLieux = lieux.filter((l) => {\r\n    const search = searchQuery.toLowerCase()\r\n    return (\r\n      l.nom.toLowerCase().includes(search) ||\r\n      l.ville.toLowerCase().includes(search)\r\n    )\r\n  })\r\n\r\n  return (\r\n    <div className=\"p-6 text-gray-900 dark:text-white\">\r\n      {/* HEADER */}\r\n      <div className=\"flex flex-col sm:flex-row items-center justify-between mb-6 bg-white dark:bg-gray-900 p-4 rounded-2xl shadow-md border border-gray-100 dark:border-gray-800\">\r\n        <div className=\"flex items-center gap-2 text-[#d61353]\">\r\n          <MapPin className=\"w-6 h-6\" />\r\n          <h1 className=\"text-xl sm:text-2xl font-bold\">Gestion des lieux</h1>\r\n        </div>\r\n\r\n        <button\r\n          onClick={() => setIsAddModalOpen(true)}\r\n          className=\"flex items-center gap-2 bg-[#d61353] text-white px-4 py-2 rounded-lg hover:bg-[#b01044] transition\"\r\n        >\r\n          <Plus className=\"w-5 h-5\" />\r\n          Ajouter un lieu\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"flex justify-end mb-4\">\r\n        <div className=\"relative w-full md:w-72\">\r\n          <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500\" />\r\n          <Input\r\n            placeholder=\"Rechercher...\"\r\n            value={searchQuery}\r\n            onChange={(e) => setSearchQuery(e.target.value)}\r\n            className=\"pl-9 bg-white dark:bg-gray-800\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"overflow-x-auto bg-white dark:bg-gray-900 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-800\">\r\n        {loading ? (\r\n          <div className=\"flex flex-col items-center justify-center py-10\">\r\n            <div className=\"w-10 h-10 border-4 border-[#d61353]/30 border-t-[#d61353] rounded-full animate-spin\"></div>\r\n            <p className=\"mt-3 text-gray-600 dark:text-gray-300 font-medium\">\r\n              Chargement des lieux...\r\n            </p>\r\n          </div>\r\n        ) : error ? (\r\n\r\n          <div className=\"text-center text-red-500 py-8\">{error}</div>\r\n        ) : lieux.length === 0 ? (\r\n          <div className=\"text-center py-8 text-gray-500\">Aucun lieu trouvé</div>\r\n        ) : (\r\n          <div>\r\n            <table className=\"min-w-full border-collapse\">\r\n              <thead>\r\n                <tr className=\"bg-gray-50 dark:bg-gray-800\">\r\n                  <th className=\"px-6 py-3 text-sm font-semibold\">Nom du lieu</th>\r\n                  <th className=\"px-6 py-3 text-sm font-semibold\">Ville</th>\r\n                  <th className=\"px-6 py-3 text-sm font-semibold\">Campagnes</th>\r\n                  <th className=\"px-6 py-3 text-sm font-semibold\">Créé le</th>\r\n                  <th className=\"px-6 py-3 text-sm font-semibold text-center\">Actions</th>\r\n                </tr>\r\n              </thead>\r\n\r\n              <tbody className=\"bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700\">\r\n                {!loading && filteredLieux.length === 0 && (\r\n                  <tr>\r\n                    <td colSpan={5} className=\"text-center py-6 text-gray-500\">\r\n                      Aucun lieu trouvé.\r\n                    </td>\r\n                  </tr>\r\n                )}\r\n                {filteredLieux.map((lieu) => (\r\n                  <tr key={lieu.id_lieu}>\r\n                    <td className=\"px-6 py-3\">{lieu.nom}</td>\r\n                    <td className=\"px-6 py-3\">{lieu.ville}</td>\r\n                    <td className=\"px-6 py-3 text-center\">{lieu._count?.campagnes || 0}</td>\r\n                    <td className=\"px-6 py-3\">\r\n                      {new Date(lieu.created_at).toLocaleDateString(\"fr-FR\")}\r\n                    </td>\r\n\r\n                    <td className=\"px-6 py-3 text-center\">\r\n                      <div className=\"flex justify-center gap-3\">\r\n                        <button\r\n                          onClick={() => {\r\n                            setLieuToEdit(lieu);\r\n                            setIsEditModalOpen(true);\r\n                          }}\r\n                          className=\"p-2 bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded-lg\"\r\n                        >\r\n                          <Pencil className=\"w-4 h-4\" />\r\n                        </button>\r\n\r\n                        <button\r\n                          onClick={() => {\r\n                            setLieuToDelete(lieu);\r\n                            setIsDeleteModalOpen(true);\r\n                          }}\r\n                          className=\"p-2 bg-red-50 dark:bg-red-900/30 text-red-600 rounded-lg\"\r\n                        >\r\n                          <Trash2 className=\"w-4 h-4\" />\r\n                        </button>\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n\r\n\r\n              </tbody>\r\n            </table>\r\n            {totalPages > 1 && <Paginate pages={totalPages} currentPage={page} />}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n\r\n      {/* MODALS */}\r\n      <AddLieuModal\r\n        isOpen={isAddModalOpen}\r\n        onClose={() => setIsAddModalOpen(false)}\r\n        onLieuUpdated={fetchLieux}\r\n      />\r\n\r\n      {lieuToEdit && (\r\n        <EditLieuModal\r\n          isOpen={isEditModalOpen}\r\n          onClose={() => {\r\n            setIsEditModalOpen(false);\r\n            setLieuToEdit(null);\r\n          }}\r\n          lieu={lieuToEdit}\r\n          onLieuUpdated={fetchLieux}\r\n        />\r\n      )}\r\n\r\n      {lieuToDelete && (\r\n        <DeleteLieuModal\r\n          isOpen={isDeleteModalOpen}\r\n          onClose={() => {\r\n            setIsDeleteModalOpen(false);\r\n            setLieuToDelete(null);\r\n          }}\r\n          lieu={lieuToDelete}\r\n          onLieuUpdated={fetchLieux}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\paiements\\PaiementTable.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used.","line":19,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":19,"endColumn":12},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":61,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1758,1761],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1758,1761],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":543,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":543,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32257,32260],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32257,32260],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState, useCallback } from \"react\";\r\nimport { useAuth } from \"@/app/context/AuthContext\";\r\nimport { toast } from \"react-toastify\";\r\nimport {\r\n    CreditCard,\r\n    Eye,\r\n    CheckCircle,\r\n    AlertCircle,\r\n    Search,\r\n    Filter,\r\n    Download,\r\n    X,\r\n    Save,\r\n    Edit2\r\n} from \"lucide-react\";\r\nimport { Input } from \"@/components/ui/input\"\r\nimport Link from \"next/link\";\r\nimport { Paginate } from \"../Paginate\";\r\nimport { useSearchParams } from \"next/navigation\";\r\n\r\n// Types basés sur l'API\r\ninterface Paiement {\r\n    id_paiement: string;\r\n    id_campagne: string;\r\n    id_prestataire: string;\r\n    paiement_base: number;\r\n    sanction_montant: number;\r\n    paiement_final: number;\r\n    statut_paiement: boolean; // true = Payé, false = En attente\r\n    date_paiement: string | null;\r\n    created_at: string;\r\n    affectation: {\r\n        campagne: {\r\n            nom_campagne: string;\r\n            client: {\r\n                nom: string;\r\n            };\r\n        };\r\n        prestataire: {\r\n            nom: string;\r\n            prenom: string;\r\n            contact: string;\r\n        };\r\n    };\r\n}\r\n\r\nexport default function PaiementTable() {\r\n    const { apiClient } = useAuth();\r\n    const [paiements, setPaiements] = useState<Paiement[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    // Filtres\r\n    const [filterStatut, setFilterStatut] = useState<string>(\"all\"); // all, paid, pending\r\n\r\n    // Modal de détails et édition\r\n    const [selectedPaiement, setSelectedPaiement] = useState<Paiement | null>(null);\r\n    const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);\r\n    const [materiels, setMateriels] = useState<any[]>([]);\r\n    const [loadingMateriels, setLoadingMateriels] = useState(false);\r\n    const [searchQuery, setSearchQuery] = useState(\"\")\r\n\r\n    // États d'édition\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [editStatut, setEditStatut] = useState<boolean>(false);\r\n    const [editDate, setEditDate] = useState<string>(\"\");\r\n    const [saving, setSaving] = useState(false);\r\n\r\n    const searchParam = useSearchParams();\r\n    const page = parseInt(searchParam?.get(\"page\") || \"1\");\r\n    const [totalPages, setTotalPages] = useState(1);\r\n\r\n    const fetchPaiements = useCallback(async () => {\r\n        setLoading(true);\r\n        setError(null);\r\n        try {\r\n            // Construction des query params\r\n            const params = new URLSearchParams({\r\n                limit: \"7\",\r\n                page: String(page)\r\n            });\r\n            if (filterStatut === \"paid\") params.append(\"statut_paiement\", \"true\");\r\n            if (filterStatut === \"pending\") params.append(\"statut_paiement\", \"false\");\r\n\r\n            const res = await apiClient(`/api/paiements?${params.toString()}`);\r\n\r\n            if (!res.ok) {\r\n                throw new Error(\"Erreur lors du chargement des paiements\");\r\n            }\r\n\r\n            const data = await res.json();\r\n            setPaiements(data.paiements || []);\r\n            setTotalPages(data?.pagination?.totalPages || 1);\r\n        } catch (err) {\r\n            console.error(\"Erreur fetch paiements:\", err);\r\n            const message = err instanceof Error ? err.message : \"Erreur inconnue\";\r\n            setError(message);\r\n            toast.error(message);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, [apiClient, filterStatut, page]);\r\n\r\n    useEffect(() => {\r\n        fetchPaiements();\r\n    }, [fetchPaiements]);\r\n\r\n    // Fonction utilitaire pour le formatage monétaire\r\n    const formatMoney = (amount: number) => {\r\n        return new Intl.NumberFormat(\"fr-FR\", {\r\n            style: \"currency\",\r\n            currency: \"XOF\",\r\n            minimumFractionDigits: 0,\r\n        }).format(amount);\r\n    };\r\n\r\n    // Fonction pour ouvrir le modal de détails\r\n    const handleViewDetails = async (paiement: Paiement) => {\r\n        console.log(\"handleViewDetails called with:\", paiement);\r\n        setSelectedPaiement(paiement);\r\n        setIsEditing(false); // Reset edit mode\r\n\r\n        // Initialiser les valeurs d'édition\r\n        setEditStatut(paiement.statut_paiement);\r\n        setEditDate(paiement.date_paiement ? new Date(paiement.date_paiement).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]);\r\n\r\n        setIsDetailModalOpen(true);\r\n\r\n        // Charger les matériels casés associés\r\n        setLoadingMateriels(true);\r\n        try {\r\n            console.log(\"Fetching materiels for:\", {\r\n                id_campagne: paiement.id_campagne,\r\n                id_prestataire: paiement.id_prestataire\r\n            });\r\n            const params = new URLSearchParams({\r\n                page: \"1\",\r\n                limit: \"100\",\r\n                id_campagne: paiement.id_campagne,\r\n                id_prestataire: paiement.id_prestataire\r\n            });\r\n            const url = `/api/materiels-cases?${params.toString()}`;\r\n            console.log(\"Fetching URL:\", url);\r\n            const res = await apiClient(url);\r\n            console.log(\"Response status:\", res.status);\r\n            if (res.ok) {\r\n                const data = await res.json();\r\n                console.log(\"Materiels fetched:\", data);\r\n                setMateriels(data.materiels_cases || []);\r\n            } else {\r\n                console.error(\"Error fetching materiels:\", await res.text());\r\n            }\r\n        } catch (err) {\r\n            console.error(\"Erreur chargement matériels:\", err);\r\n        } finally {\r\n            setLoadingMateriels(false);\r\n        }\r\n    };\r\n\r\n    // Fonction pour sauvegarder les modifications\r\n    const handleSaveStatus = async () => {\r\n        if (!selectedPaiement) return;\r\n\r\n        setSaving(true);\r\n        try {\r\n            const body = {\r\n                statut_paiement: editStatut,\r\n                date_paiement: editStatut ? editDate : null // Si non payé, pas de date\r\n            };\r\n\r\n            const res = await apiClient(`/api/paiements/${selectedPaiement.id_campagne}/${selectedPaiement.id_prestataire}`, {\r\n                method: \"PUT\",\r\n                headers: {\r\n                    \"Content-Type\": \"application/json\"\r\n                },\r\n                body: JSON.stringify(body)\r\n            });\r\n\r\n            if (!res.ok) {\r\n                const err = await res.json();\r\n                throw new Error(err.message || \"Erreur lors de la mise à jour\");\r\n            }\r\n\r\n            const data = await res.json();\r\n            toast.success(\"Statut de paiement mis à jour\");\r\n\r\n            // Mettre à jour l'état local et la liste\r\n            setSelectedPaiement(data.paiement);\r\n            setIsEditing(false);\r\n            fetchPaiements(); // Rafraîchir la liste\r\n        } catch (err) {\r\n            console.error(err);\r\n            toast.error(err instanceof Error ? err.message : \"Erreur de mise à jour\");\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    };\r\n\r\n    const filteredPaiements = paiements.filter((p) => {\r\n        const search = searchQuery.toLowerCase()\r\n        return (\r\n            p.affectation.prestataire.nom.toLowerCase().includes(search) ||\r\n            p.affectation.prestataire.prenom.toLowerCase().includes(search) ||\r\n            p.affectation.campagne.nom_campagne.toLowerCase().includes(search) ||\r\n            p.affectation.campagne.client.nom.toLowerCase().includes(search)\r\n        )\r\n    })\r\n\r\n    return (\r\n        <div className=\"p-6 text-gray-900 dark:text-white space-y-6\">\r\n            {/* HEADER */}\r\n            <div className=\"flex flex-col sm:flex-row items-center justify-between bg-white dark:bg-gray-900 p-4 rounded-2xl shadow-md border border-gray-100 dark:border-gray-800\">\r\n                <div className=\"flex items-center gap-2 text-[#d61353]\">\r\n                    <CreditCard className=\"w-6 h-6\" />\r\n                    <h1 className=\"text-xl sm:text-2xl font-bold\">Gestion des Paiements</h1>\r\n                </div>\r\n\r\n                <div className=\"flex gap-3 mt-4 sm:mt-0\">\r\n                    {/* Bouton Export (Placeholder) */}\r\n                    <button className=\"flex items-center gap-2 px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition text-sm\">\r\n                        <Download className=\"w-4 h-4\" />\r\n                        <span>Exporter</span>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* BARRE D'OUTILS & FILTRES */}\r\n            <div className=\"flex flex-col sm:flex-row gap-4 bg-white dark:bg-gray-900 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Filter className=\"w-4 h-4 text-gray-500\" />\r\n                    <span className=\"text-sm font-medium\">Filtrer par statut:</span>\r\n                    <select\r\n                        value={filterStatut}\r\n                        onChange={(e) => setFilterStatut(e.target.value)}\r\n                        className=\"text-sm border-gray-300 rounded-md shadow-sm focus:border-[#d61353] focus:ring focus:ring-[#d61353] focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700\"\r\n                    >\r\n                        <option value=\"all\">Tous</option>\r\n                        <option value=\"pending\">En attente</option>\r\n                        <option value=\"paid\">Payés</option>\r\n                    </select>\r\n                </div>\r\n\r\n                <div className=\"flex-1 flex justify-end\">\r\n                    <div className=\"relative w-full md:w-72\">\r\n                        <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500\" />\r\n                        <Input\r\n                            placeholder=\"Rechercher...\"\r\n                            value={searchQuery}\r\n                            onChange={(e) => setSearchQuery(e.target.value)}\r\n                            className=\"pl-9 bg-white dark:bg-gray-800\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* TABLEAU */}\r\n            <div className=\"overflow-x-auto bg-white dark:bg-gray-900 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-800\">\r\n                {loading ? (\r\n                    <div className=\"flex flex-col items-center justify-center py-12\">\r\n                        <div className=\"w-10 h-10 border-4 border-[#d61353]/30 border-t-[#d61353] rounded-full animate-spin\"></div>\r\n                        <p className=\"mt-3 text-gray-600 dark:text-gray-300 font-medium\">Chargement des données financières...</p>\r\n                    </div>\r\n                ) : error ? (\r\n                    <div className=\"text-center text-red-500 py-12 bg-red-50 dark:bg-red-900/10\">\r\n                        <AlertCircle className=\"w-8 h-8 mx-auto mb-2\" />\r\n                        {error}\r\n                    </div>\r\n                ) : paiements.length === 0 ? (\r\n                    <div className=\"text-center py-12 text-gray-500\">\r\n                        <CreditCard className=\"w-10 h-10 mx-auto mb-3 opacity-20\" />\r\n                        Aucun paiement trouvé pour ces critères.\r\n                    </div>\r\n                ) : (\r\n                    <div>\r\n                        <table className=\"min-w-full border-collapse text-left\">\r\n                            <thead>\r\n                                <tr className=\"bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700\">\r\n                                    <th className=\"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider\">Prestataire</th>\r\n                                    <th className=\"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider\">Campagne</th>\r\n                                    <th className=\"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right\">Montant Base</th>\r\n                                    <th className=\"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right\">Pénalités</th>\r\n                                    <th className=\"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right\">Net à Payer</th>\r\n                                    <th className=\"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-center\">Statut</th>\r\n                                    <th className=\"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-center\">Actions</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody className=\"divide-y divide-gray-200 dark:divide-gray-700\">\r\n                                {filteredPaiements.map((paiement) => (\r\n                                    <tr key={paiement.id_paiement} className=\"hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors\">\r\n                                        <td className=\"px-6 py-4\">\r\n                                            <div className=\"flex items-center\">\r\n                                                <div className=\"h-8 w-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs font-bold mr-3 text-gray-600 dark:text-gray-300\">\r\n                                                    {paiement.affectation.prestataire.nom.charAt(0)}{paiement.affectation.prestataire.prenom.charAt(0)}\r\n                                                </div>\r\n                                                <div>\r\n                                                    <div className=\"font-medium text-gray-900 dark:text-white\">\r\n                                                        {paiement.affectation.prestataire.nom} {paiement.affectation.prestataire.prenom}\r\n                                                    </div>\r\n                                                    <div className=\"text-xs text-gray-500\">{paiement.affectation.prestataire.contact}</div>\r\n                                                </div>\r\n                                            </div>\r\n                                        </td>\r\n                                        <td className=\"px-6 py-4 text-sm text-gray-600 dark:text-gray-300\">\r\n                                            <div className=\"font-medium\">{paiement.affectation.campagne.nom_campagne}</div>\r\n                                            <div className=\"text-xs text-gray-500\">{paiement.affectation.campagne.client.nom}</div>\r\n                                        </td>\r\n                                        <td className=\"px-6 py-4 text-sm font-medium text-right text-gray-900 dark:text-white\">\r\n                                            {formatMoney(paiement.paiement_base)}\r\n                                        </td>\r\n                                        <td className=\"px-6 py-4 text-sm font-medium text-right text-red-600 dark:text-red-400\">\r\n                                            {paiement.sanction_montant > 0 ? `-${formatMoney(paiement.sanction_montant)}` : \"-\"}\r\n                                        </td>\r\n                                        <td className=\"px-6 py-4 text-sm font-bold text-right text-gray-900 dark:text-white\">\r\n                                            {formatMoney(paiement.paiement_final)}\r\n                                        </td>\r\n                                        <td className=\"px-6 py-4 text-center\">\r\n                                            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${paiement.statut_paiement\r\n                                                ? \"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400\"\r\n                                                : \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400\"\r\n                                                }`}>\r\n                                                {paiement.statut_paiement ? (\r\n                                                    <>\r\n                                                        <CheckCircle className=\"w-3 h-3 mr-1\" /> Payé\r\n                                                    </>\r\n                                                ) : (\r\n                                                    <>\r\n                                                        <AlertCircle className=\"w-3 h-3 mr-1\" /> En attente\r\n                                                    </>\r\n                                                )}\r\n                                            </span>\r\n                                            {paiement.date_paiement && (\r\n                                                <div className=\"text-[10px] text-gray-400 mt-1\">\r\n                                                    le {new Date(paiement.date_paiement).toLocaleDateString(\"fr-FR\")}\r\n                                                </div>\r\n                                            )}\r\n                                        </td>\r\n                                        <td className=\"px-6 py-4 text-center\">\r\n                                            <div className=\"flex justify-center gap-2\">\r\n                                                {/* Action Voir */}\r\n                                                <button\r\n                                                    onClick={() => handleViewDetails(paiement)}\r\n                                                    className=\"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 hover:text-[#d61353] transition\"\r\n                                                    title=\"Voir détails / Modifier\"\r\n                                                >\r\n                                                    <Eye className=\"w-4 h-4\" />\r\n                                                </button>\r\n                                            </div>\r\n                                        </td>\r\n                                    </tr>\r\n                                ))}\r\n                            </tbody>\r\n                        </table>\r\n                        {totalPages > 1 && <Paginate pages={totalPages} currentPage={page} />}\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Modal de détails du paiement */}\r\n            {isDetailModalOpen && selectedPaiement && (\r\n                <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\r\n                    <div className=\"bg-white dark:bg-gray-900 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto\">\r\n                        {/* Header */}\r\n                        <div className=\"sticky top-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 p-6 flex items-center justify-between z-10\">\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <CreditCard className=\"w-6 h-6 text-[#d61353]\" />\r\n                                <h2 className=\"text-2xl font-bold text-gray-900 dark:text-white\">\r\n                                    {isEditing ? \"Modifier le paiement\" : \"Détails du Paiement\"}\r\n                                </h2>\r\n                            </div>\r\n                            <button\r\n                                onClick={() => {\r\n                                    setIsDetailModalOpen(false);\r\n                                    setSelectedPaiement(null);\r\n                                    setMateriels([]);\r\n                                    setIsEditing(false);\r\n                                }}\r\n                                className=\"p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition\"\r\n                            >\r\n                                <X className=\"w-5 h-5\" />\r\n                            </button>\r\n                        </div>\r\n\r\n                        {/* Content */}\r\n                        <div className=\"p-6 space-y-6\">\r\n                            {/* Informations générales */}\r\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                                <div className=\"bg-gray-50 dark:bg-gray-800 p-4 rounded-lg\">\r\n                                    <p className=\"text-xs text-gray-500 uppercase tracking-wide mb-1\">Prestataire</p>\r\n                                    <p className=\"font-semibold text-gray-900 dark:text-white\">\r\n                                        {selectedPaiement.affectation.prestataire.nom} {selectedPaiement.affectation.prestataire.prenom}\r\n                                    </p>\r\n                                    <p className=\"text-sm text-gray-600 dark:text-gray-400\">{selectedPaiement.affectation.prestataire.contact}</p>\r\n                                </div>\r\n\r\n                                <div className=\"bg-gray-50 dark:bg-gray-800 p-4 rounded-lg\">\r\n                                    <p className=\"text-xs text-gray-500 uppercase tracking-wide mb-1\">Campagne</p>\r\n                                    <p className=\"font-semibold text-gray-900 dark:text-white\">{selectedPaiement.affectation.campagne.nom_campagne}</p>\r\n                                    <p className=\"text-sm text-gray-600 dark:text-gray-400\">Client: {selectedPaiement.affectation.campagne.client.nom}</p>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Détails financiers */}\r\n                            <div className=\"border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden\">\r\n                                <div className=\"bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b border-gray-200 dark:border-gray-700\">\r\n                                    <h3 className=\"font-semibold text-gray-900 dark:text-white\">Détails Financiers</h3>\r\n                                </div>\r\n                                <div className=\"p-4 space-y-3\">\r\n                                    <div className=\"flex justify-between items-center\">\r\n                                        <span className=\"text-gray-600 dark:text-gray-400\">Montant de base</span>\r\n                                        <span className=\"font-semibold text-gray-900 dark:text-white\">{formatMoney(selectedPaiement.paiement_base)}</span>\r\n                                    </div>\r\n                                    <div className=\"flex justify-between items-center text-red-600 dark:text-red-400\">\r\n                                        <span>Pénalités appliquées</span>\r\n                                        <span className=\"font-semibold\">-{formatMoney(selectedPaiement.sanction_montant)}</span>\r\n                                    </div>\r\n                                    <div className=\"h-px bg-gray-200 dark:bg-gray-700\"></div>\r\n                                    <div className=\"flex justify-between items-center text-lg\">\r\n                                        <span className=\"font-bold text-gray-900 dark:text-white\">Net à payer</span>\r\n                                        <span className=\"font-bold text-[#d61353]\">{formatMoney(selectedPaiement.paiement_final)}</span>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Statut du paiement - Zone Modifiable */}\r\n                            <div className={`p-4 rounded-lg ${isEditing ? \"bg-white border-2 border-[#d61353]/20\" : \"bg-gray-50 dark:bg-gray-800\"}`}>\r\n                                <div className=\"flex items-center justify-between mb-4\">\r\n                                    <h3 className=\"font-semibold text-gray-900 dark:text-white\">Statut du Paiement</h3>\r\n                                    {!isEditing && (\r\n                                        <button\r\n                                            onClick={() => setIsEditing(true)}\r\n                                            className=\"flex items-center gap-2 text-sm text-[#d61353] hover:underline\"\r\n                                        >\r\n                                            <Edit2 className=\"w-4 h-4\" />\r\n                                            Modifier\r\n                                        </button>\r\n                                    )}\r\n                                </div>\r\n\r\n                                {isEditing ? (\r\n                                    <div className=\"space-y-4\">\r\n                                        <div>\r\n                                            <label className=\"block text-sm font-medium mb-1\">État du paiement</label>\r\n                                            <div className=\"flex gap-4\">\r\n                                                <label className=\"flex items-center gap-2 cursor-pointer\">\r\n                                                    <input\r\n                                                        type=\"radio\"\r\n                                                        checked={!editStatut}\r\n                                                        onChange={() => setEditStatut(false)}\r\n                                                        className=\"text-[#d61353] focus:ring-[#d61353]\"\r\n                                                    />\r\n                                                    <span className=\"flex items-center gap-1 text-yellow-600\"><AlertCircle className=\"w-4 h-4\" /> En attente</span>\r\n                                                </label>\r\n                                                <label className=\"flex items-center gap-2 cursor-pointer\">\r\n                                                    <input\r\n                                                        type=\"radio\"\r\n                                                        checked={editStatut}\r\n                                                        onChange={() => setEditStatut(true)}\r\n                                                        className=\"text-[#d61353] focus:ring-[#d61353]\"\r\n                                                    />\r\n                                                    <span className=\"flex items-center gap-1 text-green-600\"><CheckCircle className=\"w-4 h-4\" /> Payé</span>\r\n                                                </label>\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        {editStatut && (\r\n                                            <div>\r\n                                                <label className=\"block text-sm font-medium mb-1\">Date de paiement</label>\r\n                                                <input\r\n                                                    type=\"date\"\r\n                                                    value={editDate}\r\n                                                    onChange={(e) => setEditDate(e.target.value)}\r\n                                                    className=\"w-full px-3 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600\"\r\n                                                />\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        <div className=\"flex justify-end gap-2 mt-4 pt-4 border-t\">\r\n                                            <button\r\n                                                onClick={() => setIsEditing(false)}\r\n                                                disabled={saving}\r\n                                                className=\"px-4 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600\"\r\n                                            >\r\n                                                Annuler\r\n                                            </button>\r\n                                            <button\r\n                                                onClick={handleSaveStatus}\r\n                                                disabled={saving}\r\n                                                className=\"flex items-center gap-2 px-4 py-2 text-sm rounded-lg bg-[#d61353] hover:bg-[#b01044] text-white disabled:opacity-50\"\r\n                                            >\r\n                                                {saving ? \"Enregistrement...\" : (\r\n                                                    <><Save className=\"w-4 h-4\" /> Enregistrer</>\r\n                                                )}\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                ) : (\r\n                                    /* Affichage Lecture Seule */\r\n                                    <div className=\"flex items-center justify-between\">\r\n                                        <div>\r\n                                            <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${selectedPaiement.statut_paiement\r\n                                                ? \"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400\"\r\n                                                : \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400\"\r\n                                                }`}>\r\n                                                {selectedPaiement.statut_paiement ? (\r\n                                                    <><CheckCircle className=\"w-4 h-4 mr-1\" /> Payé</>\r\n                                                ) : (\r\n                                                    <><AlertCircle className=\"w-4 h-4 mr-1\" /> En attente</>\r\n                                                )}\r\n                                            </span>\r\n                                        </div>\r\n                                        {selectedPaiement.date_paiement ? (\r\n                                            <div className=\"text-right\">\r\n                                                <p className=\"text-xs text-gray-500 uppercase tracking-wide mb-1\">Date de paiement</p>\r\n                                                <p className=\"font-medium text-gray-900 dark:text-white\">\r\n                                                    {new Date(selectedPaiement.date_paiement).toLocaleDateString(\"fr-FR\", {\r\n                                                        year: 'numeric',\r\n                                                        month: 'long',\r\n                                                        day: 'numeric'\r\n                                                    })}\r\n                                                </p>\r\n                                            </div>\r\n                                        ) : (\r\n                                            <p className=\"text-sm text-gray-400 italic\">Aucune date enregistrée</p>\r\n                                        )}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            {/* Matériels casés */}\r\n                            <div className=\"border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden\">\r\n                                <div className=\"bg-gray-50 dark:bg-gray-800 px-4 py-3 border-b border-gray-200 dark:border-gray-700\">\r\n                                    <h3 className=\"font-semibold text-gray-900 dark:text-white\">Matériels Casés ({materiels.length})</h3>\r\n                                </div>\r\n                                <div className=\"p-4\">\r\n                                    {loadingMateriels ? (\r\n                                        <div className=\"text-center py-4 text-gray-500\">Chargement...</div>\r\n                                    ) : materiels.length === 0 ? (\r\n                                        <div className=\"text-center py-4 text-gray-500\">Aucun matériel casé</div>\r\n                                    ) : (\r\n                                        <div className=\"space-y-3\">\r\n                                            {materiels.map((materiel: any) => (\r\n                                                <div key={materiel.id_materiels_case} className=\"flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg\">\r\n                                                    <div className={`w-2 h-2 rounded-full mt-2 ${materiel.etat === 'BON' ? 'bg-green-500' :\r\n                                                        materiel.etat === 'MOYEN' ? 'bg-yellow-500' :\r\n                                                            'bg-red-500'\r\n                                                        }`}></div>\r\n                                                    <div className=\"flex-1\">\r\n                                                        <div className=\"flex items-center justify-between mb-1\">\r\n                                                            <span className=\"font-medium text-gray-900 dark:text-white\">{materiel.nom_materiel}</span>\r\n                                                            <span className={`text-xs px-2 py-1 rounded ${materiel.etat === 'BON' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' :\r\n                                                                materiel.etat === 'MOYEN' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400' :\r\n                                                                    'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400'\r\n                                                                }`}>\r\n                                                                {materiel.etat}\r\n                                                            </span>\r\n                                                        </div>\r\n                                                        <p className=\"text-sm text-gray-600 dark:text-gray-400\">{materiel.description}</p>\r\n                                                        {materiel.penalite_appliquer && materiel.montant_penalite > 0 && (\r\n                                                            <p className=\"text-xs text-red-600 dark:text-red-400 mt-1\">\r\n                                                                Pénalité: {formatMoney(materiel.montant_penalite)}\r\n                                                            </p>\r\n                                                        )}\r\n                                                    </div>\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\prestataires\\AddIncidentModal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchTypesIncident' and 'previewUrls'. Either include them or remove the dependency array.","line":103,"column":8,"nodeType":"ArrayExpression","endLine":103,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [fetchTypesIncident, isOpen, previewUrls]","fix":{"range":[3597,3605],"text":"[fetchTypesIncident, isOpen, previewUrls]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":410,"column":49,"nodeType":"JSXOpeningElement","endLine":410,"endColumn":134}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useRef } from \"react\";\r\nimport { useAuth } from \"@/app/context/AuthContext\";\r\nimport { toast } from \"react-toastify\";\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogFooter\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue\r\n} from \"@/components/ui/select\";\r\nimport { UploadCloud, AlertTriangle, Camera, X, Image as ImageIcon, PlusCircle, Calendar as CalendarIcon } from \"lucide-react\";\r\nimport { Calendar } from \"@/components/ui/calendar\";\r\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\r\nimport { format } from \"date-fns\";\r\n// import { CalendarIcon } from \"@radix-ui/react-icons\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport AddTypeIncidentDialog from \"@/components/types-incident/AddTypeIncidentDialog\"; // Import the dialog\r\n\r\ninterface TypeIncident {\r\n    id_type_incident: string;\r\n    nom: string;\r\n    description: string | null; // Keep it nullable to match dialog\r\n}\r\n\r\ninterface AddIncidentModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    prestataireId: string;\r\n    onIncidentAdded: () => void;\r\n}\r\n\r\nexport default function AddIncidentModal({\r\n    isOpen,\r\n    onClose,\r\n    prestataireId,\r\n    onIncidentAdded\r\n}: AddIncidentModalProps) {\r\n    const { apiClient } = useAuth();\r\n    const [loading, setLoading] = useState(false);\r\n    const [typesIncident, setTypesIncident] = useState<TypeIncident[]>([]);\r\n\r\n    // Form states\r\n    const [selectedTypeIncident, setSelectedTypeIncident] = useState<string>(\"\");\r\n    const [dateIncident, setDateIncident] = useState<Date | undefined>(new Date());\r\n    const [commentaire, setCommentaire] = useState(\"\");\r\n    const [photos, setPhotos] = useState<File[]>([]);\r\n    const [previewUrls, setPreviewUrls] = useState<string[]>([]);\r\n\r\n    // State for the \"Add New Type\" dialog\r\n    const [isAddTypeDialogOpen, setIsAddTypeDialogOpen] = useState(false);\r\n\r\n    // Camera/File input refs\r\n    const fileInputRef = useRef<HTMLInputElement>(null);\r\n    const videoRef = useRef<HTMLVideoElement>(null);\r\n    const canvasRef = useRef<HTMLCanvasElement>(null);\r\n    const streamRef = useRef<MediaStream | null>(null);\r\n    const [isCameraActive, setIsCameraActive] = useState(false);\r\n\r\n    const fetchTypesIncident = async () => {\r\n        try {\r\n            const res = await apiClient(\"/api/types-incidents\");\r\n            if (res.ok) {\r\n                const data = await res.json();\r\n                setTypesIncident(data);\r\n            } else {\r\n                toast.error(\"Échec du chargement des types d'incident.\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error fetching incident types:\", error);\r\n            toast.error(\"Erreur lors du chargement des types d'incident.\");\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            fetchTypesIncident();\r\n\r\n            // Reset form\r\n            setSelectedTypeIncident(\"\");\r\n            setDateIncident(new Date());\r\n            setCommentaire(\"\");\r\n            setPhotos([]);\r\n            setPreviewUrls([]);\r\n            stopCamera();\r\n        }\r\n        return () => {\r\n            stopCamera();\r\n            previewUrls.forEach(url => URL.revokeObjectURL(url)); // Clean up URLs\r\n        };\r\n    }, [isOpen]);\r\n\r\n    // Callback for when a new type is successfully added\r\n    const handleTypeAdded = (newType: TypeIncident) => {\r\n        // 1. Add the new type to the existing list\r\n        setTypesIncident(prev => [...prev, newType]);\r\n        // 2. Automatically select the new type\r\n        setSelectedTypeIncident(newType.id_type_incident);\r\n        // 3. Close the dialog\r\n        setIsAddTypeDialogOpen(false);\r\n    };\r\n\r\n\r\n    // --- Camera Logic ---\r\n    const startCamera = async () => {\r\n        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\r\n            toast.warn(\"Caméra non disponible, veuillez utiliser l'importation de fichiers.\");\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const stream = await navigator.mediaDevices.getUserMedia({\r\n                video: { facingMode: \"environment\" }\r\n            });\r\n            streamRef.current = stream;\r\n            if (videoRef.current) {\r\n                videoRef.current.srcObject = stream;\r\n            }\r\n            setIsCameraActive(true);\r\n        } catch (err) {\r\n            console.error(\"Impossible d'accéder à la caméra\", err);\r\n            toast.error(\"Erreur d'accès à la caméra.\");\r\n        }\r\n    };\r\n\r\n    const stopCamera = () => {\r\n        if (streamRef.current) {\r\n            streamRef.current.getTracks().forEach(track => track.stop());\r\n            streamRef.current = null;\r\n        }\r\n        setIsCameraActive(false);\r\n    };\r\n\r\n    const capturePhoto = () => {\r\n        if (videoRef.current && canvasRef.current) {\r\n            const video = videoRef.current;\r\n            const canvas = canvasRef.current;\r\n\r\n            canvas.width = video.videoWidth;\r\n            canvas.height = video.videoHeight;\r\n\r\n            const ctx = canvas.getContext('2d');\r\n            if (ctx) {\r\n                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);\r\n                canvas.toBlob((blob) => {\r\n                    if (blob) {\r\n                        const newFile = new File([blob], `incident-photo-${Date.now()}.jpg`, { type: \"image/jpeg\" });\r\n                        handleAddPhoto(newFile);\r\n                        stopCamera();\r\n                    }\r\n                }, 'image/jpeg', 0.8);\r\n            }\r\n        }\r\n    };\r\n\r\n    // --- Photo File Handling ---\r\n    const handleAddPhoto = (file: File) => {\r\n        setPhotos(prev => [...prev, file]);\r\n        setPreviewUrls(prev => [...prev, URL.createObjectURL(file)]);\r\n    };\r\n\r\n    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (e.target.files) {\r\n            Array.from(e.target.files).forEach(file => handleAddPhoto(file));\r\n        }\r\n    };\r\n\r\n    const handleRemovePhoto = (indexToRemove: number) => {\r\n        setPhotos(prev => prev.filter((_, index) => index !== indexToRemove));\r\n        setPreviewUrls(prev => {\r\n            URL.revokeObjectURL(prev[indexToRemove]); // Clean up removed URL\r\n            return prev.filter((_, index) => index !== indexToRemove);\r\n        });\r\n    };\r\n\r\n    // Simplified handleSubmit\r\n    const handleSubmit = async () => {\r\n        if (!selectedTypeIncident) {\r\n            toast.error(\"Veuillez sélectionner ou créer un type d'incident.\");\r\n            return;\r\n        }\r\n        if (!dateIncident) {\r\n            toast.error(\"Veuillez spécifier la date de l'incident.\");\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        try {\r\n            const uploadedPhotoUrls: string[] = [];\r\n\r\n            // Upload each photo individually\r\n            for (const photoFile of photos) {\r\n                const formData = new FormData();\r\n                formData.append(\"file\", photoFile);\r\n\r\n                const uploadRes = await apiClient(\"/api/incidents/upload\", {\r\n                    method: \"POST\",\r\n                    body: formData,\r\n                });\r\n\r\n                if (!uploadRes.ok) {\r\n                    throw new Error(`Erreur lors de l'upload de l'image ${photoFile.name}`);\r\n                }\r\n\r\n                const uploadJson = await uploadRes.json();\r\n                uploadedPhotoUrls.push(uploadJson.url);\r\n            }\r\n\r\n            // Payload for incident creation\r\n            const payload = {\r\n                id_prestataire: prestataireId,\r\n                id_type_incident: selectedTypeIncident,\r\n                date_incident: dateIncident.toISOString(), // ISO string for backend\r\n                commentaire,\r\n                photos: uploadedPhotoUrls,\r\n            };\r\n\r\n            const res = await apiClient(\"/api/incidents\", {\r\n                method: \"POST\",\r\n                headers: { \"Content-Type\": \"application/json\" },\r\n                body: JSON.stringify(payload),\r\n            });\r\n\r\n            if (!res.ok) {\r\n                const body = await res.json().catch(() => ({}));\r\n                throw new Error(body.message || \"Erreur lors de la déclaration de l'incident\");\r\n            }\r\n\r\n            toast.success(\"Incident déclaré avec succès.\");\r\n            onIncidentAdded();\r\n            onClose();\r\n        } catch (err) {\r\n            console.error(\"Erreur incident:\", err);\r\n            toast.error(err instanceof Error ? err.message : \"Erreur inconnue lors de la déclaration de l'incident.\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <>\r\n            <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\r\n                <DialogContent className=\"sm:max-w-4xl bg-white p-0 overflow-hidden\">\r\n                    <DialogHeader className=\"p-4 border-b bg-gray-50 flex flex-row items-center justify-between space-y-0\">\r\n                        <DialogTitle className=\"flex items-center gap-2 text-xl font-bold text-gray-800\">\r\n                            <AlertTriangle className=\"w-5 h-5 text-[#d61353]\" />\r\n                            Déclarer un Nouvel Incident\r\n                        </DialogTitle>\r\n                    </DialogHeader>\r\n\r\n                    <div className=\"p-6 overflow-y-auto max-h-[80vh]\">\r\n                        <div className=\"grid md:grid-cols-2 gap-6\">\r\n                            {/* Left Column: Form Details */}\r\n                            <div className=\"space-y-4\">\r\n                                {/* Type Incident */}\r\n                                <div className=\"space-y-1\">\r\n                                    <Label className=\"block text-sm font-medium text-gray-700\">Type d&apos;Incident</Label>\r\n                                    <Select\r\n                                        value={selectedTypeIncident}\r\n                                        onValueChange={(value) => {\r\n                                            if (value === \"__NEW__\") {\r\n                                                setIsAddTypeDialogOpen(true);\r\n                                            } else {\r\n                                                setSelectedTypeIncident(value);\r\n                                            }\r\n                                        }}\r\n                                    >\r\n                                        <SelectTrigger className=\"w-full border rounded-lg p-2.5 bg-white\">\r\n                                            <SelectValue placeholder=\"Sélectionner un type d'incident\" />\r\n                                        </SelectTrigger>\r\n                                        <SelectContent>\r\n                                            <SelectItem value=\"__NEW__\" className=\"font-bold text-blue-600\">\r\n                                                <PlusCircle className=\"mr-2 h-4 w-4 inline\" /> Nouveau type d&apos;incident\r\n                                            </SelectItem>\r\n                                            {typesIncident.length > 0 && (\r\n                                                <>\r\n                                                    <Separator />\r\n                                                    {typesIncident.map((type) => (\r\n                                                        <SelectItem key={type.id_type_incident} value={type.id_type_incident}>\r\n                                                            {type.nom}\r\n                                                        </SelectItem>\r\n                                                    ))}\r\n                                                </>\r\n                                            )}\r\n                                            {typesIncident.length === 0 && (\r\n                                                <SelectItem value=\"none\" disabled>Aucun type existant</SelectItem>\r\n                                            )}\r\n                                        </SelectContent>\r\n                                    </Select>\r\n                                </div>\r\n\r\n                                {/* Date Incident */}\r\n                                <div className=\"space-y-1\">\r\n                                    <Label className=\"block text-sm font-medium text-gray-700\">Date de l&apos;Incident</Label>\r\n                                    <Popover>\r\n                                        <PopoverTrigger asChild>\r\n                                            <Button\r\n                                                variant={\"outline\"}\r\n                                                className={cn(\r\n                                                    \"w-full justify-start text-left font-normal\",\r\n                                                    !dateIncident && \"text-muted-foreground\"\r\n                                                )}\r\n                                            >\r\n                                                <CalendarIcon className=\"mr-2 h-4 w-4\" />\r\n                                                {dateIncident ? format(dateIncident, \"PPP\") : <span>Choisir une date</span>}\r\n                                            </Button>\r\n                                        </PopoverTrigger>\r\n                                        <PopoverContent className=\"w-auto p-0\" align=\"start\">\r\n                                            <Calendar\r\n                                                mode=\"single\"\r\n                                                selected={dateIncident}\r\n                                                onSelect={setDateIncident}\r\n                                                initialFocus\r\n                                            />\r\n                                        </PopoverContent>\r\n                                    </Popover>\r\n                                </div>\r\n\r\n                                {/* Commentaire */}\r\n                                <div className=\"space-y-1\">\r\n                                    <Label className=\"block text-sm font-medium text-gray-700\">Commentaire</Label>\r\n                                    <Textarea\r\n                                        rows={4}\r\n                                        placeholder=\"Détails supplémentaires sur l'incident...\"\r\n                                        value={commentaire}\r\n                                        onChange={(e) => setCommentaire(e.target.value)}\r\n                                        className=\"w-full border rounded-lg p-2.5 resize-none focus:ring-2 focus:ring-black focus:border-black outline-none\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Right Column: Photo Evidence */}\r\n                            <div className=\"flex flex-col space-y-1\">\r\n                                <Label className=\"block text-sm font-medium text-gray-700\">Preuves Photos (Optionnel)</Label>\r\n\r\n                                <div className=\"flex-1 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-900 overflow-hidden flex flex-col relative min-h-[350px] p-2\">\r\n                                    {/* Photo input/capture controls */}\r\n                                    <div className=\"flex justify-center gap-3 p-2\">\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={() => fileInputRef.current?.click()}\r\n                                            className=\"flex items-center gap-2 px-4 py-2 bg-white border shadow-sm rounded-lg hover:bg-gray-50 text-sm font-medium transition\"\r\n                                        >\r\n                                            <UploadCloud size={16} />\r\n                                            Importer\r\n                                        </button>\r\n                                        <input\r\n                                            ref={fileInputRef}\r\n                                            type=\"file\"\r\n                                            accept=\"image/*\"\r\n                                            multiple // Allow multiple file selection\r\n                                            className=\"hidden\"\r\n                                            onChange={handleFileChange}\r\n                                        />\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={startCamera}\r\n                                            className=\"flex items-center gap-2 px-4 py-2 bg-black text-white shadow-sm rounded-lg hover:bg-gray-800 text-sm font-medium transition\"\r\n                                        >\r\n                                            <Camera size={16} />\r\n                                            Prendre photo\r\n                                        </button>\r\n                                    </div>\r\n\r\n                                    {/* Camera View */}\r\n                                    <div className={`flex-1 relative bg-black ${isCameraActive ? 'block' : 'hidden'} my-2 rounded-lg overflow-hidden`}>\r\n                                        <video\r\n                                            ref={videoRef}\r\n                                            autoPlay\r\n                                            playsInline\r\n                                            muted\r\n                                            className=\"w-full h-full object-cover\"\r\n                                        />\r\n                                        <canvas ref={canvasRef} className=\"hidden\" />\r\n\r\n                                        <div className=\"absolute bottom-4 left-0 right-0 flex justify-center gap-4\">\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={stopCamera}\r\n                                                className=\"p-3 bg-white/20 backdrop-blur-md rounded-full text-white hover:bg-white/30\"\r\n                                            >\r\n                                                <X size={24} />\r\n                                            </button>\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={capturePhoto}\r\n                                                className=\"p-4 bg-white rounded-full text-black shadow-lg hover:scale-105 transition\"\r\n                                            >\r\n                                                <Camera size={28} />\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Photo Previews */}\r\n                                    <div className=\"flex flex-wrap gap-2 mt-2 max-h-[200px] overflow-y-auto\">\r\n                                        {previewUrls.map((url, index) => (\r\n                                            <div key={index} className=\"relative w-24 h-24 rounded-lg overflow-hidden border\">\r\n                                                <img src={url} alt={`Preview ${index + 1}`} className=\"w-full h-full object-cover\" />\r\n                                                <button\r\n                                                    type=\"button\"\r\n                                                    onClick={() => handleRemovePhoto(index)}\r\n                                                    className=\"absolute top-1 right-1 p-0.5 bg-black/50 text-white rounded-full hover:bg-black/70\"\r\n                                                >\r\n                                                    <X size={14} />\r\n                                                </button>\r\n                                            </div>\r\n                                        ))}\r\n                                        {previewUrls.length === 0 && !isCameraActive && (\r\n                                            <div className=\"flex flex-col items-center justify-center flex-grow p-4 text-center text-gray-500\">\r\n                                                <ImageIcon className=\"w-10 h-10 mb-2\" />\r\n                                                <p className=\"text-sm\">Aucune photo ajoutée</p>\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <DialogFooter className=\"p-4 border-t bg-gray-50 flex justify-end gap-3 sm:justify-end\">\r\n                        <Button variant=\"outline\" onClick={onClose} disabled={loading} className=\"px-5 py-2.5 h-auto font-medium\">\r\n                            Annuler\r\n                        </Button>\r\n                        <Button\r\n                            className=\"bg-[#d61353] hover:bg-[#b01044] px-5 py-2.5 h-auto font-medium shadow-sm\"\r\n                            onClick={handleSubmit}\r\n                            disabled={loading}\r\n                        >\r\n                            {loading ? \"Déclaration en cours...\" : \"Déclarer l'Incident\"}\r\n                        </Button>\r\n                    </DialogFooter>\r\n                </DialogContent>\r\n            </Dialog>\r\n            {/* The dialog for adding a new type */}\r\n            <AddTypeIncidentDialog\r\n                isOpen={isAddTypeDialogOpen}\r\n                onClose={() => setIsAddTypeDialogOpen(false)}\r\n                onTypeAdded={handleTypeAdded}\r\n            />\r\n        </>\r\n    );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\prestataires\\AddMaterielCaseModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UploadCloud' is defined but never used.","line":23,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Check' is defined but never used.","line":23,"column":94,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":99},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'captureMode' is assigned a value but never used.","line":58,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":58,"endColumn":23},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'resetPhoto'. Either include it or remove the dependency array.","line":81,"column":8,"nodeType":"ArrayExpression","endLine":81,"endColumn":30,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, affectations, resetPhoto]","fix":{"range":[2509,2531],"text":"[isOpen, affectations, resetPhoto]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":389,"column":41,"nodeType":"JSXOpeningElement","endLine":389,"endColumn":120}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useAuth } from \"@/app/context/AuthContext\";\r\nimport { toast } from \"react-toastify\";\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogHeader,\r\n    DialogTitle,\r\n    DialogFooter\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue\r\n} from \"@/components/ui/select\";\r\nimport { UploadCloud, AlertTriangle, Info, Camera, X, Image as ImageIcon, RotateCcw, Upload, Check } from \"lucide-react\";\r\nimport { useRef } from \"react\";\r\n\r\ninterface Affectation {\r\n    campagne: {\r\n        id_campagne: string;\r\n        nom_campagne: string;\r\n    };\r\n}\r\n\r\ninterface AddMaterielCaseModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    prestataireId: string;\r\n    affectations: Affectation[];\r\n    onIncidentAdded: () => void;\r\n}\r\n\r\nexport default function AddMaterielCaseModal({\r\n    isOpen,\r\n    onClose,\r\n    prestataireId,\r\n    affectations,\r\n    onIncidentAdded\r\n}: AddMaterielCaseModalProps) {\r\n    const { apiClient } = useAuth();\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    // Form states\r\n    const [selectedCampagne, setSelectedCampagne] = useState<string>(\"\");\r\n    const [etat, setEtat] = useState<\"BON\" | \"MOYEN\" | \"MAUVAIS\">(\"MAUVAIS\");\r\n    const [description, setDescription] = useState(\"\");\r\n\r\n    // Photo Capture State\r\n    type CaptureMode = 'FILE' | 'CAMERA';\r\n    const [captureMode, setCaptureMode] = useState<CaptureMode>('FILE');\r\n    const [selectedFile, setSelectedFile] = useState<File | null>(null);\r\n    const [previewUrl, setPreviewUrl] = useState<string | null>(null);\r\n    const [isCameraActive, setIsCameraActive] = useState(false);\r\n\r\n    const videoRef = useRef<HTMLVideoElement>(null);\r\n    const canvasRef = useRef<HTMLCanvasElement>(null);\r\n    const streamRef = useRef<MediaStream | null>(null);\r\n    const nativeCameraInputRef = useRef<HTMLInputElement>(null);\r\n\r\n    // Reset form when opening\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            if (affectations.length > 0) {\r\n                setSelectedCampagne(affectations[0].campagne.id_campagne);\r\n            }\r\n            setEtat(\"MAUVAIS\");\r\n            setDescription(\"\");\r\n            resetPhoto();\r\n        }\r\n        return () => {\r\n            stopCamera();\r\n        };\r\n    }, [isOpen, affectations]);\r\n\r\n    // --- Camera Logic ---\r\n    const startCamera = async () => {\r\n        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\r\n            console.warn(\"Camera API not available, falling back to native input\");\r\n            nativeCameraInputRef.current?.click();\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const stream = await navigator.mediaDevices.getUserMedia({\r\n                video: { facingMode: \"environment\" }\r\n            });\r\n            streamRef.current = stream;\r\n            if (videoRef.current) {\r\n                videoRef.current.srcObject = stream;\r\n            }\r\n            setIsCameraActive(true);\r\n        } catch (err) {\r\n            console.error(\"Impossible d'accéder à la caméra\", err);\r\n            toast.info(\"Caméra inapprochable, ouverture de l'appareil photo natif...\");\r\n            nativeCameraInputRef.current?.click();\r\n        }\r\n    };\r\n\r\n    const stopCamera = () => {\r\n        if (streamRef.current) {\r\n            streamRef.current.getTracks().forEach(track => track.stop());\r\n            streamRef.current = null;\r\n        }\r\n        setIsCameraActive(false);\r\n    };\r\n\r\n    const capturePhoto = () => {\r\n        if (videoRef.current && canvasRef.current) {\r\n            const video = videoRef.current;\r\n            const canvas = canvasRef.current;\r\n\r\n            canvas.width = video.videoWidth;\r\n            canvas.height = video.videoHeight;\r\n\r\n            const ctx = canvas.getContext('2d');\r\n            if (ctx) {\r\n                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);\r\n                canvas.toBlob((blob) => {\r\n                    if (blob) {\r\n                        const file = new File([blob], \"capture.jpg\", { type: \"image/jpeg\" });\r\n                        handleFileSelection(file);\r\n                        stopCamera();\r\n                    }\r\n                }, 'image/jpeg', 0.8);\r\n            }\r\n        }\r\n    };\r\n\r\n    // --- File Handling ---\r\n    const handleFileSelection = (file: File) => {\r\n        setSelectedFile(file);\r\n        const url = URL.createObjectURL(file);\r\n        setPreviewUrl(url);\r\n    };\r\n\r\n    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (e.target.files && e.target.files[0]) {\r\n            handleFileSelection(e.target.files[0]);\r\n        }\r\n    };\r\n\r\n    const resetPhoto = () => {\r\n        setSelectedFile(null);\r\n        setPreviewUrl(null);\r\n        stopCamera();\r\n        setCaptureMode('FILE');\r\n    };\r\n\r\n    const handleSubmit = async () => {\r\n        if (!selectedCampagne) {\r\n            toast.error(\"Veuillez sélectionner une campagne.\");\r\n            return;\r\n        }\r\n        // Description is optional or required depending on rules, but user strict check was here.\r\n        // Keeping strict check as per original code.\r\n        if (!description.trim()) {\r\n            toast.error(\"Veuillez fournir une description.\");\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        try {\r\n            let photoUrl: string | null = null;\r\n\r\n            // 1. Upload Photo if exists\r\n            if (selectedFile) {\r\n                const formData = new FormData();\r\n                formData.append(\"file\", selectedFile);\r\n\r\n                const uploadRes = await apiClient(\"/api/materiels-cases/upload\", {\r\n                    method: \"POST\",\r\n                    body: formData,\r\n                });\r\n\r\n                if (!uploadRes.ok) {\r\n                    throw new Error(\"Erreur lors de l'upload de l'image\");\r\n                }\r\n\r\n                const uploadJson = await uploadRes.json();\r\n                photoUrl = uploadJson.url;\r\n            }\r\n\r\n            // Payload\r\n            const payload = {\r\n                id_prestataire: prestataireId,\r\n                id_campagne: selectedCampagne,\r\n                nom_materiel: \"Matériel Publicitaire\", // Default as per modal logic\r\n                etat,\r\n                description,\r\n                photo_url: photoUrl\r\n            };\r\n\r\n            const res = await apiClient(\"/api/materiels-cases\", {\r\n                method: \"POST\",\r\n                headers: { \"Content-Type\": \"application/json\" },\r\n                body: JSON.stringify(payload),\r\n            });\r\n\r\n            if (!res.ok) {\r\n                const body = await res.json().catch(() => ({}));\r\n                throw new Error(body.error || \"Erreur lors de la déclaration de l'incident\");\r\n            }\r\n\r\n            toast.success(\"Incident déclaré avec succès.\");\r\n            onIncidentAdded();\r\n            onClose();\r\n        } catch (err) {\r\n            console.error(\"Erreur incident:\", err);\r\n            toast.error(err instanceof Error ? err.message : \"Erreur inconnue\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\r\n            <DialogContent className=\"sm:max-w-4xl bg-white p-0 overflow-hidden\">\r\n                <DialogHeader className=\"p-4 border-b bg-gray-50 flex flex-row items-center justify-between space-y-0\">\r\n                    <DialogTitle className=\"flex items-center gap-2 text-xl font-bold text-gray-800\">\r\n                        <AlertTriangle className=\"w-5 h-5 text-[#d61353]\" />\r\n                        Déclaration Matériel Endommagé\r\n                    </DialogTitle>\r\n                </DialogHeader>\r\n\r\n                <div className=\"p-6 overflow-y-auto max-h-[80vh]\">\r\n                    <div className=\"grid md:grid-cols-2 gap-6\">\r\n                        {/* Left Column: Form Details */}\r\n                        <div className=\"space-y-4\">\r\n                            {/* Campagne */}\r\n                            <div className=\"space-y-1\">\r\n                                <Label className=\"block text-sm font-medium text-gray-700\">Campagne Concernée</Label>\r\n                                <Select value={selectedCampagne} onValueChange={setSelectedCampagne}>\r\n                                    <SelectTrigger className=\"w-full border rounded-lg p-2.5 bg-white\">\r\n                                        <SelectValue placeholder=\"Sélectionner une campagne\" />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        {affectations.length === 0 ? (\r\n                                            <SelectItem value=\"none\" disabled>Aucune campagne active</SelectItem>\r\n                                        ) : (\r\n                                            affectations.map((aff) => (\r\n                                                <SelectItem key={aff.campagne.id_campagne} value={aff.campagne.id_campagne}>\r\n                                                    {aff.campagne.nom_campagne}\r\n                                                </SelectItem>\r\n                                            ))\r\n                                        )}\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n\r\n                            {/* État */}\r\n                            <div className=\"space-y-1\">\r\n                                <Label className=\"block text-sm font-medium text-gray-700\">État du Matériel</Label>\r\n                                <div className=\"grid grid-cols-3 gap-2\">\r\n                                    {([\"BON\", \"MOYEN\", \"MAUVAIS\"] as const).map((e) => (\r\n                                        <button\r\n                                            key={e}\r\n                                            type=\"button\"\r\n                                            onClick={() => setEtat(e)}\r\n                                            className={`py-2 rounded-lg text-sm font-medium border transition ${etat === e\r\n                                                ? (e === 'BON' ? 'bg-green-100 border-green-300 text-green-800 ring-2 ring-green-500' :\r\n                                                    e === 'MOYEN' ? 'bg-yellow-100 border-yellow-300 text-yellow-800 ring-2 ring-yellow-500' :\r\n                                                        'bg-red-100 border-red-300 text-red-800 ring-2 ring-red-500')\r\n                                                : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-50'\r\n                                                }`}\r\n                                        >\r\n                                            {e}\r\n                                        </button>\r\n                                    ))}\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Description */}\r\n                            <div className=\"space-y-1\">\r\n                                <Label className=\"block text-sm font-medium text-gray-700\">Description / Observations</Label>\r\n                                <Textarea\r\n                                    rows={4}\r\n                                    placeholder=\"Détails sur l'incident ou l'état (ex: Déchirure, panne...)\"\r\n                                    value={description}\r\n                                    onChange={(e) => setDescription(e.target.value)}\r\n                                    className=\"w-full border rounded-lg p-2.5 resize-none focus:ring-2 focus:ring-black focus:border-black outline-none\"\r\n                                />\r\n                            </div>\r\n\r\n                            {/* Info message about automatic penalty calculation */}\r\n                            <div className=\"flex items-start gap-2 border p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800\">\r\n                                <Info className=\"w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5\" />\r\n                                <div className=\"space-y-0.5\">\r\n                                    <p className=\"text-sm font-medium text-blue-900 dark:text-blue-100\">\r\n                                        Calcul automatique des pénalités\r\n                                    </p>\r\n                                    <p className=\"text-xs text-blue-700 dark:text-blue-300\">\r\n                                        Si l&apos;état est MAUVAIS, une pénalité sera automatiquement appliquée.\r\n                                    </p>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Right Column: Photo Evidence */}\r\n                        <div className=\"flex flex-col space-y-1\">\r\n                            <Label className=\"block text-sm font-medium text-gray-700\">Preuve Photo (Recommandé)</Label>\r\n\r\n                            <div className=\"flex-1 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-900 overflow-hidden flex flex-col relative min-h-[350px]\">\r\n\r\n                                {!previewUrl && !isCameraActive && (\r\n                                    <div className=\"absolute inset-0 flex flex-col items-center justify-center p-6 text-center\">\r\n                                        <ImageIcon className=\"w-12 h-12 text-gray-300 mb-3\" />\r\n                                        <p className=\"text-gray-500 text-sm mb-4\">Ajoutez une photo pour prouver l&apos;état</p>\r\n\r\n                                        <div className=\"flex gap-3\">\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={() => document.getElementById('incident-file-upload')?.click()}\r\n                                                className=\"flex items-center gap-2 px-4 py-2 bg-white border shadow-sm rounded-lg hover:bg-gray-50 text-sm font-medium transition\"\r\n                                            >\r\n                                                <Upload size={16} />\r\n                                                Importer\r\n                                            </button>\r\n                                            <input\r\n                                                id=\"incident-file-upload\"\r\n                                                type=\"file\"\r\n                                                accept=\"image/*\"\r\n                                                className=\"hidden\"\r\n                                                onChange={handleFileChange}\r\n                                            />\r\n                                            <input\r\n                                                ref={nativeCameraInputRef}\r\n                                                type=\"file\"\r\n                                                accept=\"image/*\"\r\n                                                capture=\"environment\"\r\n                                                className=\"hidden\"\r\n                                                onChange={handleFileChange}\r\n                                            />\r\n\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={() => {\r\n                                                    setCaptureMode('CAMERA');\r\n                                                    startCamera();\r\n                                                }}\r\n                                                className=\"flex items-center gap-2 px-4 py-2 bg-black text-white shadow-sm rounded-lg hover:bg-gray-800 text-sm font-medium transition\"\r\n                                            >\r\n                                                <Camera size={16} />\r\n                                                Photo\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {/* Camera View */}\r\n                                <div className={`flex-1 relative bg-black ${isCameraActive ? 'block' : 'hidden'}`}>\r\n                                    <video\r\n                                        ref={videoRef}\r\n                                        autoPlay\r\n                                        playsInline\r\n                                        muted\r\n                                        className=\"w-full h-full object-cover\"\r\n                                    />\r\n                                    <canvas ref={canvasRef} className=\"hidden\" />\r\n\r\n                                    <div className=\"absolute bottom-4 left-0 right-0 flex justify-center gap-4\">\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={stopCamera}\r\n                                            className=\"p-3 bg-white/20 backdrop-blur-md rounded-full text-white hover:bg-white/30\"\r\n                                        >\r\n                                            <X size={24} />\r\n                                        </button>\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={capturePhoto}\r\n                                            className=\"p-4 bg-white rounded-full text-black shadow-lg hover:scale-105 transition\"\r\n                                        >\r\n                                            <Camera size={28} />\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Photo Preview */}\r\n                                {previewUrl && !isCameraActive && (\r\n                                    <div className=\"absolute inset-0 bg-black\">\r\n                                        <img src={previewUrl} alt=\"Preview\" className=\"w-full h-full object-contain\" />\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={() => {\r\n                                                resetPhoto();\r\n                                                setCaptureMode('FILE');\r\n                                            }}\r\n                                            className=\"absolute top-2 right-2 p-2 bg-black/50 text-white rounded-full hover:bg-black/70 backdrop-blur-sm\"\r\n                                        >\r\n                                            <RotateCcw size={20} />\r\n                                        </button>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <DialogFooter className=\"p-4 border-t bg-gray-50 flex justify-end gap-3 sm:justify-end\">\r\n                    <Button variant=\"outline\" onClick={onClose} disabled={loading} className=\"px-5 py-2.5 h-auto font-medium\">\r\n                        Annuler\r\n                    </Button>\r\n                    <Button\r\n                        className=\"bg-[#d61353] hover:bg-[#b01044] px-5 py-2.5 h-auto font-medium shadow-sm\"\r\n                        onClick={handleSubmit}\r\n                        disabled={loading}\r\n                    >\r\n                        {loading ? \"Enregistrement...\" : \"Enregistrer la validation\"}\r\n                    </Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\prestataires\\AddPrestataire.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Camera' is defined but never used.","line":6,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":32},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":400,"column":23,"nodeType":"JSXOpeningElement","endLine":400,"endColumn":107}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useRef } from \"react\"\r\nimport { useFormik } from \"formik\"\r\nimport * as Yup from \"yup\"\r\nimport { X, UploadCloud, Camera, Image as ImageIcon } from \"lucide-react\"\r\nimport { useAuth } from \"@/app/context/AuthContext\"\r\nimport { toast } from \"react-toastify\"\r\nimport { Button } from \"@/components/ui/button\"\r\n\r\ninterface Service {\r\n  id_service: string\r\n  nom: string\r\n}\r\n\r\ninterface Prestataire {\r\n  id_prestataire: string\r\n  nom: string\r\n  prenom: string\r\n  contact?: string\r\n  modele?: string\r\n  type_panneau?: string\r\n  couleur?: string\r\n  marque?: string\r\n  plaque?: string\r\n  id_verification?: string\r\n  contrat_valide?: boolean\r\n  equipe_gps?: boolean\r\n  service?: { nom?: string }\r\n  disponible: boolean\r\n  photos?: { url: string }[]\r\n}\r\n\r\ninterface AddPrestaireModalProps {\r\n  isOpen: boolean\r\n  onClose: () => void\r\n  onAddPrestataire: (prestataire: Prestataire) => void\r\n}\r\n\r\n// Validation schema\r\nconst validationSchema = Yup.object().shape({\r\n  nom: Yup.string().required(\"Le nom est requis\"),\r\n  prenom: Yup.string().required(\"Le prénom est requis\"),\r\n  contact: Yup.string().required(\"Le contact est requis\"),\r\n  id_service: Yup.string().required(\"Le service est requis\"),\r\n  disponible: Yup.boolean(),\r\n  type_panneau: Yup.string(),\r\n  couleur: Yup.string(),\r\n  marque: Yup.string(),\r\n  modele: Yup.string(),\r\n  plaque: Yup.string(),\r\n  contrat_valide: Yup.boolean(),\r\n  equipe_gps: Yup.boolean(),\r\n})\r\n\r\nexport default function AddPrestaireModal({ isOpen, onClose, onAddPrestataire }: AddPrestaireModalProps) {\r\n  const { apiClient } = useAuth()\r\n  const [submitting, setSubmitting] = useState(false)\r\n  const [services, setServices] = useState<Service[]>([])\r\n\r\n  // Photo states\r\n  const [photos, setPhotos] = useState<File[]>([])\r\n  const [previewUrls, setPreviewUrls] = useState<string[]>([])\r\n  const fileInputRef = useRef<HTMLInputElement>(null)\r\n\r\n  // Charger les services au montage ou quand le modal s'ouvre\r\n  useEffect(() => {\r\n    const fetchServices = async () => {\r\n      if (services.length > 0) return\r\n      try {\r\n        const res = await apiClient(\"/api/services?page=1&limit=100\")\r\n        if (!res.ok) throw new Error(\"Erreur lors du chargement des services\")\r\n        const data = await res.json()\r\n        setServices(data.services || [])\r\n      } catch (err) {\r\n        console.error(\"Erreur services:\", err)\r\n        toast.error(\"Impossible de charger les services\")\r\n      }\r\n    }\r\n\r\n    if (isOpen) {\r\n      fetchServices()\r\n      // Reset photos on open\r\n      setPhotos([])\r\n      setPreviewUrls(prev => {\r\n        prev.forEach(url => URL.revokeObjectURL(url));\r\n        return [];\r\n      })\r\n    }\r\n  }, [isOpen, apiClient, services.length])\r\n\r\n  // --- Photo Handling ---\r\n  const handleAddPhoto = (file: File) => {\r\n    setPhotos(prev => [...prev, file])\r\n    setPreviewUrls(prev => [...prev, URL.createObjectURL(file)])\r\n  }\r\n\r\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    if (e.target.files) {\r\n      Array.from(e.target.files).forEach(file => handleAddPhoto(file))\r\n    }\r\n  }\r\n\r\n  const handleRemovePhoto = (indexToRemove: number) => {\r\n    setPhotos(prev => prev.filter((_, index) => index !== indexToRemove))\r\n    setPreviewUrls(prev => {\r\n      URL.revokeObjectURL(prev[indexToRemove])\r\n      return prev.filter((_, index) => index !== indexToRemove)\r\n    })\r\n  }\r\n\r\n  const formik = useFormik({\r\n    initialValues: {\r\n      nom: \"\",\r\n      prenom: \"\",\r\n      contact: \"\",\r\n      id_service: \"\",\r\n      disponible: true,\r\n      type_panneau: \"\",\r\n      couleur: \"\",\r\n      marque: \"\",\r\n      modele: \"\",\r\n      plaque: \"\",\r\n      contrat_valide: false,\r\n      equipe_gps: false,\r\n    },\r\n    validationSchema,\r\n    onSubmit: async (values) => {\r\n      setSubmitting(true)\r\n      try {\r\n        // 1. Upload photos first\r\n        const uploadedPhotoUrls: string[] = []\r\n        for (const photoFile of photos) {\r\n          const formData = new FormData()\r\n          formData.append(\"file\", photoFile)\r\n\r\n          const uploadRes = await apiClient(\"/api/prestataires/upload\", {\r\n            method: \"POST\",\r\n            body: formData,\r\n          })\r\n\r\n          if (!uploadRes.ok) {\r\n            throw new Error(`Erreur upload photo: ${photoFile.name}`)\r\n          }\r\n\r\n          const uploadJson = await uploadRes.json()\r\n          uploadedPhotoUrls.push(uploadJson.url)\r\n        }\r\n\r\n        // 2. Create Prestataire\r\n        const body = {\r\n          id_service: values.id_service,\r\n          nom: values.nom,\r\n          prenom: values.prenom,\r\n          contact: values.contact,\r\n          disponible: values.disponible,\r\n          type_panneau: values.type_panneau || null,\r\n          couleur: values.couleur || null,\r\n          marque: values.marque || null,\r\n          modele: values.modele || null,\r\n          plaque: values.plaque || null,\r\n          contrat_valide: values.contrat_valide,\r\n          equipe_gps: values.equipe_gps,\r\n          photos: uploadedPhotoUrls // Attach photo URLs\r\n        }\r\n\r\n        const res = await apiClient(\"/api/prestataires?page=1&limit=50\", {\r\n          method: \"POST\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n          },\r\n          body: JSON.stringify(body),\r\n        })\r\n\r\n        if (!res.ok) {\r\n          const err = await res.json().catch(() => ({})) as Record<string, unknown>\r\n          const msg = typeof err?.error === \"string\" ? err.error : \"Erreur lors de la création\"\r\n          throw new Error(msg)\r\n        }\r\n\r\n        const data = await res.json()\r\n        const created: Prestataire = data.prestataire\r\n        toast.success(data.message || \"Prestataire créé\")\r\n        onAddPrestataire(created)\r\n        formik.resetForm()\r\n        onClose()\r\n      } catch (err: unknown) {\r\n        console.error(err)\r\n        const msg = err instanceof Error ? err.message : \"Erreur lors de la création\"\r\n        toast.error(msg)\r\n      } finally {\r\n        setSubmitting(false)\r\n      }\r\n    },\r\n  })\r\n\r\n  if (!isOpen) return null\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\r\n      <div className=\"fixed inset-0 bg-black/40 backdrop-blur-sm\" onClick={onClose} />\r\n      <div className=\"relative z-10 bg-white dark:bg-gray-900 rounded-lg shadow-xl w-[90%] max-w-2xl p-6 border border-gray-200 dark:border-gray-700 max-h-[90vh] overflow-y-auto\">\r\n        <div className=\"flex items-center justify-between mb-4\">\r\n          <h3 className=\"text-lg font-bold text-[#d61353]\">Ajouter un prestataire</h3>\r\n          <button onClick={onClose} className=\"text-gray-600 hover:text-[#d61353] transition\">\r\n            <X className=\"w-5 h-5\" />\r\n          </button>\r\n        </div>\r\n\r\n        <form onSubmit={formik.handleSubmit}>\r\n          {/* === INFORMATIONS PERSONNELLES === */}\r\n          <h4 className=\"text-sm font-semibold text-[#d61353] mb-3 border-b pb-2\">Informations personnelles</h4>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Nom *</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"nom\"\r\n                value={formik.values.nom}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className={`w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 ${formik.touched.nom && formik.errors.nom\r\n                  ? \"border-red-500\"\r\n                  : \"border-gray-300 dark:border-gray-600\"\r\n                  }`}\r\n                placeholder=\"Ex: Dupont\"\r\n              />\r\n              {formik.touched.nom && formik.errors.nom && (\r\n                <p className=\"text-red-500 text-xs mt-1\">{formik.errors.nom}</p>\r\n              )}\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Prénom *</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"prenom\"\r\n                value={formik.values.prenom}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className={`w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 ${formik.touched.prenom && formik.errors.prenom\r\n                  ? \"border-red-500\"\r\n                  : \"border-gray-300 dark:border-gray-600\"\r\n                  }`}\r\n                placeholder=\"Ex: Jean\"\r\n              />\r\n              {formik.touched.prenom && formik.errors.prenom && (\r\n                <p className=\"text-red-500 text-xs mt-1\">{formik.errors.prenom}</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Service *</label>\r\n              <select\r\n                name=\"id_service\"\r\n                value={formik.values.id_service}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className={`w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 ${formik.touched.id_service && formik.errors.id_service\r\n                  ? \"border-red-500\"\r\n                  : \"border-gray-300 dark:border-gray-600\"\r\n                  }`}\r\n              >\r\n                <option value=\"\">-- Sélectionner un service --</option>\r\n                {services.map((service) => (\r\n                  <option key={service.id_service} value={service.id_service}>\r\n                    {service.nom}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n              {formik.touched.id_service && formik.errors.id_service && (\r\n                <p className=\"text-red-500 text-xs mt-1\">{formik.errors.id_service}</p>\r\n              )}\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Contact *</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"contact\"\r\n                value={formik.values.contact}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className={`w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 ${formik.touched.contact && formik.errors.contact\r\n                  ? \"border-red-500\"\r\n                  : \"border-gray-300 dark:border-gray-600\"\r\n                  }`}\r\n                placeholder=\"Ex: 06 12 34 56 78\"\r\n              />\r\n              {formik.touched.contact && formik.errors.contact && (\r\n                <p className=\"text-red-500 text-xs mt-1\">{formik.errors.contact}</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* === VÉHICULE === */}\r\n          <h4 className=\"text-sm font-semibold text-[#d61353] mb-3 border-b pb-2\">Informations véhicule</h4>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Type de panneau</label>\r\n              <select\r\n                name=\"type_panneau\"\r\n                value={formik.values.type_panneau}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className=\"w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 border-gray-300 dark:border-gray-600\"\r\n              >\r\n                <option value=\"\">--Sélectionner--</option>\r\n                <option value=\"PETIT\">PETIT</option>\r\n                <option value=\"GRAND\">GRAND</option>\r\n              </select>\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Marque</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"marque\"\r\n                value={formik.values.marque}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className=\"w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 border-gray-300 dark:border-gray-600\"\r\n                placeholder=\"Ex: Toyota\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Modèle</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"modele\"\r\n                value={formik.values.modele}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className=\"w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 border-gray-300 dark:border-gray-600\"\r\n                placeholder=\"Ex: Hiace\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Couleur</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"couleur\"\r\n                value={formik.values.couleur}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className=\"w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 border-gray-300 dark:border-gray-600\"\r\n                placeholder=\"Ex: Blanc\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Plaque (immatriculation)</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"plaque\"\r\n                value={formik.values.plaque}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className=\"w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 border-gray-300 dark:border-gray-600\"\r\n                placeholder=\"Ex: AB-123-CD\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* === PHOTOS === */}\r\n          <h4 className=\"text-sm font-semibold text-[#d61353] mb-3 border-b pb-2\">Photos (Optionnel)</h4>\r\n          <div className=\"mb-6\">\r\n            <div className=\"flex flex-col space-y-2\">\r\n              <div className=\"flex-1 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-900 p-4\">\r\n                <div className=\"flex justify-center gap-3 mb-4\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => fileInputRef.current?.click()}\r\n                    className=\"flex items-center gap-2 px-4 py-2 bg-white border shadow-sm rounded-lg hover:bg-gray-50 text-sm font-medium transition\"\r\n                  >\r\n                    <UploadCloud size={16} />\r\n                    Ajouter des photos\r\n                  </button>\r\n                  <input\r\n                    ref={fileInputRef}\r\n                    type=\"file\"\r\n                    accept=\"image/*\"\r\n                    multiple\r\n                    className=\"hidden\"\r\n                    onChange={handleFileChange}\r\n                  />\r\n                </div>\r\n\r\n                {/* Previews */}\r\n                <div className=\"flex flex-wrap gap-2 justify-center max-h-[200px] overflow-y-auto\">\r\n                  {previewUrls.map((url, index) => (\r\n                    <div key={index} className=\"relative w-24 h-24 rounded-lg overflow-hidden border\">\r\n                      <img src={url} alt={`Aperçu ${index + 1}`} className=\"w-full h-full object-cover\" />\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => handleRemovePhoto(index)}\r\n                        className=\"absolute top-1 right-1 p-0.5 bg-black/50 text-white rounded-full hover:bg-black/70\"\r\n                      >\r\n                        <X size={14} />\r\n                      </button>\r\n                    </div>\r\n                  ))}\r\n                  {previewUrls.length === 0 && (\r\n                    <div className=\"flex flex-col items-center justify-center py-4 text-center text-gray-400\">\r\n                      <ImageIcon className=\"w-8 h-8 mb-1 opacity-50\" />\r\n                      <p className=\"text-xs\">Aucune photo sélectionnée</p>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* === DISPONIBILITÉ === */}\r\n          <h4 className=\"text-sm font-semibold text-[#d61353] mb-3 border-b pb-2\">Statut</h4>\r\n\r\n          <div className=\"space-y-3 mb-6\">\r\n            <label className=\"flex items-center gap-2 cursor-pointer\">\r\n              <input\r\n                type=\"checkbox\"\r\n                name=\"disponible\"\r\n                checked={formik.values.disponible}\r\n                onChange={formik.handleChange}\r\n                className=\"w-4 h-4 rounded\"\r\n              />\r\n              <span className=\"text-sm font-medium\">Disponible</span>\r\n            </label>\r\n            <label className=\"flex items-center gap-2 cursor-pointer\">\r\n              <input\r\n                type=\"checkbox\"\r\n                name=\"contrat_valide\"\r\n                checked={!!formik.values.contrat_valide}\r\n                onChange={(e) => formik.setFieldValue('contrat_valide', e.target.checked)}\r\n                className=\"w-4 h-4 rounded\"\r\n              />\r\n              <span className=\"text-sm font-medium\">Contrat Validé</span>\r\n            </label>\r\n            <label className=\"flex items-center gap-2 cursor-pointer\">\r\n              <input\r\n                type=\"checkbox\"\r\n                name=\"equipe_gps\"\r\n                checked={!!formik.values.equipe_gps}\r\n                onChange={(e) => formik.setFieldValue('equipe_gps', e.target.checked)}\r\n                className=\"w-4 h-4 rounded\"\r\n              />\r\n              <span className=\"text-sm font-medium\">Équipé GPS</span>\r\n            </label>\r\n          </div>\r\n\r\n          {/* Buttons */}\r\n          <div className=\"flex justify-between gap-3 pt-4 border-t border-gray-200 dark:border-gray-700\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={onClose}\r\n              disabled={submitting}\r\n              className=\"px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 disabled:opacity-50 transition\"\r\n            >\r\n              Annuler\r\n            </button>\r\n            <Button\r\n              type=\"submit\"\r\n              loading={submitting}\r\n              className=\"px-4 py-2 rounded-lg bg-[#d61353] hover:bg-[#b01044] text-white disabled:opacity-50 transition\"\r\n            >\r\n              Créer\r\n            </Button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\prestataires\\DeletePrestataire.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\prestataires\\DetailPrestataire.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":191,"column":19,"nodeType":"JSXOpeningElement","endLine":195,"endColumn":21},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":303,"column":29,"nodeType":"JSXOpeningElement","endLine":307,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { ArrowLeft, Users, User, Phone, Briefcase, Car, Palette, Fingerprint, ShieldCheck, Wrench, Calendar, Hash, AlertTriangle, FileText } from \"lucide-react\"\r\nimport Link from \"next/link\"\r\nimport { useState, useEffect, useCallback } from \"react\"\r\nimport { useAuth } from \"@/app/context/AuthContext\"\r\nimport { toast } from \"react-toastify\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\"\r\nimport AddMaterielCaseModal from \"./AddMaterielCaseModal\"\r\nimport AddIncidentModal from \"./AddIncidentModal\"\r\n\r\n// Interfaces (gardées telles quelles)\r\ninterface Service {\r\n  id_service: string\r\n  nom: string\r\n  description?: string\r\n}\r\ninterface Affectation {\r\n  campagne: { id_campagne: string; nom_campagne: string; date_debut: string; date_fin: string; status: string }\r\n  date_creation: string\r\n  status?: string\r\n}\r\ninterface Dommage {\r\n  id_materiels_case: string; etat: string; description: string; montant_penalite: number; penalite_appliquer: boolean; date_creation: string; campagne?: { nom_campagne: string }\r\n}\r\ninterface IncidentPhoto {\r\n  id_photo: string\r\n  url: string\r\n  created_at: string\r\n}\r\ninterface Incident {\r\n  id_incident: string\r\n  id_prestataire: string\r\n  date_incident: string\r\n  commentaire: string\r\n  created_at: string\r\n  type_incident: {\r\n    id_type_incident: string\r\n    nom: string\r\n    description?: string\r\n  }\r\n  photos: IncidentPhoto[]\r\n}\r\ninterface PrestatairePhoto {\r\n  id_photo: string\r\n  url: string\r\n}\r\ninterface PrestataireFichier {\r\n  id_fichier: string\r\n  url: string\r\n  nom: string\r\n  type?: string\r\n}\r\ninterface Prestataire {\r\n  id_prestataire: string; nom: string; prenom: string; contact: string; disponible: boolean; type_panneau?: string | null; couleur?: string | null; marque?: string | null; modele?: string | null; plaque?: string | null; id_verification?: string | null; service?: Service; created_at?: string; updated_at?: string; affectations?: Affectation[]; dommages?: Dommage[]; incidents?: Incident[]; photos?: PrestatairePhoto[]; fichiers?: PrestataireFichier[]; _count?: { affectations: number; dommages: number; incidents: number }\r\n}\r\n\r\n// Composant pour afficher une information\r\nconst InfoItem = ({ icon, label, value }: { icon: React.ReactNode; label: string; value: React.ReactNode }) => (\r\n  <div className=\"flex items-start gap-3\">\r\n    <div className=\"text-gray-500 dark:text-gray-400 mt-1\">{icon}</div>\r\n    <div>\r\n      <p className=\"text-sm font-medium text-gray-600 dark:text-gray-300\">{label}</p>\r\n      <p className=\"text-base font-semibold\">{value || \"-\"}</p>\r\n    </div>\r\n  </div>\r\n);\r\n\r\n// Composant pour le badge de disponibilité\r\nconst AvailabilityBadge = ({ available }: { available: boolean }) => (\r\n  <Badge variant={available ? \"success\" : \"destructive\"}>\r\n    {available ? \"Disponible\" : \"Non disponible\"}\r\n  </Badge>\r\n);\r\n\r\nexport default function DetailPrestataire({ id }: { id: string }) {\r\n  const { apiClient } = useAuth()\r\n  const [prestataire, setPrestataire] = useState<Prestataire | null>(null)\r\n  const [incidents, setIncidents] = useState<Incident[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [isMaterielCaseModalOpen, setIsMaterielCaseModalOpen] = useState(false)\r\n  const [isIncidentModalOpen, setIsIncidentModalOpen] = useState(false)\r\n\r\n  const fetchPrestataire = useCallback(async () => {\r\n    if (!id) return;\r\n    setLoading(true)\r\n    try {\r\n      const res = await apiClient(`/api/prestataires/${id}`)\r\n      if (!res.ok) throw new Error(\"Erreur lors du chargement du prestataire\")\r\n      const data = await res.json()\r\n      setPrestataire(data.prestataire)\r\n    } catch (err) {\r\n      console.error(\"Erreur fetch prestataire:\", err)\r\n      const msg = err instanceof Error ? err.message : \"Erreur lors du chargement\"\r\n      toast.error(msg)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [id, apiClient]);\r\n\r\n  const fetchIncidents = useCallback(async () => {\r\n    if (!id) return;\r\n    try {\r\n      const res = await apiClient(`/api/incidents?prestataireId=${id}`)\r\n      if (!res.ok) throw new Error(\"Erreur lors du chargement des incidents\")\r\n      const data = await res.json()\r\n      setIncidents(data)\r\n    } catch (err) {\r\n      console.error(\"Erreur fetch incidents:\", err)\r\n    }\r\n  }, [id, apiClient]);\r\n\r\n  useEffect(() => {\r\n    fetchPrestataire()\r\n    fetchIncidents()\r\n  }, [fetchPrestataire, fetchIncidents])\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex flex-col items-center justify-center py-10\">\r\n        <div className=\"w-10 h-10 border-4 border-[#d61353]/30 border-t-[#d61353] rounded-full animate-spin\"></div>\r\n        <p className=\"mt-3 text-gray-600 dark:text-gray-300 font-medium\">Chargement du prestataire...</p>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (!prestataire) {\r\n    return (\r\n      <div className=\"p-6 text-center\">\r\n        <p className=\"text-gray-500\">Prestataire non trouvé.</p>\r\n        <Link href=\"/dashboard/prestataires\" className=\"mt-4 inline-block\">\r\n          <Button variant=\"outline\"><ArrowLeft className=\"w-4 h-4 mr-2\" /> Retour</Button>\r\n        </Link>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 space-y-6\">\r\n      {/* HEADER */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <Link href=\"/prestataires\">\r\n          <Button variant=\"outline\" className=\"flex items-center gap-2\">\r\n            <ArrowLeft className=\"w-5 h-5\" />\r\n            Retour\r\n          </Button>\r\n        </Link>\r\n        <div className=\"flex items-center gap-3 text-[#d61353]\">\r\n          <Users className=\"w-7 h-7\" />\r\n          <h1 className=\"text-3xl font-bold\">{prestataire.nom} {prestataire.prenom}</h1>\r\n        </div>\r\n        <div />\r\n      </div>\r\n\r\n      {/* Carte Principale */}\r\n      <Card>\r\n        <CardHeader>\r\n          <div className=\"flex justify-between items-start\">\r\n            <CardTitle>Synthèse du Prestataire</CardTitle>\r\n            <AvailabilityBadge available={prestataire.disponible} />\r\n          </div>\r\n          <CardDescription>Informations personnelles et matériel du prestataire.</CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n          <InfoItem icon={<User size={20} />} label=\"Nom complet\" value={`${prestataire.nom} ${prestataire.prenom}`} />\r\n          <InfoItem icon={<Phone size={20} />} label=\"Contact\" value={prestataire.contact} />\r\n          <InfoItem icon={<Briefcase size={20} />} label=\"Service\" value={prestataire.service?.nom} />\r\n          <InfoItem icon={<Car size={20} />} label=\"Véhicule\" value={`${prestataire.marque ?? ''} ${prestataire.modele ?? ''}`} />\r\n          <InfoItem icon={<Palette size={20} />} label=\"Couleur\" value={prestataire.couleur} />\r\n          <InfoItem icon={<Fingerprint size={20} />} label=\"Plaque\" value={prestataire.plaque} />\r\n          <InfoItem icon={<ShieldCheck size={20} />} label=\"Type Panneau\" value={prestataire.type_panneau} />\r\n          <InfoItem icon={<Hash size={20} />} label=\"ID Vérification\" value={prestataire.id_verification} />\r\n          <InfoItem icon={<Calendar size={20} />} label=\"Date de création\" value={prestataire.created_at ? new Date(prestataire.created_at).toLocaleDateString('fr-FR') : '-'} />\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* PHOTOS DU PRESTATAIRE */}\r\n      {prestataire.photos && prestataire.photos.length > 0 && (\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Photos du Prestataire / Véhicule</CardTitle>\r\n            <CardDescription>Images associées à ce prestataire.</CardDescription>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4\">\r\n              {prestataire.photos.map((photo) => (\r\n                <div key={photo.id_photo} className=\"relative aspect-square group cursor-pointer overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700\">\r\n                  <img\r\n                    src={photo.url}\r\n                    alt=\"Prestataire\"\r\n                    className=\"w-full h-full object-cover transition-transform duration-300 group-hover:scale-105\"\r\n                  />\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* DOCUMENTS ADMINISTRATIFS */}\r\n      {prestataire.fichiers && prestataire.fichiers.length > 0 && (\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Documents Administratifs</CardTitle>\r\n            <CardDescription>Documents et fichiers associés à ce prestataire.</CardDescription>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n              {prestataire.fichiers.map((file) => (\r\n                <div key={file.id_fichier} className=\"flex items-center p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition text-decoration-none\">\r\n                  <div className=\"p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg mr-3\">\r\n                    <FileText className=\"w-5 h-5 text-blue-600 dark:text-blue-400\" />\r\n                  </div>\r\n                  <div className=\"min-w-0 flex-1\">\r\n                    <a\r\n                      href={file.url}\r\n                      target=\"_blank\"\r\n                      rel=\"noopener noreferrer\"\r\n                      className=\"text-sm font-medium text-gray-900 dark:text-gray-100 hover:text-blue-600 dark:hover:text-blue-400 truncate block\"\r\n                    >\r\n                      {file.nom}\r\n                    </a>\r\n                    <p className=\"text-xs text-gray-500 truncate\">{file.type || 'Document'}</p>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* AFFECTATIONS */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Affectations en Campagnes ({prestataire._count?.affectations ?? 0})</CardTitle>\r\n          <CardDescription>Historique des campagnes auxquelles ce prestataire a été assigné.</CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {prestataire.affectations && prestataire.affectations.length > 0 ? (\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead>Campagne</TableHead>\r\n                  <TableHead>Début</TableHead>\r\n                  <TableHead>Fin</TableHead>\r\n                  <TableHead>Status</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {prestataire.affectations.map((aff) => (\r\n                  <TableRow key={aff.campagne.id_campagne}>\r\n                    <TableCell className=\"font-medium\">{aff.campagne.nom_campagne}</TableCell>\r\n                    <TableCell>{new Date(aff.campagne.date_debut).toLocaleDateString(\"fr-FR\")}</TableCell>\r\n                    <TableCell>{aff.campagne.date_fin ? new Date(aff.campagne.date_fin).toLocaleDateString(\"fr-FR\") : \"-\"}</TableCell>\r\n                    <TableCell><Badge variant=\"secondary\">{aff.campagne.status}</Badge></TableCell>\r\n                  </TableRow>\r\n                ))}\r\n              </TableBody>\r\n            </Table>\r\n          ) : (\r\n            <p className=\"text-sm text-center text-gray-500 py-8\">Aucune affectation à afficher.</p>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* DOMMAGES */}\r\n      <Card>\r\n        <CardHeader className=\"flex flex-row items-center justify-between\">\r\n          <div>\r\n            <CardTitle>Déclarations d&apos;incidents ({incidents.length})</CardTitle>\r\n            <CardDescription>Historique des incidents enregistrés pour ce prestataire.</CardDescription>\r\n          </div>\r\n          <div className=\"flex gap-2\">\r\n            <Button onClick={() => setIsIncidentModalOpen(true)} className=\"bg-[#d61353] hover:bg-[#b01044] text-white\">\r\n              <AlertTriangle className=\"w-4 h-4 mr-2\" />\r\n              Déclarer un Incident\r\n            </Button>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {incidents && incidents.length > 0 ? (\r\n            <div className=\"space-y-4\">\r\n              {incidents.map((incident) => (\r\n                <div key={incident.id_incident} className=\"border border-gray-200 dark:border-gray-700 rounded-lg p-4\">\r\n                  <div className=\"flex justify-between items-start mb-3\">\r\n                    <div>\r\n                      <p className=\"font-semibold text-lg\">{incident.type_incident?.nom}</p>\r\n                      <p className=\"text-sm text-gray-600 dark:text-gray-400\">{incident.commentaire}</p>\r\n                      <p className=\"text-xs text-gray-500 mt-1\">Enregistré le: {new Date(incident.date_incident).toLocaleDateString(\"fr-FR\")}</p>\r\n                    </div>\r\n                    <Badge variant=\"secondary\">{incident.type_incident?.nom}</Badge>\r\n                  </div>\r\n\r\n                  {incident.photos && incident.photos.length > 0 && (\r\n                    <div className=\"mt-3\">\r\n                      <p className=\"text-sm font-medium mb-2\">Photos ({incident.photos.length})</p>\r\n                      <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2\">\r\n                        {incident.photos.map((photo) => (\r\n                          <div key={photo.id_photo} className=\"relative\">\r\n                            <img\r\n                              src={photo.url}\r\n                              alt=\"Photo incident\"\r\n                              className=\"w-full h-24 object-cover rounded border border-gray-300 dark:border-gray-600\"\r\n                            />\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          ) : (\r\n            <p className=\"text-sm text-center text-gray-500 py-8\">Aucun incident enregistré.</p>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n      <Card>\r\n        <CardHeader className=\"flex flex-row items-center justify-between\">\r\n          <div>\r\n            <CardTitle>Dommages et Cas Matériels ({prestataire._count?.dommages ?? 0})</CardTitle>\r\n            <CardDescription>Historique des dommages matériels enregistrés pour ce prestataire.</CardDescription>\r\n          </div>\r\n          <div className=\"flex gap-2\"> {/* Added a div to group buttons */}\r\n\r\n            <Button onClick={() => setIsMaterielCaseModalOpen(true)} className=\"bg-orange-500 hover:bg-orange-600 text-white\">\r\n              <Wrench className=\"w-4 h-4 mr-2\" />\r\n              Matériel cassé verification pour campagnes\r\n            </Button>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {prestataire.dommages && prestataire.dommages.length > 0 ? (\r\n            <div className=\"space-y-4\">\r\n              {prestataire.dommages.map((dmg) => (\r\n                <div key={dmg.id_materiels_case} className=\"border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex justify-between items-start\">\r\n                  <div>\r\n                    <p className=\"font-semibold\">{dmg.campagne?.nom_campagne ?? \"Campagne non spécifiée\"}</p>\r\n                    <p className=\"text-sm text-gray-600 dark:text-gray-400\">{dmg.description ?? \"Pas de description\"}</p>\r\n                    <p className=\"text-xs text-gray-500 mt-1\">Enregistré le: {new Date(dmg.date_creation).toLocaleDateString(\"fr-FR\")}</p>\r\n                  </div>\r\n                  <div className=\"text-right\">\r\n                    <Badge variant={dmg.etat === 'grave' ? 'destructive' : 'warning'}>{dmg.etat}</Badge>\r\n                    <p className=\"text-lg font-bold mt-1\">{dmg.montant_penalite ? `${dmg.montant_penalite}FCFA` : \"\"}</p>\r\n                    {dmg.penalite_appliquer && <p className=\"text-xs text-green-600\">Pénalité appliquée</p>}\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          ) : (\r\n            <p className=\"text-sm text-center text-gray-500 py-8\">Aucun dommage enregistré.</p>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n      {/* New Incident Modal */}\r\n      <AddIncidentModal\r\n        isOpen={isIncidentModalOpen}\r\n        onClose={() => setIsIncidentModalOpen(false)}\r\n        prestataireId={id}\r\n        onIncidentAdded={() => {\r\n          fetchPrestataire()\r\n          fetchIncidents()\r\n        }}\r\n      />\r\n\r\n      {/* Materiel Case Modal (renamed) */}\r\n      <AddMaterielCaseModal\r\n        isOpen={isMaterielCaseModalOpen}\r\n        onClose={() => setIsMaterielCaseModalOpen(false)}\r\n        prestataireId={id}\r\n        affectations={prestataire.affectations || []}\r\n        onIncidentAdded={fetchPrestataire}\r\n      />\r\n    </div >\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\prestataires\\EditPrestataire.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":482,"column":25,"nodeType":"JSXOpeningElement","endLine":482,"endColumn":109},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":535,"column":23,"nodeType":"JSXOpeningElement","endLine":535,"endColumn":107}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useMemo, useRef } from \"react\"\r\nimport { useFormik } from \"formik\"\r\nimport * as Yup from \"yup\"\r\nimport { X, UploadCloud, Image as ImageIcon, Trash2, Undo2, FileText, File as FileIcon } from \"lucide-react\"\r\nimport { useAuth } from \"@/app/context/AuthContext\"\r\nimport { toast } from \"react-toastify\"\r\nimport { Button } from \"@/components/ui/button\"\r\n\r\ninterface Service {\r\n  id_service: string\r\n  nom: string\r\n}\r\n\r\ninterface PrestatairePhoto {\r\n  id_photo: string\r\n  url: string\r\n}\r\n\r\ninterface PrestataireFichier {\r\n  id_fichier: string\r\n  url: string\r\n  nom: string\r\n  type?: string\r\n}\r\n\r\ninterface Prestataire {\r\n  id_prestataire: string\r\n  nom: string\r\n  prenom: string\r\n  contact?: string\r\n  modele?: string\r\n  type_panneau?: string\r\n  couleur?: string\r\n  marque?: string\r\n  plaque?: string\r\n  id_verification?: string\r\n  contrat_valide?: boolean\r\n  equipe_gps?: boolean\r\n  service?: { id_service?: string; nom?: string }\r\n  disponible: boolean\r\n  photos?: PrestatairePhoto[]\r\n  fichiers?: PrestataireFichier[]\r\n}\r\n\r\ninterface EditPrestaireModalProps {\r\n  isOpen: boolean\r\n  onClose: () => void\r\n  prestataire: Prestataire | null\r\n  services: Service[]\r\n  onEditPrestataire: (prestataire: Prestataire) => void\r\n}\r\n\r\nconst validationSchema = Yup.object().shape({\r\n  nom: Yup.string().required(\"Le nom est requis\"),\r\n  prenom: Yup.string().required(\"Le prénom est requis\"),\r\n  contact: Yup.string().required(\"Le contact est requis\"),\r\n  id_service: Yup.string().required(\"Le service est requis\"),\r\n  disponible: Yup.boolean(),\r\n  type_panneau: Yup.string(),\r\n  couleur: Yup.string(),\r\n  marque: Yup.string(),\r\n  modele: Yup.string(),\r\n  plaque: Yup.string(),\r\n  contrat_valide: Yup.boolean(),\r\n  equipe_gps: Yup.boolean(),\r\n})\r\n\r\nexport default function EditPrestaireModal({ isOpen, onClose, prestataire, services, onEditPrestataire }: EditPrestaireModalProps) {\r\n  const { apiClient } = useAuth()\r\n  const [submitting, setSubmitting] = useState(false)\r\n\r\n  // Photo states\r\n  const [newPhotos, setNewPhotos] = useState<File[]>([])\r\n  const [newPhotoPreviews, setNewPhotoPreviews] = useState<string[]>([])\r\n  const [existingPhotos, setExistingPhotos] = useState<PrestatairePhoto[]>([])\r\n  const [deletedPhotoIds, setDeletedPhotoIds] = useState<string[]>([])\r\n  const fileInputRef = useRef<HTMLInputElement>(null)\r\n\r\n  // File states\r\n  const [newFiles, setNewFiles] = useState<File[]>([])\r\n  const [existingFiles, setExistingFiles] = useState<PrestataireFichier[]>([])\r\n  const [deletedFileIds, setDeletedFileIds] = useState<string[]>([])\r\n  const documentInputRef = useRef<HTMLInputElement>(null)\r\n\r\n  // Initialisation des photos existantes\r\n  useEffect(() => {\r\n    // Photos\r\n    if (prestataire?.photos) {\r\n      setExistingPhotos(prestataire.photos)\r\n    } else {\r\n      setExistingPhotos([])\r\n    }\r\n    setNewPhotos([])\r\n    setNewPhotoPreviews(prev => {\r\n      prev.forEach(url => URL.revokeObjectURL(url));\r\n      return [];\r\n    })\r\n    setDeletedPhotoIds([])\r\n\r\n    // Documents\r\n    if (prestataire?.fichiers) {\r\n      setExistingFiles(prestataire.fichiers)\r\n    } else {\r\n      setExistingFiles([])\r\n    }\r\n    setNewFiles([])\r\n    setDeletedFileIds([])\r\n  }, [prestataire, isOpen])\r\n\r\n  // Trouver l'ID du service\r\n  const initialServiceId = useMemo(() => {\r\n    if (prestataire?.service?.id_service) return prestataire.service.id_service\r\n    if (prestataire?.service?.nom && services.length > 0) {\r\n      const found = services.find((s) => s.nom === prestataire.service?.nom)\r\n      return found ? found.id_service : \"\"\r\n    }\r\n    return \"\"\r\n  }, [prestataire, services])\r\n\r\n  // --- Photo Handling ---\r\n  const handleAddNewPhoto = (file: File) => {\r\n    setNewPhotos(prev => [...prev, file])\r\n    setNewPhotoPreviews(prev => [...prev, URL.createObjectURL(file)])\r\n  }\r\n\r\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    if (e.target.files) {\r\n      Array.from(e.target.files).forEach(file => handleAddNewPhoto(file))\r\n    }\r\n  }\r\n\r\n  const handleRemoveNewPhoto = (indexToRemove: number) => {\r\n    setNewPhotos(prev => prev.filter((_, index) => index !== indexToRemove))\r\n    setNewPhotoPreviews(prev => {\r\n      URL.revokeObjectURL(prev[indexToRemove])\r\n      return prev.filter((_, index) => index !== indexToRemove)\r\n    })\r\n  }\r\n\r\n  const handleMarkPhotoForDeletion = (id: string) => {\r\n    if (!deletedPhotoIds.includes(id)) {\r\n      setDeletedPhotoIds(prev => [...prev, id])\r\n    }\r\n  }\r\n\r\n  const handleUndoDeletion = (id: string) => {\r\n    setDeletedPhotoIds(prev => prev.filter(photoId => photoId !== id))\r\n  }\r\n\r\n  // --- Document Handling ---\r\n  const handleAddNewFile = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    if (e.target.files) {\r\n      setNewFiles(prev => [...prev, ...Array.from(e.target.files || [])])\r\n    }\r\n  }\r\n\r\n  const handleRemoveNewFile = (indexToRemove: number) => {\r\n    setNewFiles(prev => prev.filter((_, index) => index !== indexToRemove))\r\n  }\r\n\r\n  const handleMarkFileForDeletion = (id: string) => {\r\n    if (!deletedFileIds.includes(id)) {\r\n      setDeletedFileIds(prev => [...prev, id])\r\n    }\r\n  }\r\n\r\n  const handleUndoFileDeletion = (id: string) => {\r\n    setDeletedFileIds(prev => prev.filter(fileId => fileId !== id))\r\n  }\r\n\r\n  const formik = useFormik({\r\n    enableReinitialize: true,\r\n    initialValues: {\r\n      nom: prestataire?.nom || \"\",\r\n      prenom: prestataire?.prenom || \"\",\r\n      contact: prestataire?.contact || \"\",\r\n      id_service: initialServiceId,\r\n      disponible: prestataire?.disponible ?? true,\r\n      type_panneau: prestataire?.type_panneau || \"\",\r\n      couleur: prestataire?.couleur || \"\",\r\n      marque: prestataire?.marque || \"\",\r\n      modele: prestataire?.modele || \"\",\r\n      plaque: prestataire?.plaque || \"\",\r\n      id_verification: prestataire?.id_verification || \"\",\r\n      contrat_valide: prestataire?.contrat_valide ?? false,\r\n      equipe_gps: prestataire?.equipe_gps ?? false,\r\n    },\r\n    validationSchema,\r\n    onSubmit: async (values) => {\r\n      setSubmitting(true)\r\n      try {\r\n        if (!prestataire) throw new Error(\"Prestataire introuvable\")\r\n\r\n        // 1. Upload new photos\r\n        const addedPhotoUrls: string[] = []\r\n        for (const photoFile of newPhotos) {\r\n          const formData = new FormData()\r\n          formData.append(\"file\", photoFile)\r\n\r\n          const uploadRes = await apiClient(\"/api/prestataires/upload\", {\r\n            method: \"POST\",\r\n            body: formData,\r\n          })\r\n\r\n          if (!uploadRes.ok) {\r\n            throw new Error(`Erreur upload photo: ${photoFile.name}`)\r\n          }\r\n\r\n          const uploadJson = await uploadRes.json()\r\n          addedPhotoUrls.push(uploadJson.url)\r\n        }\r\n\r\n        // 1.5. Upload new files\r\n        const addedFilesData: { url: string, nom: string, type: string }[] = []\r\n        for (const docFile of newFiles) {\r\n          const formData = new FormData()\r\n          formData.append(\"file\", docFile)\r\n\r\n          const uploadRes = await apiClient(\"/api/prestataires/upload\", {\r\n            method: \"POST\",\r\n            body: formData,\r\n          })\r\n\r\n          if (!uploadRes.ok) throw new Error(`Erreur upload fichier: ${docFile.name}`)\r\n\r\n          const uploadJson = await uploadRes.json()\r\n          addedFilesData.push({\r\n            url: uploadJson.url,\r\n            nom: docFile.name,\r\n            type: docFile.type\r\n          })\r\n        }\r\n\r\n        // 2. Update Prestataire\r\n        const body = {\r\n          id_service: values.id_service,\r\n          nom: values.nom,\r\n          prenom: values.prenom,\r\n          contact: values.contact,\r\n          disponible: values.disponible,\r\n          type_panneau: values.type_panneau || null,\r\n          couleur: values.couleur || null,\r\n          marque: values.marque || null,\r\n          modele: values.modele || null,\r\n          plaque: values.plaque || null,\r\n          contrat_valide: values.contrat_valide,\r\n          equipe_gps: values.equipe_gps,\r\n          addedPhotos: addedPhotoUrls, // URLs of newly uploaded photos\r\n          deletedPhotoIds: deletedPhotoIds, // IDs of photos to delete\r\n          addedFiles: addedFilesData,\r\n          deletedFileIds: deletedFileIds\r\n        }\r\n\r\n        const res = await apiClient(`/api/prestataires/${prestataire.id_prestataire}`, {\r\n          method: \"PUT\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n          },\r\n          body: JSON.stringify(body),\r\n        })\r\n\r\n        if (!res.ok) {\r\n          const err = await res.json().catch(() => ({})) as Record<string, unknown>\r\n          const msg = typeof err?.error === \"string\" ? err.error : \"Erreur lors de la mise à jour\"\r\n          throw new Error(msg)\r\n        }\r\n\r\n        const data = await res.json()\r\n        const updated: Prestataire = data.prestataire\r\n        toast.success(data.message || \"Prestataire mis à jour\")\r\n        onEditPrestataire(updated)\r\n        onClose()\r\n      } catch (err: unknown) {\r\n        console.error(err)\r\n        const msg = err instanceof Error ? err.message : \"Erreur lors de la mise à jour\"\r\n        toast.error(msg)\r\n      } finally {\r\n        setSubmitting(false)\r\n      }\r\n    },\r\n  })\r\n\r\n  if (!isOpen || !prestataire) return null\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\r\n      <div className=\"fixed inset-0 bg-black/40 backdrop-blur-sm\" onClick={onClose} />\r\n      <div className=\"relative z-10 bg-white dark:bg-gray-900 rounded-lg shadow-xl w-[90%] max-w-2xl p-6 border border-gray-200 dark:border-gray-700 max-h-[90vh] overflow-y-auto\">\r\n        <div className=\"flex items-center justify-between mb-4\">\r\n          <h3 className=\"text-lg font-bold text-[#d61353]\">Modifier les informations du prestataire</h3>\r\n          <button onClick={onClose} className=\"text-gray-600 hover:text-[#d61353] transition\">\r\n            <X className=\"w-5 h-5\" />\r\n          </button>\r\n        </div>\r\n\r\n        <form onSubmit={formik.handleSubmit}>\r\n          {/* === INFORMATIONS PERSONNELLES === */}\r\n          <h4 className=\"text-sm font-semibold text-[#d61353] mb-3 border-b pb-2\">Informations personnelles</h4>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Nom *</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"nom\"\r\n                value={formik.values.nom}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className={`w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 ${formik.touched.nom && formik.errors.nom\r\n                  ? \"border-red-500\"\r\n                  : \"border-gray-300 dark:border-gray-600\"\r\n                  }`}\r\n                placeholder=\"Ex: Dupont\"\r\n              />\r\n              {formik.touched.nom && formik.errors.nom && (\r\n                <p className=\"text-red-500 text-xs mt-1\">{formik.errors.nom}</p>\r\n              )}\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Prénom *</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"prenom\"\r\n                value={formik.values.prenom}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className={`w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 ${formik.touched.prenom && formik.errors.prenom\r\n                  ? \"border-red-500\"\r\n                  : \"border-gray-300 dark:border-gray-600\"\r\n                  }`}\r\n                placeholder=\"Ex: Jean\"\r\n              />\r\n              {formik.touched.prenom && formik.errors.prenom && (\r\n                <p className=\"text-red-500 text-xs mt-1\">{formik.errors.prenom}</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Service *</label>\r\n              <select\r\n                name=\"id_service\"\r\n                value={formik.values.id_service}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className={`w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 ${formik.touched.id_service && formik.errors.id_service\r\n                  ? \"border-red-500\"\r\n                  : \"border-gray-300 dark:border-gray-600\"\r\n                  }`}\r\n              >\r\n                <option value=\"\">-- Sélectionner un service --</option>\r\n                {services.map((service) => (\r\n                  <option key={service.id_service} value={service.id_service}>\r\n                    {service.nom}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n              {formik.touched.id_service && formik.errors.id_service && (\r\n                <p className=\"text-red-500 text-xs mt-1\">{formik.errors.id_service}</p>\r\n              )}\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Contact *</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"contact\"\r\n                value={formik.values.contact}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className={`w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 ${formik.touched.contact && formik.errors.contact\r\n                  ? \"border-red-500\"\r\n                  : \"border-gray-300 dark:border-gray-600\"\r\n                  }`}\r\n                placeholder=\"Ex: 06 12 34 56 78\"\r\n              />\r\n              {formik.touched.contact && formik.errors.contact && (\r\n                <p className=\"text-red-500 text-xs mt-1\">{formik.errors.contact}</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* === VÉHICULE === */}\r\n          <h4 className=\"text-sm font-semibold text-[#d61353] mb-3 border-b pb-2\">Informations véhicule</h4>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Type de panneau</label>\r\n              <select\r\n                name=\"type_panneau\"\r\n                value={formik.values.type_panneau}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className=\"w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 border-gray-300 dark:border-gray-600\"\r\n              >\r\n                <option value=\"\">--Sélectionner--</option>\r\n                <option value=\"PETIT\">PETIT</option>\r\n                <option value=\"GRAND\">GRAND</option>\r\n              </select>\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Marque</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"marque\"\r\n                value={formik.values.marque}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className=\"w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 border-gray-300 dark:border-gray-600\"\r\n                placeholder=\"Ex: Toyota\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Modèle</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"modele\"\r\n                value={formik.values.modele}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className=\"w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 border-gray-300 dark:border-gray-600\"\r\n                placeholder=\"Ex: Hiace\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Couleur</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"couleur\"\r\n                value={formik.values.couleur}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className=\"w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 border-gray-300 dark:border-gray-600\"\r\n                placeholder=\"Ex: Blanc\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">Plaque (immatriculation)</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"plaque\"\r\n                value={formik.values.plaque}\r\n                onChange={formik.handleChange}\r\n                onBlur={formik.handleBlur}\r\n                className=\"w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 border-gray-300 dark:border-gray-600\"\r\n                placeholder=\"Ex: AB-123-CD\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-medium mb-1\">ID Vérification (Auto)</label>\r\n              <input\r\n                type=\"text\"\r\n                name=\"id_verification\"\r\n                value={formik.values.id_verification}\r\n                readOnly\r\n                disabled\r\n                className=\"w-full px-3 py-2 border rounded-lg bg-gray-100 dark:bg-gray-800 border-gray-300 dark:border-gray-700 text-gray-500 cursor-not-allowed\"\r\n                placeholder=\"Généré automatiquement\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* === PHOTOS === */}\r\n          <h4 className=\"text-sm font-semibold text-[#d61353] mb-3 border-b pb-2\">Photos</h4>\r\n          <div className=\"mb-6\">\r\n            <div className=\"flex flex-col space-y-4\">\r\n              {/* Existing Photos */}\r\n              {existingPhotos.length > 0 && (\r\n                <div className=\"flex flex-wrap gap-2 mb-2\">\r\n                  {existingPhotos.map((photo) => {\r\n                    const isDeleted = deletedPhotoIds.includes(photo.id_photo);\r\n                    return (\r\n                      <div key={photo.id_photo} className={`relative w-24 h-24 rounded-lg overflow-hidden border ${isDeleted ? 'opacity-50 grayscale' : ''}`}>\r\n                        <img src={photo.url} alt=\"Photo existante\" className=\"w-full h-full object-cover\" />\r\n                        <div className=\"absolute top-1 right-1\">\r\n                          {isDeleted ? (\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => handleUndoDeletion(photo.id_photo)}\r\n                              className=\"p-1 bg-green-500 text-white rounded-full hover:bg-green-600\"\r\n                              title=\"Annuler suppression\"\r\n                            >\r\n                              <Undo2 size={12} />\r\n                            </button>\r\n                          ) : (\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => handleMarkPhotoForDeletion(photo.id_photo)}\r\n                              className=\"p-1 bg-red-500 text-white rounded-full hover:bg-red-600\"\r\n                              title=\"Supprimer\"\r\n                            >\r\n                              <Trash2 size={12} />\r\n                            </button>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              )}\r\n\r\n              {/* Add New Photos */}\r\n              <div className=\"flex-1 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-900 p-4\">\r\n                <div className=\"flex justify-center gap-3 mb-4\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => fileInputRef.current?.click()}\r\n                    className=\"flex items-center gap-2 px-4 py-2 bg-white border shadow-sm rounded-lg hover:bg-gray-50 text-sm font-medium transition\"\r\n                  >\r\n                    <UploadCloud size={16} />\r\n                    Ajouter des nouvelles photos\r\n                  </button>\r\n                  <input\r\n                    ref={fileInputRef}\r\n                    type=\"file\"\r\n                    accept=\"image/*\"\r\n                    multiple\r\n                    className=\"hidden\"\r\n                    onChange={handleFileChange}\r\n                  />\r\n                </div>\r\n\r\n                {/* Previews of new photos */}\r\n                <div className=\"flex flex-wrap gap-2 justify-center max-h-[200px] overflow-y-auto\">\r\n                  {newPhotoPreviews.map((url, index) => (\r\n                    <div key={index} className=\"relative w-24 h-24 rounded-lg overflow-hidden border\">\r\n                      <img src={url} alt={`Aperçu ${index + 1}`} className=\"w-full h-full object-cover\" />\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => handleRemoveNewPhoto(index)}\r\n                        className=\"absolute top-1 right-1 p-0.5 bg-black/50 text-white rounded-full hover:bg-black/70\"\r\n                      >\r\n                        <X size={14} />\r\n                      </button>\r\n                    </div>\r\n                  ))}\r\n                  {newPhotoPreviews.length === 0 && existingPhotos.length === 0 && (\r\n                    <div className=\"flex flex-col items-center justify-center py-4 text-center text-gray-400\">\r\n                      <ImageIcon className=\"w-8 h-8 mb-1 opacity-50\" />\r\n                      <p className=\"text-xs\">Aucune photo</p>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* === DOCUMENTS === */}\r\n          <h4 className=\"text-sm font-semibold text-[#d61353] mb-3 border-b pb-2\">Documents Administratifs</h4>\r\n          <div className=\"mb-6\">\r\n            <div className=\"space-y-3\">\r\n              {/* Documents existants */}\r\n              {existingFiles.length > 0 && (\r\n                <div className=\"grid grid-cols-1 gap-2\">\r\n                  {existingFiles.map((file) => {\r\n                    const isDeleted = deletedFileIds.includes(file.id_fichier)\r\n                    return (\r\n                      <div key={file.id_fichier} className={`flex items-center justify-between p-3 border rounded-lg bg-white dark:bg-gray-800 ${isDeleted ? 'opacity-50 bg-gray-50' : ''}`}>\r\n                        <div className=\"flex items-center gap-3 overflow-hidden\">\r\n                          <div className=\"p-2 bg-gray-100 dark:bg-gray-700 rounded-lg\">\r\n                            <FileText className=\"w-5 h-5 text-blue-600\" />\r\n                          </div>\r\n                          <div className=\"min-w-0\">\r\n                            <a href={file.url} target=\"_blank\" rel=\"noopener noreferrer\" className={`text-sm font-medium truncate hover:underline ${isDeleted ? 'line-through text-gray-500 pointer-events-none' : 'text-blue-600'}`}>\r\n                              {file.nom}\r\n                            </a>\r\n                            <p className=\"text-xs text-gray-500\">{file.type || 'Document'}</p>\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"flex-shrink-0 ml-2\">\r\n                          {isDeleted ? (\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => handleUndoFileDeletion(file.id_fichier)}\r\n                              className=\"p-1.5 text-green-600 hover:bg-green-50 rounded-lg transition\"\r\n                              title=\"Annuler suppression\"\r\n                            >\r\n                              <Undo2 size={16} />\r\n                            </button>\r\n                          ) : (\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => handleMarkFileForDeletion(file.id_fichier)}\r\n                              className=\"p-1.5 text-red-600 hover:bg-red-50 rounded-lg transition\"\r\n                              title=\"Supprimer\"\r\n                            >\r\n                              <Trash2 size={16} />\r\n                            </button>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    )\r\n                  })}\r\n                </div>\r\n              )}\r\n\r\n              {/* Nouveaux documents */}\r\n              {newFiles.length > 0 && (\r\n                <div className=\"grid grid-cols-1 gap-2\">\r\n                  {newFiles.map((file, index) => (\r\n                    <div key={index} className=\"flex items-center justify-between p-3 border border-green-200 bg-green-50 dark:bg-green-900/10 rounded-lg\">\r\n                      <div className=\"flex items-center gap-3 overflow-hidden\">\r\n                        <div className=\"p-2 bg-white dark:bg-gray-800 rounded-lg border border-green-100\">\r\n                          <FileIcon className=\"w-5 h-5 text-green-600\" />\r\n                        </div>\r\n                        <div className=\"min-w-0\">\r\n                          <p className=\"text-sm font-medium truncate\">{file.name}</p>\r\n                          <p className=\"text-xs text-gray-500\">{(file.size / 1024).toFixed(0)} KB • Nouveau</p>\r\n                        </div>\r\n                      </div>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => handleRemoveNewFile(index)}\r\n                        className=\"p-1.5 text-gray-500 hover:text-red-500 hover:bg-white rounded-lg transition\"\r\n                      >\r\n                        <X size={16} />\r\n                      </button>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n\r\n              {/* Bouton d'ajout */}\r\n              <div className=\"mt-2\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => documentInputRef.current?.click()}\r\n                  className=\"flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium transition w-full justify-center border-dashed\"\r\n                >\r\n                  <UploadCloud size={16} />\r\n                  Ajouter un document (PDF, Word, Excel...)\r\n                </button>\r\n                <input\r\n                  ref={documentInputRef}\r\n                  type=\"file\"\r\n                  accept=\".pdf,.doc,.docx,.xls,.xlsx\"\r\n                  multiple\r\n                  className=\"hidden\"\r\n                  onChange={handleAddNewFile}\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* === DISPONIBILITÉ === */}\r\n          <h4 className=\"text-sm font-semibold text-[#d61353] mb-3 border-b pb-2\">Statut</h4>\r\n\r\n          <div className=\"space-y-3 mb-6\">\r\n            <label className=\"flex items-center gap-2 cursor-pointer\">\r\n              <input\r\n                type=\"checkbox\"\r\n                name=\"disponible\"\r\n                checked={formik.values.disponible}\r\n                onChange={formik.handleChange}\r\n                className=\"w-4 h-4 rounded\"\r\n              />\r\n              <span className=\"text-sm font-medium\">Disponible</span>\r\n            </label>\r\n            <label className=\"flex items-center gap-2 cursor-pointer\">\r\n              <input\r\n                type=\"checkbox\"\r\n                name=\"contrat_valide\"\r\n                checked={!!formik.values.contrat_valide}\r\n                onChange={(e) => formik.setFieldValue('contrat_valide', e.target.checked)}\r\n                className=\"w-4 h-4 rounded\"\r\n              />\r\n              <span className=\"text-sm font-medium\">Contrat Validé</span>\r\n            </label>\r\n            <label className=\"flex items-center gap-2 cursor-pointer\">\r\n              <input\r\n                type=\"checkbox\"\r\n                name=\"equipe_gps\"\r\n                checked={!!formik.values.equipe_gps}\r\n                onChange={(e) => formik.setFieldValue('equipe_gps', e.target.checked)}\r\n                className=\"w-4 h-4 rounded\"\r\n              />\r\n              <span className=\"text-sm font-medium\">Équipé GPS</span>\r\n            </label>\r\n          </div>\r\n\r\n          <div className=\"flex justify-between gap-3 pt-4 border-t border-gray-200 dark:border-gray-700\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={onClose}\r\n              disabled={submitting}\r\n              className=\"px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 disabled:opacity-50 transition\"\r\n            >\r\n              Annuler\r\n            </button>\r\n            <Button\r\n              type=\"submit\"\r\n              loading={submitting}\r\n              className=\"px-4 py-2 rounded-lg bg-[#d61353] hover:bg-[#b01044] text-white disabled:opacity-50 transition\"\r\n            >\r\n              Enregistrer\r\n            </Button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\prestataires\\PrestataireTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\prestataires\\QuickAddFileModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\prestataires\\QuickAddPhotoModal.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":132,"column":37,"nodeType":"JSXOpeningElement","endLine":132,"endColumn":117}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef } from \"react\"\r\nimport { X, UploadCloud, Image as ImageIcon } from \"lucide-react\"\r\nimport { useAuth } from \"@/app/context/AuthContext\"\r\nimport { toast } from \"react-toastify\"\r\nimport { Button } from \"@/components/ui/button\"\r\n\r\ninterface QuickAddPhotoModalProps {\r\n    isOpen: boolean\r\n    onClose: () => void\r\n    prestataireId: string\r\n    onPhotosAdded: () => void\r\n}\r\n\r\nexport default function QuickAddPhotoModal({ isOpen, onClose, prestataireId, onPhotosAdded }: QuickAddPhotoModalProps) {\r\n    const { apiClient } = useAuth()\r\n    const [submitting, setSubmitting] = useState(false)\r\n    const [photos, setPhotos] = useState<File[]>([])\r\n    const [previews, setPreviews] = useState<string[]>([])\r\n    const fileInputRef = useRef<HTMLInputElement>(null)\r\n\r\n    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (e.target.files) {\r\n            const newFiles = Array.from(e.target.files)\r\n            setPhotos(prev => [...prev, ...newFiles])\r\n\r\n            const newPreviews = newFiles.map(file => URL.createObjectURL(file))\r\n            setPreviews(prev => [...prev, ...newPreviews])\r\n        }\r\n    }\r\n\r\n    const handleRemovePhoto = (index: number) => {\r\n        setPhotos(prev => prev.filter((_, i) => i !== index))\r\n        setPreviews(prev => {\r\n            URL.revokeObjectURL(prev[index])\r\n            return prev.filter((_, i) => i !== index)\r\n        })\r\n    }\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault()\r\n        if (photos.length === 0) return\r\n\r\n        setSubmitting(true)\r\n        try {\r\n            // 1. Upload photos first\r\n            const uploadedUrls: string[] = []\r\n\r\n            for (const photoFile of photos) {\r\n                const formData = new FormData()\r\n                formData.append(\"file\", photoFile)\r\n\r\n                const uploadRes = await apiClient(\"/api/prestataires/upload\", {\r\n                    method: \"POST\",\r\n                    body: formData,\r\n                })\r\n\r\n                if (!uploadRes.ok) {\r\n                    throw new Error(`Erreur upload photo: ${photoFile.name}`)\r\n                }\r\n\r\n                const uploadJson = await uploadRes.json()\r\n                uploadedUrls.push(uploadJson.url)\r\n            }\r\n\r\n            // 2. Call the specific endpoint to associate photos\r\n            const res = await apiClient(`/api/prestataires/${prestataireId}/photos`, {\r\n                method: \"POST\",\r\n                headers: { \"Content-Type\": \"application/json\" },\r\n                body: JSON.stringify({ photos: uploadedUrls })\r\n            })\r\n\r\n            if (!res.ok) {\r\n                throw new Error(\"Erreur lors de l'ajout des photos\")\r\n            }\r\n\r\n            toast.success(\"Photos ajoutées avec succès\")\r\n            onPhotosAdded()\r\n\r\n            // Cleanup\r\n            setPhotos([])\r\n            previews.forEach(url => URL.revokeObjectURL(url))\r\n            setPreviews([])\r\n            onClose()\r\n\r\n        } catch (err: unknown) {\r\n            console.error(err)\r\n            toast.error(\"Une erreur est survenue\")\r\n        } finally {\r\n            setSubmitting(false)\r\n        }\r\n    }\r\n\r\n    if (!isOpen) return null\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\r\n            <div className=\"fixed inset-0 bg-black/40 backdrop-blur-sm\" onClick={onClose} />\r\n            <div className=\"relative z-10 bg-white dark:bg-gray-900 rounded-lg shadow-xl w-[90%] max-w-lg p-6 border border-gray-200 dark:border-gray-700\">\r\n                <div className=\"flex items-center justify-between mb-4\">\r\n                    <h3 className=\"text-lg font-bold text-[#d61353]\">Ajout rapide de photos</h3>\r\n                    <button onClick={onClose} className=\"text-gray-600 hover:text-[#d61353] transition\">\r\n                        <X className=\"w-5 h-5\" />\r\n                    </button>\r\n                </div>\r\n\r\n                <form onSubmit={handleSubmit}>\r\n                    <div className=\"flex-1 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-900 p-4 mb-6\">\r\n                        <div className=\"flex justify-center gap-3 mb-4\">\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={() => fileInputRef.current?.click()}\r\n                                className=\"flex items-center gap-2 px-4 py-2 bg-white border shadow-sm rounded-lg hover:bg-gray-50 text-sm font-medium transition\"\r\n                            >\r\n                                <UploadCloud size={16} />\r\n                                Sélectionner des photos\r\n                            </button>\r\n                            <input\r\n                                ref={fileInputRef}\r\n                                type=\"file\"\r\n                                accept=\"image/*\"\r\n                                multiple\r\n                                className=\"hidden\"\r\n                                onChange={handleFileChange}\r\n                            />\r\n                        </div>\r\n\r\n                        <div className=\"flex flex-wrap gap-2 justify-center max-h-[200px] overflow-y-auto\">\r\n                            {previews.map((url, index) => (\r\n                                <div key={index} className=\"relative w-24 h-24 rounded-lg overflow-hidden border\">\r\n                                    <img src={url} alt={`Aperçu ${index}`} className=\"w-full h-full object-cover\" />\r\n                                    <button\r\n                                        type=\"button\"\r\n                                        onClick={() => handleRemovePhoto(index)}\r\n                                        className=\"absolute top-1 right-1 p-0.5 bg-black/50 text-white rounded-full hover:bg-black/70\"\r\n                                    >\r\n                                        <X size={14} />\r\n                                    </button>\r\n                                </div>\r\n                            ))}\r\n                            {previews.length === 0 && (\r\n                                <div className=\"flex flex-col items-center justify-center py-4 text-center text-gray-400\">\r\n                                    <ImageIcon className=\"w-8 h-8 mb-1 opacity-50\" />\r\n                                    <p className=\"text-xs\">Aucune photo sélectionnée</p>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex justify-end gap-3\">\r\n                        <button\r\n                            type=\"button\"\r\n                            onClick={onClose}\r\n                            disabled={submitting}\r\n                            className=\"px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 transition\"\r\n                        >\r\n                            Annuler\r\n                        </button>\r\n                        <Button\r\n                            type=\"submit\"\r\n                            loading={submitting}\r\n                            disabled={photos.length === 0}\r\n                            className=\"px-4 py-2 rounded-lg bg-[#d61353] hover:bg-[#b01044] text-white transition\"\r\n                        >\r\n                            Ajouter les photos\r\n                        </Button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\profil\\profil.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\providers\\ToastProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\search-form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\services\\AddService.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\services\\DeleteService.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\services\\EditService.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\services\\ServiceTable.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setError' is assigned a value but never used.","line":25,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":25},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchServices'. Either include it or remove the dependency array.","line":59,"column":6,"nodeType":"ArrayExpression","endLine":59,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [apiClient, fetchServices, page]","fix":{"range":[2124,2141],"text":"[apiClient, fetchServices, page]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Pencil, Trash2, Plus, Briefcase, Search } from \"lucide-react\";\r\nimport AddService from \"@/components/services/AddService\";\r\nimport EditService from \"@/components/services/EditService\";\r\nimport DeleteService from \"@/components/services/DeleteService\";\r\nimport { useAuth } from \"@/app/context/AuthContext\";\r\nimport { toast } from \"react-toastify\";\r\nimport { Paginate } from \"../Paginate\";\r\nimport { useSearchParams } from \"next/navigation\";\r\nimport { Input } from \"@/components/ui/input\"\r\n\r\ninterface Service {\r\n  id_service: string;\r\n  nom: string;\r\n  description: string | null;\r\n  created_at: string;\r\n  _count?: { campagnes: number; prestataires: number };\r\n}\r\n\r\nexport default function ServiceTable() {\r\n  const [services, setServices] = useState<Service[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [searchQuery, setSearchQuery] = useState(\"\")\r\n\r\n  const { apiClient } = useAuth()\r\n  const [isAddModalOpen, setIsAddModalOpen] = useState(false);\r\n  const [isEditModalOpen, setIsEditModalOpen] = useState(false);\r\n  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);\r\n  const [serviceToEdit, setServiceToEdit] = useState<Service | null>(null);\r\n  const [serviceToDelete, setServiceToDelete] = useState<Service | null>(null);\r\n  const searchParam = useSearchParams();\r\n  const page = parseInt(searchParam?.get(\"page\") || \"1\");\r\n  const [totalPages, setTotalPages] = useState(1);\r\n\r\n  const fetchServices = async () => {\r\n    setLoading(true);\r\n    try {\r\n      const res = await apiClient(`/api/services?page=${page}&limit=7`);\r\n\r\n      if (!res.ok) throw new Error(\"Erreur API\");\r\n\r\n      const data = await res.json();\r\n      setServices(data.services || []);\r\n      setTotalPages(data?.pagination?.totalPages || 1);\r\n\r\n    } catch (error) {\r\n      console.error(\"Erreur API :\", error);\r\n      toast.error(\"Impossible de charger les services\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchServices();\r\n  }, [apiClient, page]);\r\n\r\n  const filteredServices = services.filter((s) => {\r\n    const search = searchQuery.toLowerCase()\r\n    return (\r\n      s.nom.toLowerCase().includes(search) ||\r\n      (s.description || \"\").toLowerCase().includes(search)\r\n    )\r\n  })\r\n\r\n  return (\r\n    <div className=\"p-6 text-gray-900 dark:text-white\">\r\n      {/* HEADER */}\r\n      <div className=\"flex flex-col sm:flex-row items-center justify-between mb-6 bg-white dark:bg-gray-900 p-4 rounded-2xl shadow-md border border-gray-100 dark:border-gray-800\">\r\n        <div className=\"flex items-center gap-2 text-[#d61353]\">\r\n          <Briefcase className=\"w-6 h-6\" />\r\n          <h1 className=\"text-xl sm:text-2xl font-bold\">Gestion des services</h1>\r\n        </div>\r\n        <button\r\n          onClick={() => setIsAddModalOpen(true)}\r\n          className=\"flex items-center gap-2 bg-[#d61353] text-white px-3 py-2 md:px-4 md:py-2 rounded-lg hover:bg-[#b01044] transition text-sm md:text-base\"\r\n        >\r\n          <Plus className=\"w-4 h-4 md:w-5 md:h-5\" />\r\n          <span>Ajouter un service</span>\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"flex justify-end mb-4\">\r\n        <div className=\"relative w-full md:w-72\">\r\n          <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500\" />\r\n          <Input\r\n            placeholder=\"Rechercher...\"\r\n            value={searchQuery}\r\n            onChange={(e) => setSearchQuery(e.target.value)}\r\n            className=\"pl-9 bg-white dark:bg-gray-800\"\r\n          />\r\n        </div>\r\n      </div>\r\n      <div className=\"overflow-x-auto bg-white dark:bg-gray-900 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-800\">\r\n        {loading ? (\r\n          <div className=\"flex flex-col items-center justify-center py-10\">\r\n            <div className=\"w-10 h-10 border-4 border-[#d61353]/30 border-t-[#d61353] rounded-full animate-spin\"></div>\r\n            <p className=\"mt-3 text-gray-600 dark:text-gray-300 font-medium\">\r\n              Chargement des services...\r\n            </p>\r\n          </div>\r\n        ) : error ? (\r\n\r\n          <div className=\"text-center text-red-500 py-8\">{error}</div>\r\n        ) : services.length === 0 ? (\r\n          <div className=\"text-center py-8 text-gray-500\">Aucun service trouvé</div>\r\n        ) : (\r\n          <div>\r\n            <table className=\"min-w-full border-collapse\">\r\n              <thead>\r\n                <tr className=\"bg-gray-50 dark:bg-gray-800\">\r\n                  <th className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-semibold\">Nom du service</th>\r\n                  <th className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-semibold\">Description</th>\r\n                  <th className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-semibold\">Date de création</th>\r\n                  <th className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-semibold text-center\">Actions</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700\">\r\n                {filteredServices.length === 0 ? (\r\n                  <tr>\r\n                    <td colSpan={4} className=\"text-center py-6 text-gray-500\">\r\n                      Aucun service trouvé.\r\n                    </td>\r\n                  </tr>\r\n                ) : (\r\n                  filteredServices.map((service) => (\r\n                    <tr key={service.id_service} className=\"hover:bg-gray-50 dark:hover:bg-gray-800\">\r\n                      <td className=\"px-3 md:px-6 py-3 text-xs md:text-sm font-medium\">{service.nom}</td>\r\n                      <td className=\"px-3 md:px-6 py-3 text-xs md:text-sm\">{service.description || \"-\"}</td>\r\n                      <td className=\"px-3 md:px-6 py-3 text-xs md:text-sm\">\r\n                        {new Date(service.created_at).toLocaleDateString(\"fr-FR\")}\r\n                      </td>\r\n                      <td className=\"px-3 md:px-6 py-3 text-xs md:text-sm text-center\">\r\n                        <div className=\"flex justify-center gap-3\">\r\n                          <button\r\n                            onClick={() => {\r\n                              setServiceToEdit(service);\r\n                              setIsEditModalOpen(true);\r\n                            }}\r\n                            className=\"p-2 cursor-pointer rounded-lg bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-800 transition\"\r\n                          >\r\n                            <Pencil className=\"w-4 h-4\" />\r\n                          </button>\r\n\r\n                          <button\r\n                            onClick={() => {\r\n                              setServiceToDelete(service);\r\n                              setIsDeleteModalOpen(true);\r\n                            }}\r\n                            className=\"p-2 cursor-pointer rounded-lg bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-800 transition\"\r\n                          >\r\n                            <Trash2 className=\"w-4 h-4\" />\r\n                          </button>\r\n                        </div>\r\n                      </td>\r\n                    </tr>\r\n                  ))\r\n                )}\r\n              </tbody>\r\n            </table>\r\n            {totalPages > 1 && <Paginate pages={totalPages} currentPage={page} />}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n\r\n      {/* MODALS */}\r\n      <AddService\r\n        isOpen={isAddModalOpen}\r\n        onClose={() => setIsAddModalOpen(false)}\r\n        onServiceUpdated={fetchServices}\r\n      />\r\n\r\n      {serviceToEdit && (\r\n        <EditService\r\n          isOpen={isEditModalOpen}\r\n          onClose={() => {\r\n            setIsEditModalOpen(false);\r\n            setServiceToEdit(null);\r\n          }}\r\n          service={serviceToEdit}\r\n          onServiceUpdated={fetchServices}\r\n        />\r\n      )}\r\n\r\n      {serviceToDelete && (\r\n        <DeleteService\r\n          isOpen={isDeleteModalOpen}\r\n          onClose={() => {\r\n            setIsDeleteModalOpen(false);\r\n            setServiceToDelete(null);\r\n          }}\r\n          service={serviceToDelete}\r\n          onServiceUpdated={fetchServices}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\types-incident\\AddTypeIncidentDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\types-incident\\AddTypeIncidentForm.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchTypeIncidents'. Either include it or remove the dependency array.","line":57,"column":8,"nodeType":"ArrayExpression","endLine":57,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [fetchTypeIncidents]","fix":{"range":[1865,1867],"text":"[fetchTypeIncidents]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useAuth } from \"@/app/context/AuthContext\";\r\nimport { toast } from \"react-toastify\";\r\nimport {\r\n    Card,\r\n    CardContent,\r\n    CardHeader,\r\n    CardTitle,\r\n    CardDescription\r\n} from \"@/components/ui/card\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { PlusCircle, Loader2 } from \"lucide-react\";\r\n\r\ninterface TypeIncident {\r\n    id_type_incident: string;\r\n    nom: string;\r\n    description: string | null;\r\n    created_at: string;\r\n}\r\n\r\nexport default function AddTypeIncidentForm() {\r\n    const { apiClient } = useAuth();\r\n    const [loading, setLoading] = useState(true);\r\n    const [submitting, setSubmitting] = useState(false);\r\n    const [typeIncidents, setTypeIncidents] = useState<TypeIncident[]>([]);\r\n\r\n    // Form states\r\n    const [nom, setNom] = useState(\"\");\r\n    const [description, setDescription] = useState(\"\");\r\n\r\n    const fetchTypeIncidents = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const res = await apiClient(\"/api/types-incidents\");\r\n            if (res.ok) {\r\n                const data = await res.json();\r\n                setTypeIncidents(data);\r\n            } else {\r\n                toast.error(\"Échec du chargement des types d'incident.\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error fetching incident types:\", error);\r\n            toast.error(\"Erreur lors du chargement des types d'incident.\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchTypeIncidents();\r\n    }, []);\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setSubmitting(true);\r\n        try {\r\n            const payload = { nom, description };\r\n            const res = await apiClient(\"/api/types-incidents\", {\r\n                method: \"POST\",\r\n                headers: { \"Content-Type\": \"application/json\" },\r\n                body: JSON.stringify(payload),\r\n            });\r\n\r\n            if (!res.ok) {\r\n                const body = await res.json().catch(() => ({}));\r\n                throw new Error(body.message || \"Erreur lors de la création du type d'incident.\");\r\n            }\r\n\r\n            toast.success(\"Type d'incident créé avec succès.\");\r\n            setNom(\"\");\r\n            setDescription(\"\");\r\n            fetchTypeIncidents(); // Refresh the list\r\n        } catch (err) {\r\n            console.error(\"Error creating incident type:\", err);\r\n            toast.error(err instanceof Error ? err.message : \"Erreur inconnue lors de la création.\");\r\n        } finally {\r\n            setSubmitting(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                        <PlusCircle className=\"w-5 h-5 text-[#d61353]\" />\r\n                        Ajouter un Nouveau Type d&apos;Incident\r\n                    </CardTitle>\r\n                    <CardDescription>\r\n                        Définissez de nouveaux types d&apos;incidents pour une meilleure catégorisation.\r\n                    </CardDescription>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n                        <div className=\"space-y-1\">\r\n                            <Label htmlFor=\"nom\">Nom du Type d&apos;Incident</Label>\r\n                            <Input\r\n                                id=\"nom\"\r\n                                type=\"text\"\r\n                                value={nom}\r\n                                onChange={(e) => setNom(e.target.value)}\r\n                                placeholder=\"Ex: Retard, Panne Véhicule, Attitude Problématique\"\r\n                                required\r\n                            />\r\n                        </div>\r\n                        <div className=\"space-y-1\">\r\n                            <Label htmlFor=\"description\">Description (Optionnel)</Label>\r\n                            <Textarea\r\n                                id=\"description\"\r\n                                value={description}\r\n                                onChange={(e) => setDescription(e.target.value)}\r\n                                placeholder=\"Description détaillée de ce type d&apos;incident.\"\r\n                                rows={3}\r\n                            />\r\n                        </div>\r\n                        <Button type=\"submit\" disabled={submitting} className=\"w-full bg-[#d61353] hover:bg-[#b01044]\">\r\n                            {submitting ? (\r\n                                <>\r\n                                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                                    Création...\r\n                                </>\r\n                            ) : (\r\n                                <>Créer le Type d&apos;Incident</>\r\n                            )}\r\n                        </Button>\r\n                    </form>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle>Types d&apos;Incidents Existants</CardTitle>\r\n                    <CardDescription>\r\n                        Liste de tous les types d&apos;incidents actuellement configurés.\r\n                    </CardDescription>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    {loading ? (\r\n                        <div className=\"flex justify-center py-8\">\r\n                            <Loader2 className=\"h-6 w-6 animate-spin text-[#d61353]\" />\r\n                        </div>\r\n                    ) : typeIncidents.length === 0 ? (\r\n                        <p className=\"text-center text-gray-500 py-8\">Aucun type d&apos;incident enregistré pour le moment.</p>\r\n                    ) : (\r\n                        <Table>\r\n                            <TableHeader>\r\n                                <TableRow>\r\n                                    <TableHead>Nom</TableHead>\r\n                                    <TableHead>Description</TableHead>\r\n                                    <TableHead>Date de Création</TableHead>\r\n                                </TableRow>\r\n                            </TableHeader>\r\n                            <TableBody>\r\n                                {typeIncidents.map((type) => (\r\n                                    <TableRow key={type.id_type_incident}>\r\n                                        <TableCell className=\"font-medium\">{type.nom}</TableCell>\r\n                                        <TableCell>{type.description || \"-\"}</TableCell>\r\n                                        <TableCell>{new Date(type.created_at).toLocaleDateString('fr-FR')}</TableCell>\r\n                                    </TableRow>\r\n                                ))}\r\n                            </TableBody>\r\n                        </Table>\r\n                    )}\r\n                </CardContent>\r\n            </Card>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\DashboardHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\GlobalLinkLoader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\breadcrumb.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\calendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\collapsible.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\dropdown\\Dropdown.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\dropdown\\DropdownItem.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\logo.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\pagination.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\sonner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\ui\\tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\user\\AddUser.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[417,420],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[417,420],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\user\\DeleteUser.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\user\\EditUser.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\user\\UserTable.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":66,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":66,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { useAuth } from \"@/app/context/AuthContext\"\r\nimport { toast, ToastContainer } from \"react-toastify\"\r\nimport { Pencil, Trash2, Plus, User, Search } from \"lucide-react\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport AddUserModal from \"@/components/user/AddUser\"\r\nimport EditUserModal from \"@/components/user/EditUser\"\r\nimport DeleteUserModal from \"@/components/user/DeleteUser\"\r\nimport { Paginate } from \"../Paginate\"\r\n\r\nimport { useSearchParams } from \"next/navigation\";\r\n\r\ninterface User {\r\n  id_user: string\r\n  nom: string\r\n  prenom: string\r\n  type_user: \"ADMIN\" | \"SUPERVISEUR_CAMPAGNE\" | \"CONTROLEUR\" | \"OPERATIONNEL\" | \"EQUIPE\"\r\n  email: string\r\n  contact: string\r\n  created_at: string\r\n}\r\n\r\nconst getUserBadgeColor = (type: string) => {\r\n  switch (type) {\r\n    case \"ADMIN\": return \"bg-pink-100 text-pink-700\";\r\n    case \"SUPERVISEUR_CAMPAGNE\": return \"bg-blue-100 text-blue-700\";\r\n    case \"CONTROLEUR\": return \"bg-yellow-100 text-yellow-700\";\r\n    case \"OPERATIONNEL\": return \"bg-green-100 text-green-700\";\r\n    default: return \"bg-gray-100 text-gray-700\";\r\n  }\r\n};\r\n\r\nconst formatUserType = (type: string) => {\r\n  return type.replace(/_/g, \" \");\r\n};\r\n\r\nexport default function TableUser() {\r\n  const { apiClient } = useAuth()\r\n  const [users, setUsers] = useState<User[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [error, setError] = useState<string | null>(null)\r\n\r\n  const [isModalOpen, setIsModalOpen] = useState(false)\r\n  const [isEditModalOpen, setIsEditModalOpen] = useState(false)\r\n  const [isDeleteOpen, setIsDeleteOpen] = useState(false)\r\n  const [userToDelete, setUserToDelete] = useState<User | null>(null)\r\n  const [userToEdit, setUserToEdit] = useState<User | null>(null)\r\n  const [totalPages, setTotalPages] = useState(1);\r\n  const [searchQuery, setSearchQuery] = useState(\"\")\r\n\r\n\r\n  const searchParam = useSearchParams();\r\n  const page = parseInt(searchParam?.get(\"page\") || \"1\");\r\n\r\n  useEffect(() => {\r\n    const fetchUsers = async () => {\r\n      setLoading(true)\r\n      try {\r\n        const res = await apiClient(\"/api/users?page=\" + page + \"&limit=7\")\r\n        if (!res.ok) throw new Error(\"Erreur lors du chargement des utilisateurs\")\r\n        const data = await res.json()\r\n        setUsers(Array.isArray(data) ? data : data?.users || [])\r\n        setTotalPages(data?.pagination.totalPages || 1);\r\n      } catch (e) {\r\n        setError(\"Impossible de charger les utilisateurs\")\r\n        toast.error(\"Impossible de charger les utilisateurs\")\r\n      } finally {\r\n        setLoading(false)\r\n      }\r\n    }\r\n    fetchUsers()\r\n  }, [apiClient, page])\r\n\r\n  const filteredUsers = users.filter((user) => {\r\n    const search = searchQuery.toLowerCase()\r\n    return (\r\n      user.nom.toLowerCase().includes(search) ||\r\n      user.prenom.toLowerCase().includes(search) ||\r\n      user.email.toLowerCase().includes(search) ||\r\n      user.contact.toLowerCase().includes(search)\r\n    )\r\n  })\r\n\r\n  const handleAddUser = async (newUser: User) => {\r\n    try {\r\n      const res = await apiClient(\"/api/users\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(newUser),\r\n      })\r\n      if (!res.ok) throw new Error(\"Erreur lors de l'ajout\")\r\n      const created = await res.json()\r\n      setUsers((prev) => [...prev, created])\r\n      toast.success(\"Utilisateur ajouté avec succès\")\r\n    } catch {\r\n      toast.error(\"Erreur lors de l'ajout de l'utilisateur\")\r\n    }\r\n  }\r\n\r\n  const handleEditUser = async (updatedUser: User) => {\r\n    try {\r\n      const res = await apiClient(`/api/users/${updatedUser.id_user}`, {\r\n        method: \"PUT\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(updatedUser),\r\n      })\r\n      if (!res.ok) throw new Error(\"Erreur lors de la modification\")\r\n      const user = await res.json()\r\n      setUsers((prev) => prev.map((u) => (u.id_user === user.id_user ? user : u)))\r\n      toast.success(\"Utilisateur modifié avec succès\")\r\n    } catch {\r\n      toast.error(\"Erreur lors de la modification de l'utilisateur\")\r\n    }\r\n  }\r\n\r\n  const confirmDeleteUser = async () => {\r\n    if (userToDelete) {\r\n      try {\r\n        const res = await apiClient(`/api/users/${userToDelete.id_user}`, {\r\n          method: \"DELETE\",\r\n        })\r\n        if (!res.ok) throw new Error(\"Erreur lors de la suppression\")\r\n        setUsers((prev) => prev.filter((u) => u.id_user !== userToDelete.id_user))\r\n        toast.success(\"Utilisateur supprimé avec succès\")\r\n      } catch {\r\n        toast.error(\"Erreur lors de la suppression de l'utilisateur\")\r\n      } finally {\r\n        setUserToDelete(null)\r\n        setIsDeleteOpen(false)\r\n      }\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 text-gray-900 dark:text-white\">\r\n      {/* HEADER */}\r\n      <div className=\"flex flex-col sm:flex-row items-center justify-between mb-6 bg-white dark:bg-gray-900 p-4 rounded-2xl shadow-md border border-gray-100 dark:border-gray-800\">\r\n        <div className=\"flex items-center gap-2 text-[#d61353]\">\r\n          <User className=\"w-6 h-6\" />\r\n          <h1 className=\"text-xl sm:text-2xl font-bold\">Gestion des utilisateurs</h1>\r\n        </div>\r\n        <button\r\n          onClick={() => setIsModalOpen(true)}\r\n          className=\"flex items-center gap-2 bg-[#d61353] hover:bg-[#b01044] text-white px-4 py-2 rounded-lg shadow transition-all\"\r\n        >\r\n          <Plus className=\"w-5 h-5\" />\r\n          <span>Ajouter un utilisateur</span>\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"flex justify-end mb-4\">\r\n        <div className=\"relative w-full md:w-72\">\r\n          <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500\" />\r\n          <Input\r\n            placeholder=\"Rechercher...\"\r\n            value={searchQuery}\r\n            onChange={(e) => setSearchQuery(e.target.value)}\r\n            className=\"pl-9 bg-white dark:bg-gray-800\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      <ToastContainer />\r\n\r\n      {/* TABLE */}\r\n      <div className=\"overflow-x-auto bg-white dark:bg-gray-900 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-800\">\r\n        {loading ? (\r\n          <div className=\"flex flex-col items-center justify-center py-10\">\r\n            <div className=\"w-10 h-10 border-4 border-[#d61353]/30 border-t-[#d61353] rounded-full animate-spin\"></div>\r\n            <p className=\"mt-3 text-gray-600 dark:text-gray-300 font-medium\">\r\n              Chargement des utilisateurs...\r\n            </p>\r\n          </div>\r\n        ) : error ? (\r\n\r\n          <div className=\"text-center text-red-500 py-8\">{error}</div>\r\n        ) : users.length === 0 ? (\r\n          <div className=\"text-center py-8 text-gray-500\">Aucun utilisateur trouvé</div>\r\n        ) : (\r\n          <div>\r\n            <table className=\"min-w-full text-sm border-collapse\">\r\n              <thead>\r\n                <tr className=\"bg-gray-50 dark:bg-gray-800 text-left text-gray-700 dark:text-gray-300 uppercase text-xs tracking-wider\">\r\n                  <th className=\"px-6 py-3\">Nom & Prénom</th>\r\n                  <th className=\"px-6 py-3\">Type d&apos;utilisateur</th>\r\n                  <th className=\"px-6 py-3\">Email & Contact</th>\r\n                  <th className=\"px-6 py-3\">Date de création</th>\r\n                  <th className=\"px-6 py-3 text-center\">Actions</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"divide-y divide-gray-200 dark:divide-gray-700\">\r\n                {!loading && filteredUsers.length === 0 && (\r\n                  <tr>\r\n                    <td colSpan={5} className=\"text-center py-6 text-gray-500\">\r\n                      Aucun utilisateur trouvé.\r\n                    </td>\r\n                  </tr>\r\n                )}\r\n                {filteredUsers.map((user, index) => (\r\n                  <tr\r\n                    key={user.id_user}\r\n                    className={`transition hover:bg-gray-100 dark:hover:bg-gray-800 ${index % 2 === 0 ? \"bg-white dark:bg-gray-900\" : \"bg-gray-50 dark:bg-gray-950\"\r\n                      }`}\r\n                  >\r\n                    <td className=\"px-6 py-4 font-medium\">\r\n                      {user.nom} {user.prenom}\r\n                    </td>\r\n                    <td className=\"px-6 py-4\">\r\n                      <span\r\n                        className={`px-3 py-1 text-xs font-semibold rounded-full ${getUserBadgeColor(user.type_user)}`}\r\n                      >\r\n                        {formatUserType(user.type_user)}\r\n                      </span>\r\n                    </td>\r\n                    <td className=\"px-6 py-4\">\r\n                      <div className=\"flex flex-col\">\r\n                        <span className=\"font-medium\">{user.email}</span>\r\n                        <span className=\"text-xs text-gray-500\">{user.contact}</span>\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"px-6 py-4\">\r\n                      {new Date(user.created_at).toLocaleDateString(\"fr-FR\")}\r\n                    </td>\r\n                    <td className=\"px-6 py-4 text-center\">\r\n                      <div className=\"flex justify-center gap-3\">\r\n                        <button\r\n                          onClick={() => {\r\n                            setUserToEdit(user) // 👈 On stocke l'utilisateur sélectionné\r\n                            setIsEditModalOpen(true)\r\n                          }}\r\n                          className=\"p-2 rounded-lg  cursor-pointer  bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-800 transition\"\r\n                        >\r\n                          <Pencil className=\"w-4 h-4\" />\r\n                        </button>\r\n\r\n                        <button\r\n                          onClick={() => {\r\n                            setUserToDelete(user)\r\n                            setIsDeleteOpen(true)\r\n                          }}\r\n                          className=\"p-2  cursor-pointer  rounded-lg bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-800 transition\"\r\n                        >\r\n                          <Trash2 className=\"w-4 h-4\" />\r\n                        </button>\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n            {totalPages === 1 ? ''\r\n              : <Paginate pages={totalPages} currentPage={page} />\r\n            }\r\n          </div>\r\n\r\n        )}\r\n      </div>\r\n\r\n      {/* MODALS */}\r\n      <AddUserModal\r\n        isOpen={isModalOpen}\r\n        onClose={() => setIsModalOpen(false)}\r\n        onAddUser={handleAddUser}\r\n      />\r\n      <EditUserModal\r\n        isOpen={isEditModalOpen}\r\n        onClose={() => {\r\n          setIsEditModalOpen(false)\r\n          setUserToEdit(null)\r\n        }}\r\n        onEditUser={handleEditUser}\r\n        user={userToEdit}\r\n      />\r\n\r\n      <DeleteUserModal\r\n        isOpen={isDeleteOpen}\r\n        onClose={() => {\r\n          setIsDeleteOpen(false)\r\n          setUserToDelete(null)\r\n        }}\r\n        onConfirm={confirmDeleteUser}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\components\\version-switcher.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ChevronsUpDown' is defined but never used.","line":4,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { Check, ChevronsUpDown, GalleryVerticalEnd } from \"lucide-react\"\r\n\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport {\r\n  SidebarMenu,\r\n  SidebarMenuButton,\r\n  SidebarMenuItem,\r\n} from \"@/components/ui/sidebar\"\r\n\r\nexport function VersionSwitcher({\r\n  versions,\r\n  defaultVersion,\r\n}: {\r\n  versions: string[]\r\n  defaultVersion: string\r\n}) {\r\n  const [selectedVersion, setSelectedVersion] = React.useState(defaultVersion)\r\n\r\n  return (\r\n    <SidebarMenu>\r\n      <SidebarMenuItem>\r\n        <DropdownMenu>\r\n          <DropdownMenuTrigger asChild>\r\n            <SidebarMenuButton\r\n              size=\"lg\"\r\n              className=\"data-[state=open]:bg-sidebar-accent data-[state=open]:text-sidebar-accent-foreground\"\r\n            >\r\n              <div className=\"bg-sidebar-primary text-sidebar-primary-foreground flex aspect-square size-8 items-center justify-center rounded-lg\">\r\n                <GalleryVerticalEnd className=\"size-4\" />\r\n              </div>\r\n              <div className=\"flex flex-col gap-0.5 leading-none\">\r\n                <span className=\"font-medium\">CampTrack</span>\r\n                {/* <span className=\"\">v{selectedVersion}</span> */}\r\n              </div>\r\n\r\n            </SidebarMenuButton>\r\n          </DropdownMenuTrigger>\r\n          <DropdownMenuContent\r\n            className=\"w-(--radix-dropdown-menu-trigger-width)\"\r\n            align=\"start\"\r\n          >\r\n            {versions.map((version) => (\r\n              <DropdownMenuItem\r\n                key={version}\r\n                onSelect={() => setSelectedVersion(version)}\r\n              >\r\n                v{version}{\" \"}\r\n                {version === selectedVersion && <Check className=\"ml-auto\" />}\r\n              </DropdownMenuItem>\r\n            ))}\r\n          </DropdownMenuContent>\r\n        </DropdownMenu>\r\n      </SidebarMenuItem>\r\n    </SidebarMenu>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\debug-notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\globals.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\hooks\\use-mobile.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\hooks\\useNotifications.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[321,324],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[321,324],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from 'react';\r\n\r\nexport interface Notification {\r\n    id_notification: string;\r\n    type: string;\r\n    priority: string;\r\n    user_id: string;\r\n    entity_type: string;\r\n    entity_id: string;\r\n    title: string;\r\n    message: string;\r\n    action_url?: string;\r\n    metadata?: any;\r\n    is_read: boolean;\r\n    read_at?: string;\r\n    created_at: string;\r\n}\r\n\r\ninterface UseNotificationsReturn {\r\n    notifications: Notification[];\r\n    unreadCount: number;\r\n    loading: boolean;\r\n    error: string | null;\r\n    refresh: () => Promise<void>;\r\n    markAsRead: (id: string) => Promise<void>;\r\n    markAllAsRead: () => Promise<void>;\r\n}\r\n\r\nexport function useNotifications(): UseNotificationsReturn {\r\n    const [notifications, setNotifications] = useState<Notification[]>([]);\r\n    const [unreadCount, setUnreadCount] = useState(0);\r\n    const [loading, setLoading] = useState(true);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    const fetchNotifications = useCallback(async () => {\r\n        try {\r\n            setLoading(true);\r\n            const response = await fetch('/api/notifications?limit=20');\r\n\r\n            if (!response.ok) {\r\n                // Si erreur 500 ou 401, on suppose que c'est un problème de session/auth\r\n                // On ne lance pas d'erreur critique pour ne pas spammer la console\r\n                if (response.status === 500 || response.status === 401) {\r\n                    console.warn('Impossible de récupérer les notifications (Session possiblement expirée ou erreur serveur)');\r\n                    setNotifications([]);\r\n                    return;\r\n                }\r\n                throw new Error(`Failed to fetch notifications: ${response.status}`);\r\n            }\r\n\r\n            const data = await response.json();\r\n            setNotifications(data.notifications);\r\n            setUnreadCount(data.unread_count);\r\n            setError(null);\r\n        } catch (err) {\r\n            setError(err instanceof Error ? err.message : 'An error occurred');\r\n            // On utilise warn au lieu de error pour ne pas spammer la console\r\n            console.warn('Error fetching notifications:', err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, []);\r\n\r\n    const markAsRead = async (id: string) => {\r\n        try {\r\n            // Optimistic update\r\n            setNotifications(prev =>\r\n                prev.map(n => n.id_notification === id ? { ...n, is_read: true } : n)\r\n            );\r\n            setUnreadCount(prev => Math.max(0, prev - 1));\r\n\r\n            const response = await fetch(`/api/notifications/${id}/read`, {\r\n                method: 'PUT'\r\n            });\r\n\r\n            if (!response.ok) {\r\n                throw new Error('Failed to mark notification as read');\r\n            }\r\n        } catch (err) {\r\n            console.error('Error marking notification as read:', err);\r\n            // Revert on error (could be improved)\r\n            fetchNotifications();\r\n        }\r\n    };\r\n\r\n    const markAllAsRead = async () => {\r\n        try {\r\n            // Optimistic update\r\n            setNotifications(prev => prev.map(n => ({ ...n, is_read: true })));\r\n            setUnreadCount(0);\r\n\r\n            const response = await fetch('/api/notifications/read-all', {\r\n                method: 'PUT'\r\n            });\r\n\r\n            if (!response.ok) {\r\n                throw new Error('Failed to mark all notifications as read');\r\n            }\r\n        } catch (err) {\r\n            console.error('Error marking all notifications as read:', err);\r\n            fetchNotifications();\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchNotifications();\r\n\r\n        // Optional: Poll for new notifications every minute\r\n        const interval = setInterval(fetchNotifications, 60000);\r\n        return () => clearInterval(interval);\r\n    }, [fetchNotifications]);\r\n\r\n    return {\r\n        notifications,\r\n        unreadCount,\r\n        loading,\r\n        error,\r\n        refresh: fetchNotifications,\r\n        markAsRead,\r\n        markAllAsRead\r\n    };\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\auth\\hash.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\auth\\jwt.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\auth\\tokenCleanup.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\business\\paiement.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\export-utils.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Prisma' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[287,290],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[287,290],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2267,2270],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2267,2270],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as XLSX from 'xlsx';\r\nimport { prisma } from '@/lib/prisma';\r\nimport { Prisma } from '@prisma/client';\r\n\r\nexport type ExportModel = 'campagne' | 'prestataire' | 'user' | 'client';\r\n\r\nexport async function exportDataToBuffer(model: ExportModel): Promise<Buffer> {\r\n    let data: any[] = [];\r\n\r\n    try {\r\n        switch (model) {\r\n            case 'campagne':\r\n                data = await prisma.campagne.findMany({\r\n                    include: {\r\n                        client: { select: { nom: true, entreprise: true } },\r\n                        lieu: { select: { nom: true, ville: true } },\r\n                        gestionnaire: { select: { nom: true, prenom: true } },\r\n                        service: { select: { nom: true } }\r\n                    },\r\n                    orderBy: { date_creation: 'desc' }\r\n                });\r\n                break;\r\n\r\n            case 'prestataire':\r\n                data = await prisma.prestataire.findMany({\r\n                    include: {\r\n                        service: { select: { nom: true } }\r\n                    },\r\n                    orderBy: { nom: 'asc' }\r\n                });\r\n                break;\r\n\r\n            case 'user':\r\n                data = await prisma.user.findMany({\r\n                    select: {\r\n                        id_user: true,\r\n                        nom: true,\r\n                        prenom: true,\r\n                        email: true,\r\n                        type_user: true,\r\n                        contact: true,\r\n                        is_active: true,\r\n                        created_at: true\r\n                    },\r\n                    orderBy: { nom: 'asc' }\r\n                });\r\n                break;\r\n\r\n            case 'client':\r\n                data = await prisma.client.findMany({\r\n                    orderBy: { nom: 'asc' }\r\n                });\r\n                break;\r\n\r\n            default:\r\n                throw new Error(`Model ${model} not supported for export`);\r\n        }\r\n\r\n        if (data.length === 0) {\r\n            // Return empty excel with headers if no data, or just empty array\r\n        }\r\n\r\n        // Flatten data for Excel (simple flattening)\r\n        const flattenedData = data.map(item => {\r\n            const flatItem: any = {};\r\n            for (const key in item) {\r\n                if (typeof item[key] === 'object' && item[key] !== null && !(item[key] instanceof Date)) {\r\n                    // Handle nested objects (like client.nom)\r\n                    for (const subKey in item[key]) {\r\n                        flatItem[`${key}_${subKey}`] = item[key][subKey];\r\n                    }\r\n                } else {\r\n                    flatItem[key] = item[key];\r\n                }\r\n            }\r\n            return flatItem;\r\n        });\r\n\r\n        // Create workbook and worksheet\r\n        const worksheet = XLSX.utils.json_to_sheet(flattenedData);\r\n        const workbook = XLSX.utils.book_new();\r\n        XLSX.utils.book_append_sheet(workbook, worksheet, model);\r\n\r\n        // Generate buffer\r\n        const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });\r\n        return buffer;\r\n\r\n    } catch (error) {\r\n        console.error(\"Export error:\", error);\r\n        throw new Error(\"Failed to generate export file\");\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\middleware\\authMiddleware.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[266,269],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[266,269],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { verifyAccessToken } from \"@/lib/auth/jwt\";\r\nimport { prisma } from \"@/lib/prisma\";\r\n\r\ntype TokenPayloadShape = { jti?: string; userId?: string; sub?: string };\r\n\r\ninterface AuthResult {\r\n  ok: boolean;\r\n  user?: any;\r\n  loading: boolean;\r\n  response?: NextResponse;\r\n}\r\n\r\n// Fonction pour vérifier si un token est révoqué via son jti\r\nasync function isTokenRevoked(jti: string): Promise<boolean> {\r\n  const revokedToken = await prisma.revokedToken.findFirst({\r\n    where: {\r\n      jti: jti,\r\n      expires_at: {\r\n        gt: new Date()\r\n      }\r\n    }\r\n  });\r\n\r\n  return !!revokedToken;\r\n}\r\n\r\nexport async function requireAuth(req: Request): Promise<AuthResult> {\r\n  try {\r\n    const auth = req.headers.get(\"authorization\") || \"\";\r\n    if (!auth.startsWith(\"Bearer \")) {\r\n      return {\r\n        ok: false,\r\n        response: NextResponse.json({ error: \"Token d'autorisation manquant\" }, { status: 401 })\r\n      };\r\n    }\r\n\r\n    const token = auth.replace(/^Bearer\\s+/i, \"\");\r\n\r\n    let payload: TokenPayloadShape;\r\n    try {\r\n      payload = verifyAccessToken(token) as TokenPayloadShape;\r\n    } catch (err) {\r\n      console.error(\"❌ Token invalide:\", err);\r\n      return {\r\n        ok: false,\r\n        response: NextResponse.json({ error: \"Token invalide ou expiré\" }, { status: 401 })\r\n      };\r\n    }\r\n\r\n    // VÉRIFICATION CRITIQUE : Token révoqué via jti ?\r\n    if (payload && payload.jti) {\r\n      const isRevoked = await isTokenRevoked(payload.jti);\r\n      if (isRevoked) {\r\n        return {\r\n          ok: false,\r\n          response: NextResponse.json({ error: \"Session expirée - Veuillez vous reconnecter\" }, { status: 401 })\r\n        };\r\n      }\r\n    }\r\n\r\n    const userId = payload && (payload.userId || payload.sub);\r\n    if (!userId) {\r\n      return {\r\n        ok: false,\r\n        response: NextResponse.json({ error: \"Payload du token invalide\" }, { status: 401 })\r\n      };\r\n    }\r\n\r\n    const user = await prisma.user.findFirst({\r\n      where: {\r\n        id_user: String(userId),\r\n        is_active: true\r\n      }\r\n    });\r\n\r\n    if (!user) {\r\n      return {\r\n        ok: false,\r\n        response: NextResponse.json({ error: \"Utilisateur non trouvé ou compte désactivé\" }, { status: 401 })\r\n      };\r\n    }\r\n\r\n    return { ok: true, user };\r\n  } catch (err) {\r\n    console.error(\"❌ Erreur middleware:\", err);\r\n    return {\r\n      ok: false,\r\n      response: NextResponse.json({ error: \"Erreur interne du serveur\" }, { status: 500 })\r\n    };\r\n  }\r\n}\r\n\r\nexport async function requireAdmin(req: Request): Promise<AuthResult> {\r\n  const authResult = await requireAuth(req);\r\n\r\n  if (!authResult.ok) {\r\n    return authResult;\r\n  }\r\n\r\n  if (authResult.user?.type_user !== \"ADMIN\") {\r\n    return {\r\n      ok: false,\r\n      response: NextResponse.json({ error: \"Accès refusé - Admin requis\" }, { status: 403 })\r\n    };\r\n  }\r\n\r\n  return authResult;\r\n}\r\n\r\nexport async function requireRoles(req: Request, allowedRoles: string[]): Promise<AuthResult> {\r\n  const authResult = await requireAuth(req);\r\n\r\n  if (!authResult.ok) {\r\n    return authResult;\r\n  }\r\n\r\n  if (!allowedRoles.includes(authResult.user?.type_user)) {\r\n    return {\r\n      ok: false,\r\n      response: NextResponse.json({\r\n        error: \"Accès refusé - Rôle insuffisant\",\r\n        requiredRoles: allowedRoles\r\n      }, { status: 403 })\r\n    };\r\n  }\r\n\r\n  return authResult;\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\middleware\\tokenBlacklist.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\prisma.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\services\\notificationService.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'NotificationType' is defined but never used.","line":6,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":40},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'NotificationPriority' is defined but never used.","line":6,"column":60,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":80}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Service de Gestion des Notifications In-App\r\n * Génère et gère les notifications pour les campagnes et affectations\r\n */\r\n\r\nimport { PrismaClient, NotificationType, NotificationRule, NotificationPriority } from '@prisma/client';\r\nimport { renderTemplate } from '@/lib/utils/templateEngine';\r\nimport { addDays, startOfDay, endOfDay, formatDate } from '@/lib/utils/dateHelpers';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nexport interface GenerationResult {\r\n    success: boolean;\r\n    campaignNotifications: number;\r\n    assignmentNotifications: number;\r\n    total: number;\r\n    errors: string[];\r\n}\r\n\r\nexport interface GetNotificationsOptions {\r\n    unreadOnly?: boolean;\r\n    limit?: number;\r\n    offset?: number;\r\n}\r\n\r\nexport class NotificationService {\r\n    /**\r\n     * Génère toutes les notifications selon les règles actives\r\n     */\r\n    async generateNotifications(): Promise<GenerationResult> {\r\n        const result: GenerationResult = {\r\n            success: true,\r\n            campaignNotifications: 0,\r\n            assignmentNotifications: 0,\r\n            total: 0,\r\n            errors: []\r\n        };\r\n\r\n        try {\r\n            // Récupérer toutes les règles actives\r\n            const rules = await prisma.notificationRule.findMany({\r\n                where: { is_active: true }\r\n            });\r\n\r\n            console.log(`📋 ${rules.length} règles actives trouvées`);\r\n\r\n            // Traiter chaque règle\r\n            for (const rule of rules) {\r\n                try {\r\n                    if (rule.type === 'CAMPAIGN_EXPIRING') {\r\n                        const count = await this.generateCampaignNotifications(rule);\r\n                        result.campaignNotifications += count;\r\n                        console.log(`✅ ${count} notifications de campagne créées`);\r\n                    } else {\r\n                        const count = await this.generateAssignmentNotifications(rule);\r\n                        result.assignmentNotifications += count;\r\n                        console.log(`✅ ${count} notifications d'affectation créées (${rule.type})`);\r\n                    }\r\n                } catch (error) {\r\n                    const errorMsg = `Erreur pour la règle ${rule.type}: ${error instanceof Error ? error.message : 'Unknown error'}`;\r\n                    console.error(`❌ ${errorMsg}`);\r\n                    result.errors.push(errorMsg);\r\n                    result.success = false;\r\n                }\r\n            }\r\n\r\n            result.total = result.campaignNotifications + result.assignmentNotifications;\r\n            console.log(`\\n🎉 Total: ${result.total} notifications générées`);\r\n\r\n            return result;\r\n        } catch (error) {\r\n            console.error('❌ Erreur lors de la génération des notifications:', error);\r\n            result.success = false;\r\n            result.errors.push(error instanceof Error ? error.message : 'Unknown error');\r\n            return result;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Génère les notifications pour les campagnes qui expirent\r\n     */\r\n    async generateCampaignNotifications(rule: NotificationRule): Promise<number> {\r\n        const targetDate = addDays(new Date(), rule.days_before);\r\n        let count = 0;\r\n\r\n        // Trouver les campagnes qui expirent à la date cible\r\n        const campaigns = await prisma.campagne.findMany({\r\n            where: {\r\n                date_fin: {\r\n                    gte: startOfDay(targetDate),\r\n                    lte: endOfDay(targetDate)\r\n                },\r\n                status: {\r\n                    notIn: ['TERMINEE', 'ANNULEE']\r\n                }\r\n            },\r\n            include: {\r\n                gestionnaire: true,\r\n                superviseur: true\r\n            }\r\n        });\r\n\r\n        console.log(`🔍 ${campaigns.length} campagnes trouvées expirant le ${formatDate(targetDate)}`);\r\n\r\n        for (const campaign of campaigns) {\r\n            // Vérifier si la notification existe déjà\r\n            const existing = await prisma.notification.findFirst({\r\n                where: {\r\n                    entity_type: 'CAMPAGNE',\r\n                    entity_id: campaign.id_campagne,\r\n                    type: rule.type,\r\n                    user_id: campaign.id_superviseur || campaign.id_gestionnaire\r\n                }\r\n            });\r\n\r\n            if (!existing) {\r\n                // Créer la notification\r\n                await prisma.notification.create({\r\n                    data: {\r\n                        type: rule.type,\r\n                        priority: rule.priority,\r\n                        user_id: campaign.id_superviseur || campaign.id_gestionnaire,\r\n                        entity_type: 'CAMPAGNE',\r\n                        entity_id: campaign.id_campagne,\r\n                        title: renderTemplate(rule.title_template, {\r\n                            nom_campagne: campaign.nom_campagne,\r\n                            jours: rule.days_before\r\n                        }),\r\n                        message: renderTemplate(rule.message_template, {\r\n                            nom_campagne: campaign.nom_campagne,\r\n                            date_fin: formatDate(campaign.date_fin),\r\n                            jours: rule.days_before\r\n                        }),\r\n                        action_url: `/campagnes/${campaign.id_campagne}`,\r\n                        metadata: {\r\n                            campaign_name: campaign.nom_campagne,\r\n                            campaign_end: campaign.date_fin.toISOString(),\r\n                            days_before: rule.days_before\r\n                        }\r\n                    }\r\n                });\r\n                count++;\r\n            }\r\n        }\r\n\r\n        return count;\r\n    }\r\n\r\n    /**\r\n     * Génère les notifications pour les affectations qui expirent\r\n     */\r\n    async generateAssignmentNotifications(rule: NotificationRule): Promise<number> {\r\n        const targetDate = addDays(new Date(), rule.days_before);\r\n        let count = 0;\r\n\r\n        // Trouver les affectations qui expirent à la date cible\r\n        const assignments = await prisma.prestataireCampagne.findMany({\r\n            where: {\r\n                date_fin: {\r\n                    gte: startOfDay(targetDate),\r\n                    lte: endOfDay(targetDate)\r\n                },\r\n                status: 'ACTIF'\r\n            },\r\n            include: {\r\n                prestataire: true,\r\n                campagne: {\r\n                    include: {\r\n                        gestionnaire: true,\r\n                        superviseur: true\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        console.log(`🔍 ${assignments.length} affectations trouvées expirant le ${formatDate(targetDate)}`);\r\n\r\n        for (const assignment of assignments) {\r\n            const entityId = `${assignment.id_campagne}:${assignment.id_prestataire}`;\r\n\r\n            // Vérifier si la notification existe déjà\r\n            const existing = await prisma.notification.findFirst({\r\n                where: {\r\n                    entity_type: 'AFFECTATION',\r\n                    entity_id: entityId,\r\n                    type: rule.type,\r\n                    user_id: assignment.campagne.id_superviseur || assignment.campagne.id_gestionnaire\r\n                }\r\n            });\r\n\r\n            if (!existing) {\r\n                // Créer la notification\r\n                await prisma.notification.create({\r\n                    data: {\r\n                        type: rule.type,\r\n                        priority: rule.priority,\r\n                        user_id: assignment.campagne.id_superviseur || assignment.campagne.id_gestionnaire,\r\n                        entity_type: 'AFFECTATION',\r\n                        entity_id: entityId,\r\n                        title: renderTemplate(rule.title_template, {\r\n                            prestataire_nom: `${assignment.prestataire.prenom} ${assignment.prestataire.nom}`,\r\n                            jours: rule.days_before\r\n                        }),\r\n                        message: renderTemplate(rule.message_template, {\r\n                            prestataire_nom: `${assignment.prestataire.prenom} ${assignment.prestataire.nom}`,\r\n                            campagne_nom: assignment.campagne.nom_campagne,\r\n                            date_fin: assignment.date_fin ? formatDate(assignment.date_fin) : 'N/A',\r\n                            jours: rule.days_before\r\n                        }),\r\n                        action_url: `/campagnes/${assignment.id_campagne}/prestataires`,\r\n                        metadata: {\r\n                            provider_name: `${assignment.prestataire.prenom} ${assignment.prestataire.nom}`,\r\n                            campaign_name: assignment.campagne.nom_campagne,\r\n                            assignment_end: assignment.date_fin?.toISOString(),\r\n                            days_before: rule.days_before\r\n                        }\r\n                    }\r\n                });\r\n                count++;\r\n            }\r\n        }\r\n\r\n        return count;\r\n    }\r\n\r\n    /**\r\n     * Récupère les notifications d'un utilisateur\r\n     */\r\n    async getUserNotifications(userId: string, options?: GetNotificationsOptions) {\r\n        const { unreadOnly = false, limit = 20, offset = 0 } = options || {};\r\n\r\n        return await prisma.notification.findMany({\r\n            where: {\r\n                user_id: userId,\r\n                ...(unreadOnly ? { is_read: false } : {})\r\n            },\r\n            orderBy: {\r\n                created_at: 'desc'\r\n            },\r\n            take: limit,\r\n            skip: offset\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Compte les notifications non lues d'un utilisateur\r\n     */\r\n    async getUnreadCount(userId: string): Promise<number> {\r\n        return await prisma.notification.count({\r\n            where: {\r\n                user_id: userId,\r\n                is_read: false\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Marque une notification comme lue\r\n     */\r\n    async markAsRead(notificationId: string): Promise<void> {\r\n        await prisma.notification.update({\r\n            where: { id_notification: notificationId },\r\n            data: {\r\n                is_read: true,\r\n                read_at: new Date()\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Marque toutes les notifications d'un utilisateur comme lues\r\n     */\r\n    async markAllAsRead(userId: string): Promise<number> {\r\n        const result = await prisma.notification.updateMany({\r\n            where: {\r\n                user_id: userId,\r\n                is_read: false\r\n            },\r\n            data: {\r\n                is_read: true,\r\n                read_at: new Date()\r\n            }\r\n        });\r\n\r\n        return result.count;\r\n    }\r\n\r\n    /**\r\n     * Supprime une notification\r\n     */\r\n    async deleteNotification(notificationId: string): Promise<void> {\r\n        await prisma.notification.delete({\r\n            where: { id_notification: notificationId }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Supprime les anciennes notifications (nettoyage)\r\n     */\r\n    async deleteOldNotifications(daysOld: number = 30): Promise<number> {\r\n        const cutoffDate = addDays(new Date(), -daysOld);\r\n\r\n        const result = await prisma.notification.deleteMany({\r\n            where: {\r\n                created_at: {\r\n                    lt: cutoffDate\r\n                }\r\n            }\r\n        });\r\n\r\n        return result.count;\r\n    }\r\n}\r\n\r\n// Export d'une instance singleton\r\nexport const notificationService = new NotificationService();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\swagger\\config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\utils\\campaignAutoTermination.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[672,675],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[672,675],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client';\r\n\r\n/**\r\n * Interface pour le résultat de l'auto-clôture des campagnes\r\n */\r\nexport interface AutoTerminationResult {\r\n    success: boolean;\r\n    campaignsTerminated: number;\r\n    providersReleased: number;\r\n    affectationsClosed: number;\r\n    terminatedCampaignIds: string[];\r\n    error?: string;\r\n}\r\n\r\n/**\r\n * Fonction utilitaire pour clôturer automatiquement les campagnes expirées\r\n * et libérer les prestataires assignés\r\n * \r\n * @param prisma - Instance PrismaClient (ou transaction)\r\n * @returns Résultat de l'opération avec statistiques\r\n */\r\nexport async function autoTerminateCampaigns(\r\n    prisma: PrismaClient | any\r\n): Promise<AutoTerminationResult> {\r\n    try {\r\n        const now = new Date();\r\n\r\n        // Identifier les campagnes expirées (date_fin passée et non terminées)\r\n        const expiredCampaigns = await prisma.campagne.findMany({\r\n            where: {\r\n                date_fin: { lt: now },\r\n                status: { notIn: ['TERMINEE', 'ANNULEE'] }\r\n            },\r\n            select: {\r\n                id_campagne: true,\r\n                nom_campagne: true,\r\n                date_fin: true\r\n            }\r\n        });\r\n\r\n        const expiredCampaignIds = expiredCampaigns.map((c: { id_campagne: string }) => c.id_campagne);\r\n\r\n        if (expiredCampaignIds.length === 0) {\r\n            return {\r\n                success: true,\r\n                campaignsTerminated: 0,\r\n                providersReleased: 0,\r\n                affectationsClosed: 0,\r\n                terminatedCampaignIds: []\r\n            };\r\n        }\r\n\r\n        // Mettre à jour uniquement le statut des campagnes\r\n        // Les prestataires restent affectés jusqu'à leur date_fin personnelle\r\n        await prisma.campagne.updateMany({\r\n            where: { id_campagne: { in: expiredCampaignIds } },\r\n            data: { status: 'TERMINEE' }\r\n        });\r\n\r\n        // Log pour le monitoring\r\n        console.log(`[AUTO-TERMINATION] ${expiredCampaignIds.length} campagne(s) clôturée(s)`, {\r\n            campaigns: expiredCampaigns.map((c: { id_campagne: string; nom_campagne: string; date_fin: Date }) => ({\r\n                id: c.id_campagne,\r\n                name: c.nom_campagne,\r\n                endDate: c.date_fin\r\n            })),\r\n            timestamp: now.toISOString()\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            campaignsTerminated: expiredCampaignIds.length,\r\n            providersReleased: 0, // Plus de libération automatique\r\n            affectationsClosed: 0, // Plus de clôture automatique\r\n            terminatedCampaignIds: expiredCampaignIds\r\n        };\r\n\r\n    } catch (error) {\r\n        console.error('[AUTO-TERMINATION] Erreur lors de la clôture automatique:', error);\r\n        return {\r\n            success: false,\r\n            campaignsTerminated: 0,\r\n            providersReleased: 0,\r\n            affectationsClosed: 0,\r\n            terminatedCampaignIds: [],\r\n            error: error instanceof Error ? error.message : 'Erreur inconnue'\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Cache simple pour éviter l'exécution trop fréquente\r\n */\r\nclass AutoTerminationCache {\r\n    private lastExecution: Date | null = null;\r\n    private readonly CACHE_DURATION_MS = 5 * 60 * 1000; // 5 minutes\r\n\r\n    shouldExecute(): boolean {\r\n        if (!this.lastExecution) {\r\n            return true;\r\n        }\r\n\r\n        const now = new Date();\r\n        const timeSinceLastExecution = now.getTime() - this.lastExecution.getTime();\r\n        return timeSinceLastExecution >= this.CACHE_DURATION_MS;\r\n    }\r\n\r\n    markExecuted(): void {\r\n        this.lastExecution = new Date();\r\n    }\r\n\r\n    reset(): void {\r\n        this.lastExecution = null;\r\n    }\r\n}\r\n\r\nexport const autoTerminationCache = new AutoTerminationCache();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\utils\\dateHelpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\utils\\errorHandler.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\utils\\providerAutoRelease.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[634,637],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[634,637],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":73,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2305,2308],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2305,2308],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client';\r\n\r\n/**\r\n * Interface pour le résultat de l'auto-libération des prestataires\r\n */\r\nexport interface AutoReleaseResult {\r\n    success: boolean;\r\n    providersReleased: number;\r\n    affectationsClosed: number;\r\n    releasedProviderIds: string[];\r\n    error?: string;\r\n}\r\n\r\n/**\r\n * Fonction utilitaire pour libérer automatiquement les prestataires\r\n * dont la date_fin d'affectation est passée\r\n * \r\n * @param prisma - Instance PrismaClient (ou transaction)\r\n * @returns Résultat de l'opération avec statistiques\r\n */\r\nexport async function autoReleaseProviders(\r\n    prisma: PrismaClient | any\r\n): Promise<AutoReleaseResult> {\r\n    try {\r\n        const now = new Date();\r\n\r\n        // Trouver les affectations expirées (date_fin passée)\r\n        const expiredAssignments = await prisma.prestataireCampagne.findMany({\r\n            where: {\r\n                date_fin: {\r\n                    lt: now,\r\n                    not: null\r\n                }\r\n            },\r\n            select: {\r\n                id_prestataire: true,\r\n                id_campagne: true,\r\n                date_fin: true,\r\n                prestataire: {\r\n                    select: {\r\n                        nom: true,\r\n                        prenom: true\r\n                    }\r\n                },\r\n                campagne: {\r\n                    select: {\r\n                        nom_campagne: true\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        if (expiredAssignments.length === 0) {\r\n            return {\r\n                success: true,\r\n                providersReleased: 0,\r\n                affectationsClosed: 0,\r\n                releasedProviderIds: []\r\n            };\r\n        }\r\n\r\n        // Extraire les IDs uniques des prestataires\r\n        const prestataireIds = [...new Set(expiredAssignments.map((a: { id_prestataire: string }) => a.id_prestataire))];\r\n\r\n        // Libérer les prestataires\r\n        await prisma.prestataire.updateMany({\r\n            where: { id_prestataire: { in: prestataireIds } },\r\n            data: { disponible: true }\r\n        });\r\n\r\n        // Log pour le monitoring\r\n        console.log(`[AUTO-RELEASE] ${prestataireIds.length} prestataire(s) libéré(s)`, {\r\n            providers: expiredAssignments.map((a: any) => ({\r\n                id: a.id_prestataire,\r\n                name: `${a.prestataire.nom} ${a.prestataire.prenom}`,\r\n                campaign: a.campagne.nom_campagne,\r\n                endDate: a.date_fin\r\n            })),\r\n            timestamp: now.toISOString()\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            providersReleased: prestataireIds.length,\r\n            affectationsClosed: expiredAssignments.length,\r\n            releasedProviderIds: prestataireIds\r\n        };\r\n\r\n    } catch (error) {\r\n        console.error('[AUTO-RELEASE] Erreur lors de la libération automatique:', error);\r\n        return {\r\n            success: false,\r\n            providersReleased: 0,\r\n            affectationsClosed: 0,\r\n            releasedProviderIds: [],\r\n            error: error instanceof Error ? error.message : 'Erreur inconnue'\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Calcule la date de fin personnalisée pour un prestataire\r\n * basée sur la durée de la campagne\r\n * \r\n * @param dateDebutCampagne - Date de début de la campagne\r\n * @param dateFinCampagne - Date de fin de la campagne\r\n * @param dateAffectation - Date d'affectation du prestataire (défaut: maintenant)\r\n * @returns Date de fin personnalisée pour le prestataire\r\n */\r\nexport function calculateProviderEndDate(\r\n    dateDebutCampagne: Date,\r\n    dateFinCampagne: Date,\r\n    dateAffectation: Date = new Date()\r\n): Date {\r\n    // Calculer la durée de la campagne en millisecondes\r\n    const dureeCampagne = dateFinCampagne.getTime() - dateDebutCampagne.getTime();\r\n\r\n    // Calculer la date de fin personnalisée\r\n    const dateFinPrestataire = new Date(dateAffectation.getTime() + dureeCampagne);\r\n\r\n    return dateFinPrestataire;\r\n}\r\n\r\n/**\r\n * Cache simple pour éviter l'exécution trop fréquente\r\n */\r\nclass AutoReleaseCache {\r\n    private lastExecution: Date | null = null;\r\n    private readonly CACHE_DURATION_MS = 5 * 60 * 1000; // 5 minutes\r\n\r\n    shouldExecute(): boolean {\r\n        if (!this.lastExecution) {\r\n            return true;\r\n        }\r\n\r\n        const now = new Date();\r\n        const timeSinceLastExecution = now.getTime() - this.lastExecution.getTime();\r\n        return timeSinceLastExecution >= this.CACHE_DURATION_MS;\r\n    }\r\n\r\n    markExecuted(): void {\r\n        this.lastExecution = new Date();\r\n    }\r\n\r\n    reset(): void {\r\n        this.lastExecution = null;\r\n    }\r\n}\r\n\r\nexport const autoReleaseCache = new AutoReleaseCache();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\utils\\templateEngine.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[500,503],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[500,503],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Template Engine Simple\r\n * Remplace les variables {{variable}} dans un template\r\n */\r\n\r\n/**\r\n * Rend un template avec les données fournies\r\n * @param template - Template avec des variables {{variable}}\r\n * @param data - Objet contenant les valeurs des variables\r\n * @returns Template rendu avec les valeurs\r\n * \r\n * @example\r\n * renderTemplate(\"Bonjour {{nom}}\", { nom: \"Jean\" })\r\n * // => \"Bonjour Jean\"\r\n */\r\nexport function renderTemplate(\r\n    template: string,\r\n    data: Record<string, any>\r\n): string {\r\n    return template.replace(/\\{\\{(\\w+)\\}\\}/g, (match, key) => {\r\n        return data[key] !== undefined ? String(data[key]) : match;\r\n    });\r\n}\r\n\r\n/**\r\n * Vérifie si un template est valide\r\n * @param template - Template à vérifier\r\n * @returns true si le template est valide\r\n */\r\nexport function isValidTemplate(template: string): boolean {\r\n    try {\r\n        // Vérifie que les accolades sont bien fermées\r\n        const openBraces = (template.match(/\\{\\{/g) || []).length;\r\n        const closeBraces = (template.match(/\\}\\}/g) || []).length;\r\n        return openBraces === closeBraces;\r\n    } catch {\r\n        return false;\r\n    }\r\n}\r\n\r\n/**\r\n * Extrait les variables d'un template\r\n * @param template - Template à analyser\r\n * @returns Liste des noms de variables\r\n * \r\n * @example\r\n * extractVariables(\"Bonjour {{nom}}, vous avez {{count}} messages\")\r\n * // => [\"nom\", \"count\"]\r\n */\r\nexport function extractVariables(template: string): string[] {\r\n    const matches = template.match(/\\{\\{(\\w+)\\}\\}/g) || [];\r\n    return matches.map(match => match.replace(/\\{\\{|\\}\\}/g, ''));\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\validation\\campagneSchemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\validation\\clientSchemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\validation\\incidentSchemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\validation\\lieuSchemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\validation\\materielsCaseSchemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\validation\\paiementSchemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\validation\\prestataireSchemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\validation\\schemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\lib\\validation\\serviceSchemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\next.config.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'NextConfig' is defined but never used.","line":1,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { NextConfig } from \"next\";\r\n\r\nconst nextConfig = {\r\n  typescript: {\r\n    ignoreBuildErrors: true,\r\n  },\r\n};\r\n\r\nexport default nextConfig;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\prisma\\fix-dates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\prisma\\import-prestataires.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[387,390],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[387,390],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1719,1722],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1719,1722],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":97,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3867,3870],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3867,3870],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":99,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4015,4018],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4015,4018],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient, TypePanneau } from '@prisma/client';\r\nimport * as XLSX from 'xlsx';\r\nimport * as fs from 'fs';\r\nimport path from 'path';\r\nconst prisma = new PrismaClient();\r\n// Chemin vers votre fichier Excel - MODIFIEZ CECI\r\nconst EXCEL_FILE_PATH = path.join(__dirname, '../data/prestataires.xlsx');\r\n// Fonction utilitaire pour mapper les booléens\r\nfunction parseBoolean(value: any): boolean {\r\n  if (typeof value === 'boolean') return value;\r\n  if (typeof value === 'string') {\r\n    const v = value.toLowerCase().trim();\r\n    return v === 'yes' || v === 'oui' || v === 'true' || v === '1' || v === 'vrais';\r\n  }\r\n  return !!value;\r\n}\r\n// Fonction utilitaire pour mapper le type de panneau\r\nfunction parsePanelType(value: string): TypePanneau | null {\r\n  if (!value) return null;\r\n  const v = value.toUpperCase().trim();\r\n  if (v.includes('PETIT')) return 'PETIT';\r\n  if (v.includes('GRAND')) return 'GRAND';\r\n  return null; // ou gérer une valeur par défaut\r\n}\r\nasync function main() {\r\n  console.log('🚀 Démarrage de l\\'importation...');\r\n  if (!fs.existsSync(EXCEL_FILE_PATH)) {\r\n    console.error(`❌ Erreur : Le fichier n'existe pas à l'emplacement : ${EXCEL_FILE_PATH}`);\r\n    process.exit(1);\r\n  }\r\n  // Lecture du fichier Excel\r\n  const workbook = XLSX.readFile(EXCEL_FILE_PATH);\r\n  const sheetName = workbook.SheetNames[0];\r\n  const sheet = workbook.Sheets[sheetName];\r\n\r\n  // Conversion en JSON\r\n  const data = XLSX.utils.sheet_to_json(sheet);\r\n  console.log(`📄 ${data.length} lignes trouvées dans le fichier.`);\r\n  let successCount = 0;\r\n  let errorCount = 0;\r\n  for (const [index, row] of data.entries()) {\r\n    const rowNum = index + 2; // +1 pour 0-index, +1 pour le header\r\n    const r = row as any;\r\n    try {\r\n      // Préparation de l'ID de vérification\r\n      const idVerificationBase = r['Verification ID'] ? String(r['Verification ID']) : null;\r\n\r\n      // Si un ID de vérification est fourni, on vérifie s'il existe déjà\r\n      if (idVerificationBase) {\r\n        const existingPrestataire = await prisma.prestataire.findFirst({\r\n          where: { id_verification: idVerificationBase },\r\n        });\r\n\r\n        if (existingPrestataire) {\r\n          console.warn(`⚠️ Doublon détecté ligne ${rowNum} (${r['Last Name']} ${r['First Name']}) : ID ${idVerificationBase} existe déjà. -> Ignoré.`);\r\n          // On passe au suivant sans erreur (ou compte comme ignoré ?)\r\n          continue;\r\n        }\r\n      }\r\n\r\n      // Génération de l'ID final (ou utilisation de celui fourni)\r\n      const finalIdVerification = idVerificationBase || `GEN-${Date.now()}-${index}`;\r\n\r\n      // Création\r\n      await prisma.prestataire.create({\r\n        data: {\r\n          // Mapping des colonnes Excel -> Champs DB\r\n          nom: r['Last Name'] || 'Inconnu',\r\n          prenom: r['First Name'] || 'Inconnu',\r\n          plaque: r['REGISTRATION NUMBER'] ? String(r['REGISTRATION NUMBER']) : null,\r\n          id_verification: finalIdVerification,\r\n          contact: r['CONTACTS'] ? String(r['CONTACTS']) : '',\r\n\r\n          type_panneau: parsePanelType(r['panel_type']),\r\n          marque: r['tricycle_brand'],\r\n          couleur: r['VEHICLE_COLORS'],\r\n\r\n          equipe_gps: parseBoolean(r['GPS_equipped']),\r\n          contrat_valide: parseBoolean(r['VALID_CONTRACT']),\r\n\r\n          // Gestion de la date\r\n          created_at: r['Creation_Date'] ? new Date(r['Creation_Date']) : new Date(),\r\n\r\n          // Relation Service - Assurez-vous que ce Service ID existe !\r\n          service: {\r\n            connect: { id_service: String(r['service_id']) }\r\n          }\r\n        }\r\n      });\r\n\r\n      process.stdout.write('.'); // Indicateur de progrès\r\n      successCount++;\r\n\r\n    } catch (error) {\r\n      console.error(`\\n❌ Erreur ligne ${rowNum} (${r['Last Name']} ${r['First Name']}):`);\r\n      // Gestion spécifique des erreurs Prisma\r\n      if ((error as any).code === 'P2002') {\r\n        console.error('   -> Doublon détecté sur une contrainte unique (ex: Plaque ou ID).');\r\n      } else if ((error as any).code === 'P2025') {\r\n        console.error('   -> Service ID introuvable.');\r\n      } else {\r\n        console.error(`   -> ${error}`);\r\n      }\r\n      errorCount++;\r\n    }\r\n  }\r\n  console.log('\\n\\n=== RAPPORT D\\'IMPORTATION ===');\r\n  console.log(`✅ Importés avec succès : ${successCount}`);\r\n  console.log(`❌ Échecs : ${errorCount}`);\r\n  console.log('=============================');\r\n}\r\nmain()\r\n  .catch((e) => {\r\n    console.error('Erreur critique du script:', e);\r\n    process.exit(1);\r\n  })\r\n  .finally(async () => {\r\n    await prisma.$disconnect();\r\n  });","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\prisma\\seed.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":41,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":41,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2737,2740],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2737,2740],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2837,2840],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2837,2840],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":86,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3058,3061],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3058,3061],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":88,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3139,3142],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3139,3142],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client'\r\nimport { hashPassword } from '../lib/auth/hash'\r\n\r\nconst prisma = new PrismaClient()\r\n\r\nasync function main() {\r\n  console.log('🌱 Démarrage du seeding...')\r\n\r\n  // Créer l'admin principal\r\n  const adminPassword = await hashPassword('admin123')\r\n\r\n  const adminUser = await prisma.user.upsert({\r\n    where: { email: 'admin@camptrack.com' },\r\n    update: {},\r\n    create: {\r\n      nom: 'Admin',\r\n      prenom: 'CampTrack',\r\n      email: 'admin@camptrack.com',\r\n      password: adminPassword,\r\n      type_user: 'ADMIN',\r\n      nom_utilisateur: 'admin',\r\n      contact: '+225 01 23 45 67 89',\r\n    },\r\n  })\r\n\r\n  console.log('✅ Admin créé:', {\r\n    id: adminUser.id_user,\r\n    email: adminUser.email,\r\n    type: adminUser.type_user\r\n  })\r\n\r\n  // CORRECTION : Le service n'a pas de champ unique \"nom\", on utilise create directement\r\n  try {\r\n    const service = await prisma.service.create({\r\n      data: {\r\n        nom: 'Publicité Tricycle',\r\n        description: 'Service de publicité sur tricycles',\r\n      },\r\n    })\r\n    console.log('✅ Service créé:', service.nom)\r\n  } catch (error) {\r\n    console.log('ℹ️ Service déjà existant ou autre erreur, continuation...')\r\n  }\r\n\r\n  // Créer des règles de notification par défaut\r\n  const rules = [\r\n    {\r\n      type: 'CAMPAIGN_EXPIRING',\r\n      days_before: 7,\r\n      priority: 'HIGH',\r\n      title_template: 'Campagne \"{{nom_campagne}}\" expire dans {{jours}} jours',\r\n      message_template: 'La campagne \"{{nom_campagne}}\" se terminera le {{date_fin}}. Pensez à vérifier les derniers détails avant la clôture.',\r\n      description: 'Notification envoyée 7 jours avant la fin d\\'une campagne'\r\n    },\r\n    {\r\n      type: 'ASSIGNMENT_WEEK_BEFORE',\r\n      days_before: 7,\r\n      priority: 'MEDIUM',\r\n      title_template: 'Affectation de {{prestataire_nom}} se termine bientôt',\r\n      message_template: 'L\\'affectation de {{prestataire_nom}} pour la campagne \"{{campagne_nom}}\" se terminera le {{date_fin}}. Préparez la transition si nécessaire.',\r\n      description: 'Notification envoyée 1 semaine avant la fin d\\'une affectation'\r\n    },\r\n    {\r\n      type: 'ASSIGNMENT_2DAYS_BEFORE',\r\n      days_before: 2,\r\n      priority: 'HIGH',\r\n      title_template: 'Affectation de {{prestataire_nom}} se termine dans 2 jours',\r\n      message_template: 'L\\'affectation de {{prestataire_nom}} pour la campagne \"{{campagne_nom}}\" se terminera le {{date_fin}}. Action requise rapidement.',\r\n      description: 'Notification envoyée 2 jours avant la fin d\\'une affectation'\r\n    }\r\n  ]\r\n\r\n  console.log('🔔 Création des règles de notification...')\r\n  for (const rule of rules) {\r\n    await prisma.notificationRule.upsert({\r\n      where: { type: rule.type as any },\r\n      update: {\r\n        days_before: rule.days_before,\r\n        priority: rule.priority as any,\r\n        title_template: rule.title_template,\r\n        message_template: rule.message_template,\r\n        description: rule.description,\r\n        is_active: true\r\n      },\r\n      create: {\r\n        type: rule.type as any,\r\n        days_before: rule.days_before,\r\n        priority: rule.priority as any,\r\n        title_template: rule.title_template,\r\n        message_template: rule.message_template,\r\n        description: rule.description,\r\n        is_active: true\r\n      }\r\n    })\r\n  }\r\n  console.log('✅ 4 Règles de notification créées/vérifiées')\r\n\r\n  console.log('🎉 Seeding terminé!')\r\n}\r\n\r\nmain()\r\n  .catch((e) => {\r\n    console.error('❌ Erreur de seeding:', e)\r\n    process.exit(1)\r\n  })\r\n  .finally(async () => {\r\n    await prisma.$disconnect()\r\n  })","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\prisma\\seeds\\notificationRules.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1752,1755],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1752,1755],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1874,1877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1874,1877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":47,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2147,2150],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2147,2150],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":49,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2244,2247],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2244,2247],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nasync function seedNotificationRules() {\r\n    console.log('🌱 Création des règles de notification...');\r\n\r\n    const rules = [\r\n        {\r\n            type: 'CAMPAIGN_EXPIRING',\r\n            days_before: 7,\r\n            priority: 'HIGH',\r\n            title_template: 'Campagne \"{{nom_campagne}}\" expire dans {{jours}} jours',\r\n            message_template: 'La campagne \"{{nom_campagne}}\" se terminera le {{date_fin}}. Pensez à vérifier les derniers détails avant la clôture.',\r\n            description: 'Notification envoyée 7 jours avant la fin d\\'une campagne'\r\n        },\r\n        {\r\n            type: 'ASSIGNMENT_WEEK_BEFORE',\r\n            days_before: 7,\r\n            priority: 'MEDIUM',\r\n            title_template: 'Affectation de {{prestataire_nom}} se termine bientôt',\r\n            message_template: 'L\\'affectation de {{prestataire_nom}} pour la campagne \"{{campagne_nom}}\" se terminera le {{date_fin}}. Préparez la transition si nécessaire.',\r\n            description: 'Notification envoyée 1 semaine avant la fin d\\'une affectation'\r\n        },\r\n        {\r\n            type: 'ASSIGNMENT_2DAYS_BEFORE',\r\n            days_before: 2,\r\n            priority: 'HIGH',\r\n            title_template: 'Affectation de {{prestataire_nom}} se termine dans 2 jours',\r\n            message_template: 'L\\'affectation de {{prestataire_nom}} pour la campagne \"{{campagne_nom}}\" se terminera le {{date_fin}}. Action requise rapidement.',\r\n            description: 'Notification envoyée 2 jours avant la fin d\\'une affectation'\r\n        }\r\n    ];\r\n\r\n    for (const rule of rules) {\r\n        await prisma.notificationRule.upsert({\r\n            where: { type: rule.type as any },\r\n            update: {\r\n                days_before: rule.days_before,\r\n                priority: rule.priority as any,\r\n                title_template: rule.title_template,\r\n                message_template: rule.message_template,\r\n                description: rule.description,\r\n                is_active: true\r\n            },\r\n            create: {\r\n                type: rule.type as any,\r\n                days_before: rule.days_before,\r\n                priority: rule.priority as any,\r\n                title_template: rule.title_template,\r\n                message_template: rule.message_template,\r\n                description: rule.description,\r\n                is_active: true\r\n            }\r\n        });\r\n        console.log(`✅ Règle créée/mise à jour: ${rule.type}`);\r\n    }\r\n\r\n    console.log('\\n✅ Toutes les règles de notification ont été créées avec succès!');\r\n}\r\n\r\nseedNotificationRules()\r\n    .catch((error) => {\r\n        console.error('❌ Erreur lors du seed:', error);\r\n        process.exit(1);\r\n    })\r\n    .finally(async () => {\r\n        await prisma.$disconnect();\r\n    });\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\proxy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\scripts\\db-backup.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'stdout' is assigned a value but never used.","line":50,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":50,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { exec } from 'child_process';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport util from 'util';\r\nimport dotenv from 'dotenv';\r\n\r\ndotenv.config();\r\n\r\nconst execAsync = util.promisify(exec);\r\n\r\nasync function backupDatabase() {\r\n    console.log('Starting database backup...');\r\n\r\n    // Use DIRECT_URL if available (for Prisma Accelerate setups)\r\n    // Otherwise fall back to DATABASE_URL\r\n    const databaseUrl = process.env.DIRECT_URL || process.env.DATABASE_URL;\r\n\r\n    if (!databaseUrl) {\r\n        console.error('Error: Neither DIRECT_URL nor DATABASE_URL environment variable is defined.');\r\n        process.exit(1);\r\n    }\r\n\r\n    // Check if using Prisma Accelerate (prisma:// protocol)\r\n    if (databaseUrl.startsWith('prisma://')) {\r\n        console.error('Error: DATABASE_URL uses Prisma Accelerate format.');\r\n        console.error('Please set DIRECT_URL environment variable with your direct PostgreSQL connection string.');\r\n        console.error('Example: DIRECT_URL=\"postgresql://user:password@host:port/database\"');\r\n        process.exit(1);\r\n    }\r\n\r\n    // Ensure backups directory exists\r\n    const backupDir = path.join(process.cwd(), 'backups');\r\n    if (!fs.existsSync(backupDir)) {\r\n        fs.mkdirSync(backupDir, { recursive: true });\r\n    }\r\n\r\n    // Generate filename with timestamp\r\n    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\r\n    const filename = `backup-${timestamp}.sql`;\r\n    const filepath = path.join(backupDir, filename);\r\n\r\n    // Construct pg_dump command\r\n    // Note: We use the connection string directly with pg_dump\r\n    // Try to use the explicit path found on the system\r\n    const pgDumpPath = `\"C:\\\\Program Files\\\\PostgreSQL\\\\18\\\\bin\\\\pg_dump.exe\"`;\r\n    const command = `${pgDumpPath} \"${databaseUrl}\" -f \"${filepath}\"`;\r\n\r\n    try {\r\n        console.log(`Executing: pg_dump to ${filename}...`);\r\n        const { stdout, stderr } = await execAsync(command);\r\n\r\n        if (stderr) {\r\n            // pg_dump writes some info to stderr even on success, but we log it just in case\r\n            console.log('pg_dump output:', stderr);\r\n        }\r\n\r\n        console.log(`Backup completed successfully!`);\r\n        console.log(`File saved to: ${filepath}`);\r\n\r\n    } catch (error) {\r\n        console.error('Backup failed:', error);\r\n        process.exit(1);\r\n    }\r\n}\r\n\r\nbackupDatabase();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\HP\\Desktop\\Dev\\camptrack-reseaupub\\test-json.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]